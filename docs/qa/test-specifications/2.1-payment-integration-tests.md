# Integration Test Specifications: Payment APIs

**Story:** 2.1 - Premium Subscription Workflow  
**Test Type:** Integration Tests  
**Priority:** HIGH (Required before production)  
**Estimated Effort:** 3.5 hours  
**Assigned To:** James (Dev)  
**Reviewer:** Quinn (Test Architect)

---

## Overview

These integration tests validate the payment API endpoints with mocked external dependencies (Xendit, Supabase, SendGrid). They ensure the endpoints correctly handle authentication, validation, business logic, and error scenarios.

**Goal:** Achieve confidence that payment flows work end-to-end without requiring live Xendit sandbox access for every test run.

---

## Test File Locations

```
apps/web/__tests__/api/
├── webhooks/
│   └── xendit.integration.test.ts        # NEW - Webhook processing tests
└── payments/
    └── create-invoice.integration.test.ts # NEW - Invoice creation tests
```

---

## Test Suite 1: Webhook Processing Integration Tests

**File:** `apps/web/__tests__/api/webhooks/xendit.integration.test.ts`  
**Route Under Test:** `POST /api/webhooks/xendit`  
**Estimated Effort:** 2 hours

### Setup & Mocking Strategy

```typescript
// Mock pattern (reference: apps/web/__tests__/lib/email.test.ts)
import { jest } from '@jest/globals';

// Mock dependencies before imports
jest.mock('@/lib/db/services');
jest.mock('@/lib/email');
jest.mock('@/lib/logger');

// Environment setup
beforeEach(() => {
  process.env.XENDIT_WEBHOOK_TOKEN = 'test_webhook_token_123';
  jest.clearAllMocks();
});
```

### Required Mocks

1. **OrderService:**
   - `findByOrderId(orderId)` → returns mock order
   - `update(orderId, data)` → returns updated order

2. **WebhookLogService:**
   - `isProcessed(webhookId)` → returns boolean
   - `create(data)` → returns webhook log
   - `markAsProcessed(webhookId)` → returns void

3. **UserService:**
   - `activatePremiumSubscription(userId, data)` → returns updated user

4. **EmailService:**
   - `sendPremiumConfirmationEmail(data)` → returns void (no throw)

5. **Logger:**
   - Mock all logger methods (webhookReceived, webhookProcessed, etc.)

### Test Cases

#### Test Case 1.1: Valid PAID Webhook with Correct Signature
**Priority:** CRITICAL  
**Acceptance Criteria:**
- ✅ Signature verification passes
- ✅ Order status updated to 'paid'
- ✅ Subscription activated with correct expiration (30 days for monthly)
- ✅ Email service called with correct data
- ✅ Webhook marked as processed
- ✅ Returns 200 OK with "Webhook processed"

**Test Data:**
```typescript
const validPaidWebhook = {
  id: 'xendit_inv_123',
  external_id: 'order_1234567890_abc123',
  status: 'PAID',
  paid_amount: 20000, // ₱200
  paid_at: '2025-10-25T08:00:00Z',
  payment_method: 'GCASH'
};

const mockOrder = {
  id: 'uuid-123',
  orderId: 'order_1234567890_abc123',
  userId: 'user_456',
  amount: 20000,
  planType: 'monthly_premium',
  status: 'pending',
  // ... other fields
};
```

**Expected Behavior:**
- Response: 200 with `{ message: 'Webhook processed' }`
- `orderService.update` called with `{ status: 'paid', paidAmount: 20000, ... }`
- `userService.activatePremiumSubscription` called with expiration = now + 30 days
- `emailService.sendPremiumConfirmationEmail` called once

---

#### Test Case 1.2: Invalid Webhook Signature
**Priority:** CRITICAL (Security)  
**Acceptance Criteria:**
- ✅ Signature verification fails
- ✅ Returns 401 Unauthorized
- ✅ No database operations performed
- ✅ Webhook not logged

**Test Data:**
```typescript
const invalidSignature = 'wrong_signature_hash';
```

**Expected Behavior:**
- Response: 401 with `{ error: 'Unauthorized' }`
- No service methods called

---

#### Test Case 1.3: Duplicate Webhook (Idempotency Check)
**Priority:** HIGH  
**Acceptance Criteria:**
- ✅ Idempotency check detects duplicate
- ✅ Returns 200 OK with "Webhook already processed"
- ✅ No duplicate database updates
- ✅ No duplicate email sent

**Test Setup:**
```typescript
// Mock isProcessed to return true
webhookLogService.isProcessed.mockResolvedValue(true);
```

**Expected Behavior:**
- Response: 200 with `{ message: 'Webhook already processed' }`
- `orderService.update` NOT called
- `emailService.sendPremiumConfirmationEmail` NOT called

---

#### Test Case 1.4: Webhook for Non-Existent Order
**Priority:** MEDIUM  
**Acceptance Criteria:**
- ✅ Order not found in database
- ✅ Returns 404 Not Found
- ✅ Webhook marked as processed (to prevent retries)

**Test Setup:**
```typescript
orderService.findByOrderId.mockResolvedValue(null);
```

**Expected Behavior:**
- Response: 404 with `{ error: 'Order not found' }`
- `webhookLogService.markAsProcessed` called

---

#### Test Case 1.5: EXPIRED Webhook
**Priority:** MEDIUM  
**Acceptance Criteria:**
- ✅ Order status updated to 'expired'
- ✅ No subscription activation
- ✅ No email sent
- ✅ Returns 200 OK

**Test Data:**
```typescript
const expiredWebhook = {
  id: 'xendit_inv_789',
  external_id: 'order_expired',
  status: 'EXPIRED'
};
```

**Expected Behavior:**
- Response: 200 with `{ message: 'Webhook processed' }`
- `orderService.update` called with `{ status: 'expired' }`
- `userService.activatePremiumSubscription` NOT called

---

#### Test Case 1.6: FAILED Webhook with Failure Code
**Priority:** MEDIUM  
**Acceptance Criteria:**
- ✅ Order status updated to 'failed'
- ✅ Failure code captured
- ✅ No subscription activation
- ✅ Returns 200 OK

**Test Data:**
```typescript
const failedWebhook = {
  id: 'xendit_inv_999',
  external_id: 'order_failed',
  status: 'FAILED',
  failure_code: 'CARD_DECLINED'
};
```

**Expected Behavior:**
- Response: 200 with `{ message: 'Webhook processed' }`
- `orderService.update` called with `{ status: 'failed', failureCode: 'CARD_DECLINED' }`

---

#### Test Case 1.7: Database Error During Processing
**Priority:** HIGH (Error Handling)  
**Acceptance Criteria:**
- ✅ Database operation throws error
- ✅ Returns 500 Internal Server Error (triggers Xendit retry)
- ✅ Error logged via logger
- ✅ Webhook NOT marked as processed

**Test Setup:**
```typescript
orderService.update.mockRejectedValue(new Error('Database connection lost'));
```

**Expected Behavior:**
- Response: 500 with `{ error: 'Processing failed' }`
- `logger.webhookError` called
- `webhookLogService.markAsProcessed` NOT called

---

#### Test Case 1.8: Email Service Failure (Non-Blocking)
**Priority:** MEDIUM  
**Acceptance Criteria:**
- ✅ Email service throws error
- ✅ Webhook processing still succeeds (non-blocking)
- ✅ Returns 200 OK
- ✅ Subscription still activated
- ✅ Error logged

**Test Setup:**
```typescript
emailService.sendPremiumConfirmationEmail.mockRejectedValue(
  new Error('SendGrid API error')
);
```

**Expected Behavior:**
- Response: 200 (email failure doesn't block webhook)
- Order still updated to 'paid'
- Subscription still activated
- Error logged for monitoring

---

### Signature Verification Helper

```typescript
// Helper to generate valid webhook signature for tests
import crypto from 'crypto';

function generateValidSignature(payload: object): string {
  const webhookToken = process.env.XENDIT_WEBHOOK_TOKEN!;
  return crypto
    .createHmac('sha256', webhookToken)
    .update(JSON.stringify(payload))
    .digest('hex');
}
```

---

## Test Suite 2: Invoice Creation Integration Tests

**File:** `apps/web/__tests__/api/payments/create-invoice.integration.test.ts`  
**Route Under Test:** `POST /api/payments/create-invoice`  
**Estimated Effort:** 1.5 hours

### Setup & Mocking Strategy

```typescript
// Mock dependencies
jest.mock('@/lib/auth-utils');
jest.mock('@/lib/db/services');
jest.mock('@/lib/xendit');
jest.mock('@/lib/logger');

// Environment setup
beforeEach(() => {
  process.env.XENDIT_SECRET_KEY = 'xnd_test_key';
  process.env.NEXT_PUBLIC_APP_URL = 'http://localhost:3000';
  jest.clearAllMocks();
});
```

### Required Mocks

1. **getCurrentSession():**
   - Returns mock session with user ID and email

2. **OrderService:**
   - `hasActiveSubscription(userId)` → returns boolean
   - `create(data)` → returns mock order

3. **XenditClient:**
   - `createInvoice(orderId, planType, email)` → returns mock invoice

4. **Logger:**
   - Mock all logger methods

### Test Cases

#### Test Case 2.1: Successful Invoice Creation (Monthly Plan)
**Priority:** CRITICAL  
**Acceptance Criteria:**
- ✅ User authenticated
- ✅ No active subscription exists
- ✅ Order created in database with status 'pending'
- ✅ Xendit invoice created
- ✅ Order updated with Xendit invoice details
- ✅ Returns 201 with checkout URL

**Test Data:**
```typescript
const authenticatedSession = {
  user: {
    id: 'user_123',
    email: 'test@example.com'
  }
};

const mockXenditInvoice = {
  id: 'xendit_inv_456',
  invoice_url: 'https://checkout.xendit.co/web/invoice_456',
  expiry_date: '2025-10-26T08:00:00Z'
};
```

**Expected Behavior:**
- Response: 201 with:
  ```json
  {
    "success": true,
    "orderId": "order_...",
    "checkoutUrl": "https://checkout.xendit.co/web/invoice_456",
    "expiresAt": "2025-10-26T08:00:00Z",
    "planType": "monthly_premium",
    "amount": 20000
  }
  ```

---

#### Test Case 2.2: Successful Invoice Creation (Annual Plan)
**Priority:** HIGH  
**Acceptance Criteria:**
- ✅ Annual plan amount correct (192000 centavos = ₱1,920)
- ✅ isRecurring = false for annual plan

**Test Data:**
```typescript
const requestBody = { planType: 'annual_premium' };
```

**Expected Behavior:**
- Order created with `amount: 192000` and `isRecurring: false`
- Response includes `amount: 192000`

---

#### Test Case 2.3: Unauthenticated Request
**Priority:** CRITICAL (Security)  
**Acceptance Criteria:**
- ✅ No session exists
- ✅ Returns 401 Unauthorized
- ✅ No database operations performed

**Test Setup:**
```typescript
getCurrentSession.mockResolvedValue(null);
```

**Expected Behavior:**
- Response: 401 with `{ error: 'Unauthorized' }`
- No service methods called

---

#### Test Case 2.4: Invalid Plan Type
**Priority:** HIGH (Validation)  
**Acceptance Criteria:**
- ✅ Invalid plan type in request
- ✅ Returns 400 Bad Request
- ✅ No order created

**Test Data:**
```typescript
const requestBody = { planType: 'invalid_plan' };
```

**Expected Behavior:**
- Response: 400 with:
  ```json
  {
    "error": "Invalid Plan",
    "message": "planType must be \"monthly_premium\" or \"annual_premium\""
  }
  ```

---

#### Test Case 2.5: User Already Has Active Subscription
**Priority:** HIGH (Business Logic)  
**Acceptance Criteria:**
- ✅ Active subscription detected
- ✅ Returns 409 Conflict
- ✅ No duplicate order created

**Test Setup:**
```typescript
orderService.hasActiveSubscription.mockResolvedValue(true);
```

**Expected Behavior:**
- Response: 409 with:
  ```json
  {
    "error": "Subscription Exists",
    "message": "You already have an active premium subscription"
  }
  ```

---

#### Test Case 2.6: Xendit API Failure
**Priority:** HIGH (Error Handling)  
**Acceptance Criteria:**
- ✅ Order created with status 'pending'
- ✅ Xendit API call fails
- ✅ Order updated to status 'failed'
- ✅ Returns 500 with error message

**Test Setup:**
```typescript
xenditClient.createInvoice.mockRejectedValue(
  new Error('Xendit API timeout')
);
```

**Expected Behavior:**
- Response: 500 with:
  ```json
  {
    "error": "Payment Gateway Error",
    "message": "Failed to create payment invoice. Please try again."
  }
  ```
- `orderService.update` called with `{ status: 'failed' }`
- `logger.paymentFailed` called

---

#### Test Case 2.7: Malformed JSON Request Body
**Priority:** MEDIUM (Validation)  
**Acceptance Criteria:**
- ✅ Invalid JSON in request
- ✅ Returns 400 Bad Request

**Expected Behavior:**
- Response: 400 with `{ error: 'Invalid Request' }`

---

#### Test Case 2.8: Missing Plan Type in Request
**Priority:** MEDIUM (Validation)  
**Acceptance Criteria:**
- ✅ Request body empty or missing planType
- ✅ Returns 400 Bad Request

**Test Data:**
```typescript
const requestBody = {}; // or { planType: null }
```

**Expected Behavior:**
- Response: 400 with validation error

---

## Testing Utilities

### Mock Request Helper

```typescript
// Helper to create mock NextRequest for testing
function createMockRequest(options: {
  body?: object;
  headers?: Record<string, string>;
  method?: string;
}): NextRequest {
  const url = 'http://localhost:3000/api/test';
  const init: RequestInit = {
    method: options.method || 'POST',
    headers: {
      'content-type': 'application/json',
      ...options.headers,
    },
  };

  if (options.body) {
    init.body = JSON.stringify(options.body);
  }

  return new NextRequest(url, init);
}
```

---

## Acceptance Criteria for Test Implementation

**Tests MUST:**
1. ✅ Follow existing test patterns from `apps/web/__tests__/lib/email.test.ts`
2. ✅ Use dynamic imports in `beforeEach()` to handle environment variables
3. ✅ Mock all external dependencies (Supabase, Xendit, SendGrid)
4. ✅ Include clear test descriptions using `describe()` and `it()` blocks
5. ✅ Test both success and failure paths
6. ✅ Verify correct service method calls using `expect().toHaveBeenCalledWith()`
7. ✅ Clean up mocks and environment in `afterEach()`
8. ✅ Pass when run with `npm test`

**Coverage Requirements:**
- Webhook processing: 8 test cases (all critical paths)
- Invoice creation: 8 test cases (all validation and error scenarios)
- **Total:** 16 integration tests

---

## Notes for James

### SendGrid Not Required for Tests
**Good news:** Since we're mocking `EmailService`, you don't need SendGrid credentials for these tests. The mock will simulate email sending without actual API calls.

```typescript
// EmailService will be mocked - no SendGrid API key needed
jest.mock('@/lib/email', () => ({
  getEmailService: jest.fn(() => ({
    sendPremiumConfirmationEmail: jest.fn().mockResolvedValue(undefined)
  }))
}));
```

### Reference Existing Tests
- **Pattern to follow:** `apps/web/__tests__/lib/email.test.ts` (lines 24-46 for environment setup)
- **Mocking pattern:** `apps/web/__tests__/lib/xendit.test.ts` (for axios mocking)
- **Webhook verification tests:** `apps/web/__tests__/lib/webhookVerification.test.ts` (40 tests already passing!)

### Test Execution
```bash
# Run only integration tests
npm test xendit.integration
npm test create-invoice.integration

# Run all tests
npm test
```

---

## Definition of Done

✅ All 16 test cases implemented  
✅ All tests passing locally  
✅ Code follows existing test patterns  
✅ Test coverage report shows integration test coverage  
✅ PR submitted for QA review  
✅ Quinn (Test Architect) approves implementation

**Expected Timeline:** 3.5 hours of focused development time

---

## Questions or Blockers?

If you encounter issues:
1. Check existing test files for patterns
2. Verify mock setup matches actual service interfaces
3. Ask Quinn for clarification on test expectations

**Priority:** HIGH - Required for production deployment approval
