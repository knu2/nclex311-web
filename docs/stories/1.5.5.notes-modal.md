# Story 1.5.5: Notes Modal

## Status
**Done**

## Story
**As a** logged-in user,  
**I want** to create and save personal notes for any concept,  
**so that** I can capture my thoughts and insights while studying.

## Acceptance Criteria
1. A "Notes" button is present in the concept viewer header/toolbar.
2. Clicking "Notes" opens a full-screen modal overlay.
3. The modal displays:
   - Current concept title
   - Text area for note content (max 2000 characters)
   - Character counter (e.g., "1523/2000")
   - Tips section with study note suggestions
4. Users can:
   - Create a new note (if none exists)
   - Edit an existing note
   - Delete a note
5. Changes are auto-saved on blur or manual "Save" button click.
6. A success/error message confirms save status.
7. Notes are private to the user (not shared with others).
8. Modal is accessible (keyboard navigation, focus management, ESC to close).
9. Modal uses MUI components (Dialog, TextField, Button).

## Tasks / Subtasks

- [x] Task 1: Create NotesModal Component Structure (AC: 2, 9)
  - [x] Create `src/components/Notes/NotesModal.tsx` component file
  - [x] Set up MUI Dialog component for full-screen modal
  - [x] Add proper TypeScript interfaces for component props
  - [x] Configure modal open/close state management
  
- [x] Task 2: Build Modal Header (AC: 3)
  - [x] Display concept title in modal header
  - [x] Add close button (X icon) in top-right corner
  - [x] Style header with MUI AppBar or DialogTitle
  
- [x] Task 3: Create Note Editor (AC: 3, 4)
  - [x] Add MUI TextField component for note content (multiline)
  - [x] Set max length to 2000 characters
  - [x] Add character counter display (e.g., "1523/2000")
  - [x] Style text area for optimal note-taking experience
  
- [x] Task 4: Add Tips Section (AC: 3)
  - [x] Create tips sidebar or section with study note suggestions
  - [x] Display helpful tips (e.g., "Summarize key points", "Add mnemonics")
  - [x] Style tips section with MUI Card or Box
  
- [x] Task 5: Implement Auto-Save (AC: 5)
  - [x] Add onBlur event handler to text field
  - [x] Implement debounced auto-save (save after 2-3 seconds of no typing)
  - [x] Show "Saving..." indicator during save
  - [x] Show "Saved" confirmation after successful save
  
- [x] Task 6: Add Manual Save Button (AC: 5, 6)
  - [x] Create "Save" button in modal footer
  - [x] Trigger save on button click
  - [x] Show success message after save
  - [x] Show error message if save fails
  
- [x] Task 7: Implement Delete Functionality (AC: 4)
  - [x] Add "Delete Note" button with confirmation dialog
  - [x] Show confirmation dialog before deleting
  - [x] Call delete API endpoint on confirmation
  - [x] Close modal after successful deletion
  
- [x] Task 8: Integrate with API (AC: 4, 7)
  - [x] Fetch existing note on modal open (GET /api/concepts/{id}/notes)
  - [x] Create/update note (POST /api/concepts/{id}/notes)
  - [x] Delete note (DELETE /api/concepts/{id}/notes)
  - [x] Handle loading and error states
  
- [x] Task 9: Implement Accessibility Features (AC: 8)
  - [x] Add ARIA labels for modal and form elements
  - [x] Implement focus trap (focus stays within modal)
  - [x] Support ESC key to close modal
  - [x] Restore focus to trigger button on close
  - [x] Test with screen readers
  
- [x] Task 10: Add Unit Tests
  - [x] Test modal opens and closes correctly
  - [x] Test note content displays in text field
  - [x] Test character counter updates on typing
  - [x] Test auto-save functionality
  - [x] Test manual save button
  - [x] Test delete functionality with confirmation
  - [x] Test accessibility features

## Dev Notes

### Previous Story Insights
- Story 1.5.3 (Concept Viewer) completed: Provides trigger button location [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: User authentication available [Source: Epic 1.5]

### Component Location
**File Path:** `apps/web/src/components/Notes/NotesModal.tsx` [Source: Epic 1.5]

**Project Structure:**
```plaintext
apps/web/src/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ components/             # React components
â”‚   â””â”€â”€ Notes/             # Notes-related components
â”‚       â””â”€â”€ NotesModal.tsx   # This story's main component
â””â”€â”€ lib/                    # Utility libraries
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled
- **State Management:** React Built-in (useState/useContext)

### MUI Components to Use
- **Dialog:** Full-screen modal container
- **DialogTitle:** Modal header
- **DialogContent:** Modal body
- **DialogActions:** Modal footer
- **TextField:** Note content input (multiline)
- **Button:** Save, Delete, Close buttons
- **Typography:** Text styling
- **IconButton:** Close button (X)
- **Card:** Tips section container
- **CircularProgress:** Loading indicator

### API Specifications
[Source: Epic 1.5]

**New API Endpoints:**

1. **Get User's Note for Concept:**
```
GET /api/concepts/{id}/notes
Authorization: Bearer {token}

Response:
{
  id: string;
  user_id: string;
  concept_id: string;
  content: string;
  created_at: timestamp;
  updated_at: timestamp;
}

// If no note exists, returns 404
```

2. **Create/Update Note:**
```
POST /api/concepts/{id}/notes
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  content: string;
}

Response:
{
  id: string;
  user_id: string;
  concept_id: string;
  content: string;
  created_at: timestamp;
  updated_at: timestamp;
}
```

3. **Delete Note:**
```
DELETE /api/concepts/{id}/notes
Authorization: Bearer {token}

Response:
{
  success: boolean;
}
```

### Data Model
[Source: docs/architecture/data-models.md]

**Note Table:**
```sql
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  concept_id UUID NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,
  content TEXT NOT NULL CHECK (char_length(content) <= 2000),
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now(),
  UNIQUE (user_id, concept_id)
);

CREATE INDEX idx_notes_user_concept ON notes(user_id, concept_id);
```

### Auto-Save Implementation
```typescript
import { useDebounce } from '@/hooks/useDebounce';

const NotesModal = ({ conceptId, conceptTitle, isOpen, onClose }) => {
  const [content, setContent] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const debouncedContent = useDebounce(content, 2000); // 2 second delay
  
  useEffect(() => {
    if (debouncedContent !== initialContent) {
      saveNote(debouncedContent);
    }
  }, [debouncedContent]);
  
  const saveNote = async (noteContent: string) => {
    setIsSaving(true);
    try {
      await fetch(`/api/concepts/${conceptId}/notes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: noteContent }),
      });
      setIsSaving(false);
    } catch (error) {
      // Handle error
      setIsSaving(false);
    }
  };
};
```

### Character Counter Implementation
```typescript
const MAX_CHARS = 2000;
const charCount = content.length;
const isOverLimit = charCount > MAX_CHARS;

<Typography 
  variant="caption" 
  color={isOverLimit ? 'error' : 'textSecondary'}
>
  {charCount}/{MAX_CHARS}
</Typography>
```

### Study Tips Content
```typescript
const studyTips = [
  "Summarize key concepts in your own words",
  "Create mnemonics to remember important lists",
  "Note any questions you have for review",
  "Link concepts to real-world examples",
  "Highlight areas you find challenging",
];
```

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**Modal Design:** [Source: front-end-spec.md, Modal: Personal Notes]

**Modal Header:**
- Background: Blue (#2c5aa0)
- Title: "ðŸ“ Personal Notes" (white text, 1.2rem, 600 weight)
- Close button (Ã—): 44px tap target, top-right corner

**Tips Section:**
- Background: Light blue (#e8f0fe)
- Heading: "ðŸ’¡ Note-Taking Tips" (blue #2c5aa0)
- Padding: 1rem (16px)
- Border radius: 6px

**Text Area:**
- Min height: 150px
- Max length: 2000 characters
- Border: 2px solid #e1e7f0
- Focus border: Blue (#2c5aa0)
- Border radius: 6px
- Padding: 12px (0.75rem)
- Font: System font stack, 16px

**Character Counter:**
- Position: Below textarea
- Color: Text secondary (#6c757d)
- Over limit color: Error red (#e17055)
- Font size: 14px (0.9rem)

**Footer Buttons:**
- "Save Notes" button: Primary blue (#2c5aa0), white text
- "Cancel" button: Secondary (outlined)
- Min height: 44px (touch-friendly)
- Border radius: 6px
- Spacing: 16px gap between buttons

**Animation:** [Source: front-end-spec.md, Animation]
- Modal fade in: 300ms ease-out
- Backdrop: 50% opacity black overlay
- Close animation: 250ms ease-in

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md`
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **Focus Trap:** Focus stays within modal when open
- **ESC Key:** Closes modal
- **Focus Management:** Focus returns to trigger button on close
- **ARIA Labels:** Modal has descriptive aria-label

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.3 (Concept Viewer):** Trigger button in concept viewer toolbar
2. **Story 1.5.9 (Bookmarks View):** Notes preview displayed in bookmarks
3. **Story 1.6 Backend:** Uses user authentication for private notes

### TypeScript Interfaces
```typescript
// Component Props
interface NotesModalProps {
  conceptId: string;
  conceptTitle: string;
  isOpen: boolean;
  onClose: () => void;
}

// Note Data
interface Note {
  id: string;
  user_id: string;
  concept_id: string;
  content: string;
  created_at: string;
  updated_at: string;
}

// Modal State
interface NotesModalState {
  note: Note | null;
  loading: boolean;
  saving: boolean;
  error: string | null;
}
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Notes/NotesModal.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - Modal opens when isOpen is true
   - Concept title displays in header
   - Text field renders
   - Character counter displays
   - Tips section displays

2. **Interaction Tests:**
   - Typing updates character counter
   - Close button closes modal
   - ESC key closes modal
   - Save button triggers save

3. **Auto-Save Tests:**
   - Content auto-saves after typing stops
   - "Saving..." indicator shows during save
   - "Saved" message shows after successful save

4. **Delete Tests:**
   - Delete button shows confirmation dialog
   - Confirming delete calls API
   - Modal closes after successful deletion

5. **Accessibility Tests:**
   - Focus trap works (Tab cycles within modal)
   - ESC key closes modal
   - Focus returns to trigger button on close
   - ARIA labels present

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { NotesModal } from '@/components/Notes/NotesModal';

describe('NotesModal', () => {
  it('opens and displays concept title', () => {
    render(
      <NotesModal 
        conceptId="concept-1" 
        conceptTitle="Cardiac Physiology" 
        isOpen={true} 
        onClose={() => {}} 
      />
    );
    
    expect(screen.getByText('Cardiac Physiology')).toBeInTheDocument();
    expect(screen.getByRole('textbox')).toBeInTheDocument();
  });
  
  it('updates character counter on typing', () => {
    render(<NotesModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const textField = screen.getByRole('textbox');
    fireEvent.change(textField, { target: { value: 'Test note content' } });
    
    expect(screen.getByText('17/2000')).toBeInTheDocument();
  });
  
  it('auto-saves after typing stops', async () => {
    const mockFetch = jest.spyOn(global, 'fetch').mockResolvedValue({
      ok: true,
      json: async () => ({ success: true }),
    });
    
    render(<NotesModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const textField = screen.getByRole('textbox');
    fireEvent.change(textField, { target: { value: 'Auto-save test' } });
    
    await waitFor(() => {
      expect(mockFetch).toHaveBeenCalledWith(
        '/api/concepts/concept-1/notes',
        expect.objectContaining({
          method: 'POST',
          body: JSON.stringify({ content: 'Auto-save test' }),
        })
      );
    }, { timeout: 3000 });
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 4.5 Sonnet

### Debug Log References
No blocking issues encountered during development.

### Completion Notes List
- Successfully implemented full notes modal with all acceptance criteria met
- Created complete backend infrastructure: database schema, services, and API routes
- Implemented auto-save with 2-second debounce using custom useDebounce hook
- Added comprehensive test coverage for all major functionality
- Integrated Notes button into ConceptViewer component header
- All features working as specified with proper error handling and loading states
- Database migration created (005_add_notes_table.sql) - **requires manual application via Supabase Dashboard**

### File List
**New Files Created:**
- `apps/web/src/lib/db/schema/notes.ts` - Notes table schema with Drizzle ORM
- `apps/web/src/lib/db/services/NotesService.ts` - Service class for notes CRUD operations
- `apps/web/src/app/api/concepts/[id]/notes/route.ts` - API routes (GET, POST, DELETE)
- `apps/web/src/hooks/useDebounce.ts` - Custom debounce hook for auto-save
- `apps/web/src/components/Notes/NotesModal.tsx` - Main notes modal component (577 lines)
- `apps/web/__tests__/components/Notes/NotesModal.test.tsx` - Comprehensive component tests (544 lines)
- `apps/web/migrations/005_add_notes_table.sql` - Database migration for notes table
- `apps/web/migrations/005_add_notes_table_README.md` - Migration documentation and instructions

**Modified Files:**
- `apps/web/src/lib/db/schema/index.ts` - Added notes schema export
- `apps/web/src/lib/db/services/index.ts` - Added NotesService export  
- `apps/web/src/components/Concept/ConceptViewer.tsx` - Integrated Notes button and modal

## QA Results
*This section will be populated by QA Agent after implementation*
