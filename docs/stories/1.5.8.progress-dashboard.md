# Story 1.5.8: Progress Dashboard

## Status
**Draft**

## Story
**As a** logged-in user,  
**I want** to mark concepts as complete and view my detailed progress across all chapters,  
**so that** I can track my study achievements and stay motivated.

**Note:** This story incorporates completion tracking backend functionality (originally Story 2.4 from Epic 2). It includes both the "Mark as Complete" button on concept pages and the Progress Dashboard view.

## Acceptance Criteria
1. A dedicated route `/dashboard/progress` displays chapter-by-chapter progress.
2. The dashboard shows:
   - Overall progress summary (total concepts completed)
   - List of all 8 chapters with progress bars
   - Completed concepts list per chapter (expandable)
3. Each chapter section displays:
   - Chapter title and number
   - Animated progress bar (e.g., "12/42 - 28%")
   - List of completed concept titles (with links)
4. Users can:
   - Expand/collapse chapter sections
   - Click concept titles to navigate to that concept
5. The dashboard is accessible via main navigation or user menu.
6. Progress updates in real-time as users complete concepts.
7. Uses MUI components (Accordion, LinearProgress, List, Typography).
8. Meets accessibility standards.

### Backend Functionality (Incorporated from Story 2.4)
9. **Mark as Complete Button:**
   - A "Mark as Complete" button is present on each concept page
   - Button toggles between "Mark as Complete" and "Marked Complete" states
   - Clicking marks/unmarks the concept as complete
   - Visual indicator shows completed status (checkmark icon)
   - Button is accessible to all logged-in users (free and premium)
   
10. **Completion Tracking API:**
   - API endpoint to mark concept complete: `POST /api/concepts/{id}/complete`
   - API endpoint to unmark concept: `DELETE /api/concepts/{id}/complete`
   - API endpoint to fetch user progress: `GET /api/users/{id}/progress`
   - Progress data persists across sessions
   
11. **Database Schema:**
   - Table to store user completion records
   - Tracks concept_id, user_id, completed_at timestamp
   - Supports querying completion status and progress

## Tasks / Subtasks

### Backend Implementation Tasks (Incorporated from Story 2.4)

- [ ] Task 0.1: Create Database Schema for Completion Tracking
  - [ ] Create `completed_concepts` or `user_progress` table
  - [ ] Fields: id, user_id, concept_id, completed_at (timestamp)
  - [ ] Add indexes for user_id and concept_id lookups
  - [ ] Create database migration
  - [ ] Update schema exports

- [ ] Task 0.2: Create Completion Tracking API Endpoints
  - [ ] Create `POST /api/concepts/{id}/complete` endpoint
    - [ ] Validate user authentication
    - [ ] Insert completion record
    - [ ] Return success response
  - [ ] Create `DELETE /api/concepts/{id}/complete` endpoint
    - [ ] Validate user authentication
    - [ ] Delete completion record
    - [ ] Return success response
  - [ ] Handle duplicate completion attempts gracefully

- [ ] Task 0.3: Create Progress API Endpoint
  - [ ] Create `GET /api/users/{id}/progress` endpoint
  - [ ] Fetch all user completion records
  - [ ] Join with chapters and concepts data
  - [ ] Calculate completion percentages
  - [ ] Format response matching TypeScript interface (lines 126-153)
  - [ ] Handle empty progress (no completed concepts)

- [ ] Task 0.4: Add "Mark as Complete" Button to Concept Viewer
  - [ ] Add button to ConceptViewer component header/footer
  - [ ] Fetch completion status on page load
  - [ ] Toggle button state based on completion status
  - [ ] Handle button click (call POST or DELETE endpoint)
  - [ ] Show loading state during API call
  - [ ] Update button state after successful API call
  - [ ] Show success/error message
  - [ ] Add checkmark icon for completed state
  - [ ] Style button with MUI components

- [ ] Task 0.5: Update Sidebar to Show Completion Indicators
  - [ ] Fetch user completion data in ConceptList component
  - [ ] Display checkmark icon for completed concepts
  - [ ] Update completion count in chapter header
  - [ ] Refresh sidebar when concept is marked complete

- [ ] Task 1: Create Progress Dashboard Page (AC: 1, 5)
  - [ ] Create `src/app/dashboard/progress/page.tsx` page file
  - [ ] Set up page layout with MainLayout wrapper
  - [ ] Add page title and description
  - [ ] Configure routing
  - [ ] Add navigation link in user menu/header
  
- [ ] Task 2: Create ProgressDashboard Component (AC: 2, 7)
  - [ ] Create `src/components/Dashboard/ProgressDashboard.tsx` component
  - [ ] Add proper TypeScript interfaces
  - [ ] Set up component structure
  
- [ ] Task 3: Build Overall Progress Summary (AC: 2)
  - [ ] Display total concepts completed across all chapters
  - [ ] Calculate overall completion percentage
  - [ ] Add visual summary card with MUI Card
  - [ ] Display motivational message or milestone
  
- [ ] Task 4: Create Chapter Progress Sections (AC: 2, 3, 7)
  - [ ] Use MUI Accordion component for each chapter
  - [ ] Display chapter title and number in accordion header
  - [ ] Add animated progress bar (MUI LinearProgress)
  - [ ] Show completion text (e.g., "12/42 - 28%")
  
- [ ] Task 5: Build Completed Concepts List (AC: 3, 4)
  - [ ] Display list of completed concept titles in accordion body
  - [ ] Use MUI List and ListItem components
  - [ ] Make concept titles clickable links
  - [ ] Add checkmark icons for completed concepts
  
- [ ] Task 6: Implement Expand/Collapse Functionality (AC: 4)
  - [ ] Use MUI Accordion expand/collapse behavior
  - [ ] Allow multiple chapters to be expanded simultaneously
  - [ ] Persist expand/collapse state in localStorage (optional)
  
- [ ] Task 7: Add Navigation to Concepts (AC: 4)
  - [ ] Make concept titles clickable links
  - [ ] Navigate to `/concepts/{slug}` on click
  - [ ] Use Next.js Link or router for navigation
  
- [ ] Task 8: Fetch Progress Data from API (AC: 2, 6)
  - [ ] Call `GET /api/users/{id}/progress` endpoint
  - [ ] Handle loading state (skeleton components)
  - [ ] Handle error state
  - [ ] Map API data to component props
  - [ ] Implement real-time progress updates (polling or WebSocket optional)
  
- [ ] Task 9: Implement Accessibility Features (AC: 8)
  - [ ] Add ARIA labels for accordions and links
  - [ ] Ensure keyboard navigation works
  - [ ] Add focus indicators
  - [ ] Test with screen readers
  - [ ] Ensure color contrast meets WCAG 2.1 AA
  
- [ ] Task 10: Add Unit Tests
  - [ ] Test dashboard renders with progress data
  - [ ] Test overall summary displays correctly
  - [ ] Test chapter accordions expand/collapse
  - [ ] Test completed concepts list displays
  - [ ] Test navigation to concepts on click
  - [ ] Test progress bar calculations
  - [ ] Test accessibility features

## Dev Notes

### Previous Story Insights
- Story 1.5.2 (Main Layout) completed: Provides layout wrapper [Source: Epic 1.5]
- Story 1.5.3 (Concept Viewer) completed: Component available for adding completion button [Source: Epic 1.5]
- Story 1.5.1 (Sidebar Navigation) completed: Component available for completion indicators [Source: Epic 1.5]

### Backend Scope (Incorporated from Epic 2, Story 2.4)
This story includes full backend implementation for completion tracking:
- Database table for storing completion records
- API endpoints for marking complete/incomplete
- Progress API endpoint for dashboard data
- "Mark as Complete" button on concept pages
- Completion indicators in sidebar navigation

### Component Location
**Files:**
- Page: `apps/web/src/app/dashboard/progress/page.tsx`
- Component: `apps/web/src/components/Dashboard/ProgressDashboard.tsx`

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled

### MUI Components to Use
- **Accordion/AccordionSummary/AccordionDetails:** Expandable chapter sections
- **LinearProgress:** Progress bars
- **Card:** Overall summary card
- **List/ListItem/ListItemText:** Completed concepts list
- **Typography:** Text styling
- **CheckCircleIcon:** Completed concept indicator
- **ExpandMoreIcon:** Accordion expand icon
- **Skeleton:** Loading state

### API Specifications
[Source: Epic 1.5, Story 2.4]

**New Endpoint:** `GET /api/users/{id}/progress`

**Response Format:**
```typescript
{
  user_id: string;
  overall_progress: {
    total_concepts: number;
    completed_concepts: number;
    completion_percentage: number;
  };
  chapters: [
    {
      chapter_id: string;
      chapter_number: number;
      chapter_title: string;
      concept_count: number;
      completed_concept_count: number;
      completion_percentage: number;
      completed_concepts: [
        {
          concept_id: string;
          concept_title: string;
          concept_slug: string;
          completed_at: timestamp;
        }
      ];
    }
  ];
}
```

### Progress Bar Animation
```typescript
// Animated progress bar on mount
<LinearProgress 
  variant="determinate" 
  value={completionPercentage}
  sx={{
    height: 10,
    borderRadius: 5,
    transition: 'all 0.8s ease-in-out',
  }}
/>
```

### Overall Summary Card
```typescript
<Card elevation={3} sx={{ p: 3, mb: 4 }}>
  <Typography variant="h5" gutterBottom>
    Your Overall Progress
  </Typography>
  <Typography variant="h3" color="primary">
    {completedConcepts}/{totalConcepts}
  </Typography>
  <LinearProgress 
    variant="determinate" 
    value={completionPercentage}
    sx={{ mt: 2, height: 12, borderRadius: 6 }}
  />
  <Typography variant="body2" color="textSecondary" sx={{ mt: 1 }}>
    {completionPercentage}% Complete
  </Typography>
  {milestoneMessage && (
    <Alert severity="success" sx={{ mt: 2 }}>
      {milestoneMessage}
    </Alert>
  )}
</Card>
```

### Chapter Accordion Structure
```typescript
<Accordion>
  <AccordionSummary expandIcon={<ExpandMoreIcon />}>
    <Box sx={{ width: '100%' }}>
      <Typography variant="h6">
        Chapter {chapter.chapter_number}: {chapter.chapter_title}
      </Typography>
      <Box sx={{ display: 'flex', alignItems: 'center', mt: 1 }}>
        <LinearProgress 
          variant="determinate" 
          value={chapter.completion_percentage}
          sx={{ flexGrow: 1, mr: 2 }}
        />
        <Typography variant="body2">
          {chapter.completed_concept_count}/{chapter.concept_count} - {chapter.completion_percentage}%
        </Typography>
      </Box>
    </Box>
  </AccordionSummary>
  <AccordionDetails>
    <List>
      {chapter.completed_concepts.map((concept) => (
        <ListItem 
          button 
          component={Link} 
          href={`/concepts/${concept.concept_slug}`}
          key={concept.concept_id}
        >
          <ListItemIcon>
            <CheckCircleIcon color="success" />
          </ListItemIcon>
          <ListItemText primary={concept.concept_title} />
        </ListItem>
      ))}
    </List>
  </AccordionDetails>
</Accordion>
```

### Milestone Messages
```typescript
const getMilestoneMessage = (percentage: number): string | null => {
  if (percentage >= 100) return "🎉 Congratulations! You've completed all concepts!";
  if (percentage >= 75) return "🌟 Amazing! You're almost there!";
  if (percentage >= 50) return "💪 Great work! You're halfway through!";
  if (percentage >= 25) return "🚀 Keep going! You're making great progress!";
  return null;
};
```

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**View Design:** [Source: front-end-spec.md, View: Progress Dashboard]

**Page Header:**
- Title: "📊 Your Learning Progress" (H1, 28px, 600 weight, centered)
- Subtitle: "Track your mastery of NCLEX 311 concepts" (text secondary #6c757d)
- Back button: "← Back to Current Chapter" (blue #2c5aa0)

**Overall Summary Card:**
- Background: White with subtle shadow
- Border: 2px solid #e1e7f0
- Border radius: 8px
- Padding: 2rem (32px)
- Overall completion: Large numbers (48px, bold) in primary blue (#2c5aa0)

**Stats Overview Grid:**
- Grid: 4 columns desktop, 2x2 mobile
- Background: Light gray (#f8f9fc)
- Border radius: 6px
- Padding: 1.5rem (24px)
- Icons: 32px, primary blue (#2c5aa0)
- Numbers: 24px, 600 weight

**Chapter Progress Accordions:**
- Border: 2px solid #e1e7f0
- Border radius: 8px
- Margin bottom: 16px
- Expand icon: Blue (#2c5aa0)
- Transition: 250ms ease-in-out

**Accordion Header:**
- Background: White
- Hover: Light gray (#f8f9fc)
- Padding: 1rem (16px)
- Chapter title: 18px (1.1rem), 600 weight

**Progress Bars:**
- Height: 10px
- Border radius: 5px
- Background: Light gray (#e1e7f0)
- Fill: Green gradient (#00b894)
- Animation: Animate width on expand (800ms ease-in-out)

**Completed Concepts List:**
- Checkmark icon: Green (#00b894), 18px
- Concept title: 16px, clickable link (blue #2c5aa0)
- Hover: Underline
- Padding: 8px per item

**Milestone Alerts:**
- Background: Success green (#00b894) with 10% opacity
- Border: 2px solid green (#00b894)
- Border radius: 6px
- Padding: 1rem
- Icon: 24px emoji

**Typography:**
- Chapter title: 18px (1.1rem), 600 weight
- Progress text: 14px, text secondary (#6c757d)
- Concept names: 16px, primary blue when link

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md` (View: Progress Dashboard)
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** Accordions and links labeled
- **Keyboard Navigation:** Full keyboard support
- **Focus Indicators:** Visible focus outlines
- **Screen Reader:** Announce progress, chapter names, concept completion

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.2 (Main Layout):** Uses MainLayout, accessible via user menu
2. **Story 1.5.3 (Concept Viewer):** Adds "Mark as Complete" button to concept page; links to concepts from completed list
3. **Story 1.5.1 (Sidebar Navigation):** Shows completion indicators (checkmarks) for completed concepts
4. **Database:** Creates new table for completion tracking
5. **API:** Creates new endpoints for completion and progress

### TypeScript Interfaces
```typescript
// Progress Data
interface OverallProgress {
  total_concepts: number;
  completed_concepts: number;
  completion_percentage: number;
}

interface CompletedConcept {
  concept_id: string;
  concept_title: string;
  concept_slug: string;
  completed_at: string;
}

interface ChapterProgress {
  chapter_id: string;
  chapter_number: number;
  chapter_title: string;
  concept_count: number;
  completed_concept_count: number;
  completion_percentage: number;
  completed_concepts: CompletedConcept[];
}

interface UserProgress {
  user_id: string;
  overall_progress: OverallProgress;
  chapters: ChapterProgress[];
}

// Component Props
interface ProgressDashboardProps {
  progress: UserProgress;
}
```

### Database Schema
[Source: Story 2.4 requirements, incorporated into Epic 1.5]

**Table: `completed_concepts`**

```typescript
export const completedConcepts = pgTable('completed_concepts', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  conceptId: uuid('concept_id').notNull().references(() => concepts.id, { onDelete: 'cascade' }),
  completedAt: timestamp('completed_at').notNull().defaultNow(),
});

// Indexes
// UNIQUE constraint on (user_id, concept_id) to prevent duplicates
// Index on user_id for fast user progress queries
```

**Relations:**
- User has many CompletedConcepts
- Concept has many CompletedConcepts (through users)

### API Endpoint Specifications - Completion Tracking

#### Mark Concept as Complete
**Endpoint:** `POST /api/concepts/{id}/complete`

**Request:**
```typescript
// No body required, user from session
```

**Response:**
```typescript
{
  success: boolean;
  completed_at: string; // ISO 8601 timestamp
}
```

**Errors:**
- 401: User not authenticated
- 404: Concept not found
- 409: Concept already marked complete (handled gracefully, return existing)

---

#### Unmark Concept as Complete
**Endpoint:** `DELETE /api/concepts/{id}/complete`

**Request:**
```typescript
// No body required, user from session
```

**Response:**
```typescript
{
  success: boolean;
}
```

**Errors:**
- 401: User not authenticated
- 404: Concept not found or not marked complete

---

#### Get User Progress
**Endpoint:** `GET /api/users/{id}/progress`

**Response format already documented in TypeScript Interfaces section above**

### Testing

**Test File Location:** `apps/web/__tests__/app/dashboard/progress/page.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - Dashboard renders with progress data
   - Overall summary card displays
   - All 8 chapter accordions render
   - Progress bars display with correct percentages

2. **Interaction Tests:**
   - Clicking accordion expands/collapses section
   - Multiple accordions can be open simultaneously
   - Clicking concept title navigates to concept

3. **Progress Display Tests:**
   - Overall progress calculates correctly
   - Chapter progress bars show correct percentages
   - Completed concepts list displays in each chapter
   - Milestone messages display at appropriate thresholds

4. **Accessibility Tests:**
   - ARIA labels present
   - Keyboard navigation works
   - Focus indicators visible
   - Screen reader announcements work

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { ProgressDashboard } from '@/components/Dashboard/ProgressDashboard';

describe('ProgressDashboard', () => {
  const mockProgress = {
    user_id: 'user-1',
    overall_progress: {
      total_concepts: 323,
      completed_concepts: 100,
      completion_percentage: 31,
    },
    chapters: [
      {
        chapter_number: 1,
        chapter_title: 'Foundations of Nursing Practice',
        concept_count: 42,
        completed_concept_count: 20,
        completion_percentage: 48,
        completed_concepts: [
          {
            concept_title: 'Introduction to Nursing',
            concept_slug: 'intro-to-nursing',
            completed_at: '2025-10-01T10:00:00Z',
          },
        ],
      },
    ],
  };
  
  it('displays overall progress summary', () => {
    render(<ProgressDashboard progress={mockProgress} />);
    
    expect(screen.getByText('100/323')).toBeInTheDocument();
    expect(screen.getByText('31% Complete')).toBeInTheDocument();
  });
  
  it('displays all chapter accordions', () => {
    render(<ProgressDashboard progress={mockProgress} />);
    
    const accordions = screen.getAllByRole('button', { name: /Chapter/i });
    expect(accordions).toHaveLength(8);
  });
  
  it('expands accordion to show completed concepts', () => {
    render(<ProgressDashboard progress={mockProgress} />);
    
    const accordion = screen.getByText(/Foundations of Nursing Practice/i);
    fireEvent.click(accordion);
    
    expect(screen.getByText('Introduction to Nursing')).toBeInTheDocument();
  });
  
  it('navigates to concept on click', () => {
    const mockRouter = { push: jest.fn() };
    render(<ProgressDashboard progress={mockProgress} />);
    
    const accordion = screen.getByText(/Foundations of Nursing Practice/i);
    fireEvent.click(accordion);
    
    const conceptLink = screen.getByText('Introduction to Nursing');
    fireEvent.click(conceptLink);
    
    expect(mockRouter.push).toHaveBeenCalledWith('/concepts/intro-to-nursing');
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | Incorporated Story 2.4 backend (completion tracking) per SCP-2025-003 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*Will be recorded by dev agent*

### Debug Log References
*Will be populated by the development agent*

### Completion Notes List
*Will be populated by the development agent*

### File List
*Will be populated by the development agent*

## QA Results
*This section will be populated by QA Agent after implementation*
