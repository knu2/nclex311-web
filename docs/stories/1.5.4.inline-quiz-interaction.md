# Story 1.5.4: Inline Quiz Interaction

## Status
**Ready for Review**

## Story
**As a** user,  
**I want** to answer quiz questions directly below the concept content with immediate feedback,  
**so that** I can test my understanding without leaving the page.

**Note:** This story absorbs Story 1.7 (Interactive Quizzing).

## Acceptance Criteria
1. Quiz questions appear in the "ANSWER THIS" section below the concept content.
2. Support for multiple question types:
   - Multiple Choice (single answer)
   - Select All That Apply (SATA)
   - Fill-in-the-blank
   - Matrix/Grid (if applicable)
3. After answering, the UI immediately shows:
   - Correct/incorrect visual feedback (green checkmark / red X)
   - Detailed rationale explaining the correct answer
4. Users can retry questions after viewing rationale.
5. Answer submission is optimistic (instant UI update, background API call).
6. Quiz state persists during navigation (answered questions remain answered).
7. Questions are rendered with proper accessibility (keyboard navigation, screen reader support).
8. All interactions use MUI components (Radio, Checkbox, TextField, Button).

## Tasks / Subtasks

- [x] Task 1: Create InlineQuiz Component Structure (AC: 1, 8)
  - [x] Create `src/components/Quiz/InlineQuiz.tsx` component file
  - [x] Set up component container with "ANSWER THIS" section header
  - [x] Add proper TypeScript interfaces for question types
  - [x] Configure MUI components for quiz UI
  
- [x] Task 2: Implement Multiple Choice Questions (AC: 2, 8)
  - [x] Create MultipleChoice component using MUI Radio/RadioGroup
  - [x] Display question text and options
  - [x] Handle single option selection
  - [x] Style selected state
  
- [x] Task 3: Implement Select All That Apply (SATA) Questions (AC: 2, 8)
  - [x] Create SATA component using MUI Checkbox/FormGroup
  - [x] Display question text and multiple checkboxes
  - [x] Handle multiple option selection
  - [x] Validate that at least one option is selected
  
- [x] Task 4: Implement Fill-in-the-Blank Questions (AC: 2, 8)
  - [x] Create FillInBlank component using MUI TextField
  - [x] Display question with blank space(s)
  - [x] Handle text input
  - [x] Validate answer format (case-insensitive, trim whitespace)
  
- [x] Task 5: Implement Matrix/Grid Questions (AC: 2, 8)
  - [x] Create Matrix component using MUI Table or Grid
  - [x] Display matrix with rows and columns
  - [x] Handle selections for each row/column combination
  - [x] Style matrix for mobile responsiveness
  
- [x] Task 6: Add Answer Submission and Feedback (AC: 3, 5)
  - [x] Create "Submit Answer" button
  - [x] Implement optimistic UI update (instant feedback)
  - [x] Show correct/incorrect visual indicators (green checkmark / red X)
  - [x] Display detailed rationale after submission
  - [x] Send answer to API in background
  
- [x] Task 7: Implement Retry Functionality (AC: 4)
  - [x] Add "Try Again" button after viewing rationale
  - [x] Reset question state to allow re-answering
  - [x] Clear previous feedback and rationale
  - [x] Track retry attempts (optional analytics)
  
- [x] Task 8: Add Quiz State Management (AC: 6)
  - [x] Use React state or context for quiz answers
  - [x] Persist quiz state to localStorage/sessionStorage
  - [x] Restore quiz state on page load
  - [x] Sync state with API on submission
  
- [x] Task 9: Implement Accessibility Features (AC: 7)
  - [x] Add ARIA labels for all question types
  - [x] Ensure keyboard navigation works (Tab, Space, Enter)
  - [x] Add focus indicators
  - [x] Test with screen readers
  - [x] Announce feedback to screen readers (aria-live)
  
- [x] Task 10: Add Unit Tests
  - [x] Test all question types render correctly
  - [x] Test answer selection for each question type
  - [x] Test submit button enables/disables based on selection
  - [x] Test feedback displays after submission
  - [x] Test retry functionality
  - [x] Test state persistence across navigation

## Dev Notes

### Previous Story Insights
- Story 1.5.3 (Concept Viewer) completed: Displays concept content in "READ THIS" section [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: Question data available in concept API response [Source: Epic 1.5]

### Component Location
**File Path:** `apps/web/src/components/Quiz/InlineQuiz.tsx` [Source: Epic 1.5]

**Project Structure:**
```plaintext
apps/web/src/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ components/             # React components
â”‚   â””â”€â”€ Quiz/              # Quiz-related components
â”‚       â”œâ”€â”€ InlineQuiz.tsx    # Main quiz component
â”‚       â”œâ”€â”€ MultipleChoice.tsx
â”‚       â”œâ”€â”€ SelectAllThatApply.tsx
â”‚       â”œâ”€â”€ FillInBlank.tsx
â”‚       â””â”€â”€ MatrixQuestion.tsx
â””â”€â”€ lib/                    # Utility libraries
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router [Source: architecture/tech-stack.md]
- **UI Component Library:** MUI (Material-UI) ~5.x [Source: architecture/tech-stack.md]
- **TypeScript:** ~5.x with strict mode enabled [Source: architecture/tech-stack.md]
- **State Management:** React Built-in (useState/useContext) + localStorage [Source: architecture/tech-stack.md]

### MUI Components to Use
- **Radio/RadioGroup:** Multiple choice questions
- **Checkbox/FormGroup:** Select all that apply
- **TextField:** Fill-in-the-blank questions
- **Button:** Submit and retry buttons
- **Alert:** Feedback messages
- **Box/Paper:** Container and layout
- **Typography:** Text styling

### Question Types Specifications

**Multiple Choice:**
```typescript
{
  id: string;
  question_type: "multiple_choice";
  question_text: string;
  options: [
    { id: string; text: string; },
    { id: string; text: string; },
    { id: string; text: string; },
    { id: string; text: string; }
  ];
  correct_answer: string;  // Option ID
  rationale: string;
}
```

**Select All That Apply (SATA):**
```typescript
{
  id: string;
  question_type: "select_all";
  question_text: string;
  options: [
    { id: string; text: string; },
    ...
  ];
  correct_answer: string;  // Comma-separated option IDs
  rationale: string;
}
```

**Fill-in-the-Blank:**
```typescript
{
  id: string;
  question_type: "fill_blank";
  question_text: string;
  correct_answer: string;  // Accepted answer(s), pipe-separated alternatives
  rationale: string;
}
```

**Matrix/Grid:**
```typescript
{
  id: string;
  question_type: "matrix";
  question_text: string;
  matrix_rows: string[];
  matrix_columns: string[];
  correct_answer: string;  // JSON string of correct mappings
  rationale: string;
}
```

### API Specifications
[Source: Epic 1.5, Story 1.6 Backend]

**Questions included in:** `GET /api/concepts/{slug}` response

**Answer Submission:** `POST /api/questions/{id}/answer`
```typescript
// Request Body
{
  user_id: string;
  answer: string;  // Format depends on question type
  is_correct: boolean;
}

// Response
{
  success: boolean;
  is_correct: boolean;
  rationale: string;
}
```

### State Management Strategy
```typescript
// Quiz State Interface
interface QuizState {
  [questionId: string]: {
    selectedAnswer: string | string[];
    isSubmitted: boolean;
    isCorrect: boolean | null;
    rationale: string | null;
  };
}

// LocalStorage Key
const QUIZ_STATE_KEY = `nclex_quiz_state_${conceptId}`;
```

### Visual Feedback Specifications
[Source: docs/front-end-spec.md, Screen: Concept/Quiz Viewer]

**"ANSWER THIS" Quiz Section:**
- Background: Cool gradient (#f0f8ff to #e6f3ff)
- Left border: 4px solid blue (#2c5aa0)
- Border radius: 8px
- Padding: 1.5rem (24px)
- Heading: "ðŸ§  ANSWER THIS" (blue #2c5aa0, 1.1rem, bold)

**Quiz Answer Options:** [Source: front-end-spec.md]
- **Default State:**
  - White background
  - 2px border (#e1e7f0)
  - Border radius: 6px
  - Min height: 44px (touch-friendly)
  - Padding: 12px (0.75rem)

- **Hover State:**
  - Blue border (#2c5aa0)
  - Slight lift animation (150ms ease-out)
  - Light blue background tint

- **Selected State:**
  - Blue border (#2c5aa0, 2px)
  - Light blue background (#e8f0fe)

- **Correct Answer (Post-Submission):**
  - Green border (#00b894)
  - Green background (light tint)
  - Checkmark icon âœ“ (CheckCircleIcon)

- **Incorrect Answer (Post-Submission):**
  - Red/orange border (#e17055)
  - Yellow background (#ffeaa7)
  - X icon (CancelIcon)

**Feedback Cards:** [Source: front-end-spec.md]
- **Correct Feedback:**
  - Green background (#00b894)
  - "âœ“ Correct!" message
  - White text
  - Border radius: 6px
  - Animation: Fade in 250ms ease-in-out

- **Incorrect Feedback:**
  - Yellow/red background (#ffeaa7)
  - "âœ— Try Again" message
  - Dark text (#2c3e50)
  - Border radius: 6px
  - Animation: Fade in 250ms ease-in-out

**Rationale Section:** [Source: front-end-spec.md]
- Background: Light gray (#f8f9fc)
- Heading: "ðŸ“‹ Rationale" (H4, 1rem, 600 weight)
- Padding: 1.5rem (24px)
- Border radius: 6px
- Expands with smooth animation (250ms ease-in-out)

**Key Points Section:** [Source: front-end-spec.md]
- Background: Light yellow (#fff9e6)
- Left border: 4px solid orange (#ff6b35)
- Heading: "ðŸ”‘ Key Points" (orange #ff6b35, 1.1rem, bold)
- Padding: 1.5rem (24px)
- Border radius: 6px
- Bullet list formatting

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md`
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** All form elements labeled
- **Keyboard Navigation:** Full keyboard support (Tab, Space, Enter)
- **Screen Reader:** Announce feedback using aria-live regions
- **Focus Management:** Focus moves to feedback after submission

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.3 (Concept Viewer):** Displays below concept content
2. **Story 1.6 Backend:** Uses question data from concept API
3. **Story 2.4 (Completion Tracking):** Triggers concept completion after all questions answered

### TypeScript Interfaces
```typescript
// Component Props
interface InlineQuizProps {
  questions: Question[];
  conceptId: string;
  onAllQuestionsAnswered?: () => void;
}

// Question Types
type QuestionType = 'multiple_choice' | 'select_all' | 'fill_blank' | 'matrix';

interface Question {
  id: string;
  question_type: QuestionType;
  question_text: string;
  options?: Option[];
  correct_answer: string;
  rationale: string;
  matrix_rows?: string[];
  matrix_columns?: string[];
}

interface Option {
  id: string;
  text: string;
}

// Answer State
interface AnswerState {
  selectedAnswer: string | string[];
  isSubmitted: boolean;
  isCorrect: boolean | null;
  rationale: string | null;
}
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Quiz/InlineQuiz.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - All question types render correctly
   - Options display for each question
   - Submit button renders
   
2. **Interaction Tests:**
   - Multiple choice: Selecting option works
   - SATA: Multiple selections work
   - Fill-blank: Text input works
   - Submit button triggers feedback
   
3. **Feedback Tests:**
   - Correct answer shows green checkmark
   - Incorrect answer shows red X
   - Rationale displays after submission
   - Retry button appears and works
   
4. **State Tests:**
   - Quiz state persists to localStorage
   - State restores on component mount
   - Navigation preserves answered questions
   
5. **Accessibility Tests:**
   - ARIA labels present
   - Keyboard navigation works
   - Screen reader announcements work

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { InlineQuiz } from '@/components/Quiz/InlineQuiz';

describe('InlineQuiz', () => {
  const mockQuestions = [
    {
      id: 'q1',
      question_type: 'multiple_choice',
      question_text: 'What is the capital of France?',
      options: [
        { id: 'opt1', text: 'London' },
        { id: 'opt2', text: 'Paris' },
        { id: 'opt3', text: 'Berlin' },
      ],
      correct_answer: 'opt2',
      rationale: 'Paris is the capital and largest city of France.',
    },
  ];
  
  it('renders multiple choice question with options', () => {
    render(<InlineQuiz questions={mockQuestions} conceptId="concept-1" />);
    
    expect(screen.getByText('What is the capital of France?')).toBeInTheDocument();
    expect(screen.getByLabelText('London')).toBeInTheDocument();
    expect(screen.getByLabelText('Paris')).toBeInTheDocument();
    expect(screen.getByLabelText('Berlin')).toBeInTheDocument();
  });
  
  it('shows correct feedback after submitting correct answer', async () => {
    render(<InlineQuiz questions={mockQuestions} conceptId="concept-1" />);
    
    const parisOption = screen.getByLabelText('Paris');
    fireEvent.click(parisOption);
    
    const submitButton = screen.getByText('Submit Answer');
    fireEvent.click(submitButton);
    
    await waitFor(() => {
      expect(screen.getByTestId('CheckCircleIcon')).toBeInTheDocument();
      expect(screen.getByText(/Paris is the capital/)).toBeInTheDocument();
    });
  });
  
  it('allows retry after viewing rationale', async () => {
    render(<InlineQuiz questions={mockQuestions} conceptId="concept-1" />);
    
    const londonOption = screen.getByLabelText('London');
    fireEvent.click(londonOption);
    
    const submitButton = screen.getByText('Submit Answer');
    fireEvent.click(submitButton);
    
    await waitFor(() => {
      expect(screen.getByTestId('CancelIcon')).toBeInTheDocument();
    });
    
    const retryButton = screen.getByText('Try Again');
    fireEvent.click(retryButton);
    
    expect(screen.queryByTestId('CancelIcon')).not.toBeInTheDocument();
    expect(screen.queryByText(/Paris is the capital/)).not.toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5, absorbs Story 1.7 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 4.5 Sonnet (via BMad Dev Agent - James)

### Debug Log References
No critical issues encountered. Type-check validation passed for all new components.

### Completion Notes List
- All 10 tasks completed successfully with comprehensive test coverage
- Implemented inline quiz with all 4 question types (Multiple Choice, SATA, Fill-in-Blank, Matrix/Grid)
- Full accessibility support with ARIA labels, keyboard navigation, and screen reader announcements
- State persistence using localStorage with concept-specific keys
- Optimistic UI updates with background API calls
- Retry functionality with state tracking
- Integration with ConceptViewer component using transformation layer for backward compatibility
- Comprehensive unit tests covering rendering, interactions, feedback, state persistence, and accessibility
- Code formatted and linted according to project standards

### File List
**New Files Created:**
- `apps/web/src/components/Quiz/types.ts` - TypeScript interfaces for quiz components
- `apps/web/src/components/Quiz/InlineQuiz.tsx` - Main inline quiz component
- `apps/web/src/components/Quiz/MultipleChoice.tsx` - Multiple choice question component
- `apps/web/src/components/Quiz/SelectAllThatApply.tsx` - SATA question component
- `apps/web/src/components/Quiz/FillInBlank.tsx` - Fill-in-blank question component
- `apps/web/src/components/Quiz/MatrixQuestion.tsx` - Matrix/grid question component
- `apps/web/src/components/Quiz/index.ts` - Quiz components export file
- `apps/web/__tests__/components/Quiz/InlineQuiz.test.tsx` - Comprehensive unit tests

**Modified Files:**
- `apps/web/src/components/Concept/ConceptViewer.tsx` - Integrated InlineQuiz component below concept content

## QA Results
*This section will be populated by QA Agent after implementation*
