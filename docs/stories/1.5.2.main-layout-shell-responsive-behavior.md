# Story 1.5.2: Main Layout Shell & Responsive Behavior

## Status
**Draft**

## Story
**As a** user,  
**I want** the application layout to adapt seamlessly between desktop and mobile,  
**so that** I have an optimal learning experience on any device.

## Acceptance Criteria
1. A main layout component is created that integrates:
   - App header with logo and user menu
   - Sidebar (Story 1.5.1)
   - Main content area
2. Desktop layout (≥960px):
   - Sidebar always visible on left
   - Main content takes remaining width
   - Header spans full width
3. Mobile layout (<960px):
   - Sidebar accessible via drawer (hamburger icon in header)
   - Content takes full width
   - Drawer overlays content when open
4. The layout uses MUI's responsive utilities (useMediaQuery, Grid, Box).
5. Smooth transitions when toggling mobile drawer.
6. Layout state (drawer open/closed) persists during navigation.
7. Header includes:
   - Logo/app title (links to All Chapters view)
   - User profile menu with logout
   - "Upgrade to Premium" button (for free users)
8. All interactive elements meet accessibility standards.

## Tasks / Subtasks

- [ ] Task 1: Create MainLayout Component Structure (AC: 1, 4)
  - [ ] Create `src/components/Layout/MainLayout.tsx` component file
  - [ ] Set up MUI Box component for overall layout container
  - [ ] Add proper TypeScript interfaces for component props
  - [ ] Configure layout grid using MUI Grid or Flexbox
  
- [ ] Task 2: Build App Header Component (AC: 7)
  - [ ] Create header using MUI AppBar and Toolbar components
  - [ ] Add logo/app title as clickable link to `/chapters`
  - [ ] Implement user profile menu with MUI Menu component
  - [ ] Add logout functionality with proper session handling
  - [ ] Add "Upgrade to Premium" button for free users
  - [ ] Add hamburger menu icon for mobile (visible <960px only)
  
- [ ] Task 3: Integrate Sidebar Component (AC: 1, 2, 3)
  - [ ] Import ConceptList component from Story 1.5.1
  - [ ] Position sidebar on left side with fixed width (280px)
  - [ ] Implement permanent drawer for desktop (≥960px)
  - [ ] Implement temporary drawer for mobile (<960px)
  - [ ] Wire hamburger menu toggle to drawer open/close
  
- [ ] Task 4: Configure Main Content Area (AC: 2, 3)
  - [ ] Create main content container with proper spacing
  - [ ] Calculate content width based on sidebar visibility
  - [ ] Desktop: Content width = 100% - 280px (sidebar width)
  - [ ] Mobile: Content width = 100% (full width)
  - [ ] Add proper padding and margins for readability
  
- [ ] Task 5: Implement Responsive Breakpoints (AC: 4)
  - [ ] Use MUI useMediaQuery hook for 960px breakpoint
  - [ ] Toggle drawer variant based on screen size
  - [ ] Update layout styles dynamically on resize
  - [ ] Test on various screen sizes (mobile, tablet, desktop)
  
- [ ] Task 6: Add Drawer State Management (AC: 5, 6)
  - [ ] Create state for drawer open/closed (useState or context)
  - [ ] Persist drawer state in localStorage or sessionStorage
  - [ ] Restore drawer state on page load
  - [ ] Implement smooth transitions using MUI Drawer transitionDuration
  
- [ ] Task 7: Implement Accessibility Features (AC: 8)
  - [ ] Add proper ARIA labels for header elements
  - [ ] Ensure keyboard navigation for menu and drawer
  - [ ] Add focus management when drawer opens/closes
  - [ ] Test with screen readers (VoiceOver/NVDA)
  - [ ] Ensure color contrast meets WCAG 2.1 AA standards
  
- [ ] Task 8: Add User Menu Functionality (AC: 7)
  - [ ] Create user profile menu with user name and avatar
  - [ ] Add menu items: Profile, Settings, Logout
  - [ ] Implement logout API call and redirect to login
  - [ ] Handle menu open/close state
  
- [ ] Task 9: Add Unit Tests
  - [ ] Test layout renders with sidebar and header
  - [ ] Test desktop layout (sidebar always visible)
  - [ ] Test mobile layout (drawer toggles on hamburger click)
  - [ ] Test drawer state persistence
  - [ ] Test user menu functionality
  - [ ] Test "Upgrade to Premium" button visibility (free users only)
  
- [ ] Task 10: Add Integration Tests
  - [ ] Test responsive behavior at various breakpoints
  - [ ] Test navigation between pages with persistent layout
  - [ ] Test logout flow
  - [ ] Test drawer transitions

## Dev Notes

### Previous Story Insights
- Story 1.5 (MUI Theme) completed: MUI ~5.x configured with brand colors and responsive patterns [Source: Epic 1.5]
- Story 1.5.1 (Sidebar Navigation) completed: ConceptList component available for integration [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: User authentication and session management available [Source: Epic 1.5]

### Component Location
**File Path:** `apps/web/src/components/Layout/MainLayout.tsx` [Source: Epic 1.5, architecture/project-structure.md]

**Project Structure:**
```plaintext
apps/web/src/
├── app/                    # Next.js App Router
├── components/             # React components
│   ├── Layout/            # Layout components
│   │   └── MainLayout.tsx  # This story's main component
│   └── Sidebar/           # Sidebar components (Story 1.5.1)
└── lib/                    # Utility libraries
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router [Source: architecture/tech-stack.md]
- **UI Component Library:** MUI (Material-UI) ~5.x [Source: architecture/tech-stack.md]
- **TypeScript:** ~5.x with strict mode enabled [Source: architecture/tech-stack.md]
- **State Management:** React Built-in (useState/useContext) [Source: architecture/tech-stack.md]

### MUI Components to Use
[Source: architecture/tech-stack.md, Epic 1.5]
- **AppBar:** Header container
- **Toolbar:** Header content layout
- **Drawer:** Sidebar container (from Story 1.5.1)
- **Box:** Main layout container and spacing
- **IconButton:** Hamburger menu toggle
- **Menu/MenuItem:** User profile menu
- **Button:** "Upgrade to Premium" button
- **useMediaQuery:** Responsive breakpoint detection

### Responsive Breakpoints
[Source: architecture/coding-standards.md, frontend-spec]
- **Desktop:** ≥960px - Permanent drawer, full header with all elements
- **Mobile:** <960px - Temporary drawer, compact header with hamburger menu

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**Layout Dimensions:**
- **Sidebar Width:** 280px (fixed) [Source: front-end-spec.md, Screen: Main Layout]
- **Header Height:** 64px (MUI default AppBar height)
- **Content Max Width:** 800px (optimal reading width) [Source: front-end-spec.md]
- **Drawer Transition:** 225ms (ease-out) [Source: front-end-spec.md, Animation]

**Brand Colors:** [Source: front-end-spec.md, Color Palette]
- **Primary Blue:** #2c5aa0 - Header background, primary buttons, active links
- **Accent Orange:** #ff6b35 - Accent elements, callouts
- **Text Primary:** #2c3e50 - Main body text, headlines
- **Text Secondary:** #6c757d - Meta information, disabled text
- **Borders/BG:** #e1e7f0 - Borders, dividers, light backgrounds

**Typography:** [Source: front-end-spec.md, Typography]
- **Font Stack:** -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif
- **App Title:** 19px (1.2rem), 600 weight
- **Body Text:** 16px (1rem), 400 weight

**Spacing:** [Source: front-end-spec.md, Spacing & Layout]
- Use 8px spacing scale: 8px, 16px, 24px, 32px
- Header padding: 16px (1rem)
- Content padding: 24px mobile, 32px desktop

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md`
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required for all interactive elements
- **ARIA Labels:** Add descriptive labels for hamburger menu, user menu, etc.
- **Keyboard Navigation:** Tab, Enter, Escape keys must work
- **Focus Management:** Focus trap in drawer when open on mobile
- **Color Contrast:** Minimum 4.5:1 for normal text, 3:1 for large text

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.1 (Sidebar Navigation):** Integrates ConceptList component
2. **Story 1.6 Backend:** Uses user authentication and session management
3. **Story 2.1 (Payment Workflow):** Links "Upgrade to Premium" button to payment flow
4. **All Future Stories:** Provides layout wrapper for all content pages

### TypeScript Interfaces
```typescript
// Component Props
interface MainLayoutProps {
  children: React.ReactNode;
  user?: {
    id: string;
    name: string;
    email: string;
    avatar?: string;
    is_premium: boolean;
  };
  chapterId?: string;
  currentConceptSlug?: string;
}

// Drawer State
interface DrawerState {
  isOpen: boolean;
  variant: 'permanent' | 'temporary';
}
```

### Local Storage Keys
```typescript
const DRAWER_STATE_KEY = 'nclex_drawer_state';
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Layout/MainLayout.test.tsx` [Source: architecture/project-structure.md]

**Testing Standards:** [Source: architecture/coding-standards.md]
- **Framework:** Jest 30.x + React Testing Library 16.x
- **Focus:** Test user-facing behavior, not implementation details
- **Mock:** External dependencies (API calls, router, localStorage)

**Required Test Cases:**
1. **Rendering Tests:**
   - Layout renders with header, sidebar, and content area
   - Header displays logo, user menu, and "Upgrade" button
   - Desktop: Sidebar is visible by default
   - Mobile: Sidebar is hidden by default

2. **Interaction Tests:**
   - Clicking hamburger menu toggles drawer on mobile
   - Clicking logo navigates to `/chapters`
   - User menu opens on click and shows menu items
   - Logout button triggers logout flow
   - "Upgrade to Premium" button is visible for free users only

3. **Responsive Tests:**
   - Desktop (≥960px): Permanent drawer, full header
   - Mobile (<960px): Temporary drawer, hamburger menu visible
   - Layout adapts smoothly on window resize

4. **State Persistence Tests:**
   - Drawer state saves to localStorage
   - Drawer state restores on page load
   - Drawer state persists across navigation

5. **Accessibility Tests:**
   - ARIA labels are present
   - Keyboard navigation works
   - Focus management works correctly
   - Color contrast passes WCAG 2.1 AA

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { MainLayout } from '@/components/Layout/MainLayout';

describe('MainLayout', () => {
  it('renders header with logo and user menu', () => {
    const mockUser = { id: '1', name: 'John Doe', email: 'john@example.com', is_premium: false };
    render(<MainLayout user={mockUser}><div>Content</div></MainLayout>);
    
    expect(screen.getByText(/NCLEX 311/i)).toBeInTheDocument();
    expect(screen.getByText(/John Doe/i)).toBeInTheDocument();
    expect(screen.getByText(/Upgrade to Premium/i)).toBeInTheDocument();
  });
  
  it('toggles drawer on hamburger menu click (mobile)', () => {
    // Mock mobile viewport
    window.matchMedia = jest.fn().mockImplementation(query => ({
      matches: query === '(max-width: 960px)',
      media: query,
    }));
    
    render(<MainLayout><div>Content</div></MainLayout>);
    
    const hamburger = screen.getByLabelText(/open drawer/i);
    fireEvent.click(hamburger);
    
    expect(screen.getByRole('presentation')).toBeInTheDocument(); // Drawer
  });
  
  it('shows permanent drawer on desktop', () => {
    // Mock desktop viewport
    window.matchMedia = jest.fn().mockImplementation(query => ({
      matches: query === '(min-width: 960px)',
      media: query,
    }));
    
    render(<MainLayout><div>Content</div></MainLayout>);
    
    expect(screen.getByRole('complementary')).toBeInTheDocument(); // Sidebar
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5 | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*Will be recorded by dev agent*

### Debug Log References
*Will be populated by the development agent*

### Completion Notes List
*Will be populated by the development agent*

### File List
*Will be populated by the development agent*

## QA Results
*This section will be populated by QA Agent after implementation*
