# Story 1.6.1: Markdown Content Rendering

## Status
Approved

## Story
**As a** user,
**I want** all educational content (concepts, questions, rationales, and options) to be properly formatted with bold text, bullet points, and line breaks,
**so that** the content is readable, professional, and matches the intended formatting from the source material.

## Acceptance Criteria
1. All concept content displays with proper markdown formatting (bold, italic, line breaks, lists).
2. All question text displays with proper markdown formatting.
3. All answer option text displays with proper markdown formatting.
4. All rationales display with proper markdown formatting including bullet points and emphasis.
5. Rendered content is protected against XSS attacks through proper sanitization.
6. The rendered content integrates seamlessly with existing MUI Typography components and project styling.

## Tasks / Subtasks
- [ ] **Task 1: Install Required Dependencies** (AC: 5)
    - [ ] Install `react-markdown@^9.0.0` package
    - [ ] Install `rehype-sanitize@^6.0.0` package
    - [ ] Verify dependencies are added to `apps/web/package.json`
    - [ ] Run `npm install` to update lock file
- [ ] **Task 2: Create Reusable MarkdownContent Component** (AC: 1, 2, 3, 4, 5, 6)
    - [ ] Create `apps/web/src/components/MarkdownContent.tsx` component following the pattern from coding-standards.md [Source: docs/architecture/coding-standards.md#Content Rendering Standards]
    - [ ] Implement ReactMarkdown with rehype-sanitize plugin for XSS protection
    - [ ] Configure custom component mapping for MUI Typography integration (p, strong, em, ul, ol, li, code)
    - [ ] Support `variant` prop ('body1' | 'body2') for typography control
    - [ ] Add proper TypeScript interfaces for props
    - [ ] Memoize component with React.memo for performance
    - [ ] Set displayName for debugging
- [ ] **Task 3: Refactor Concept Content Display** (AC: 1, 6)
    - [ ] Update `apps/web/src/app/concepts/[slug]/page.tsx` to use MarkdownContent component
    - [ ] Replace direct Typography rendering of `concept.content` with `<MarkdownContent content={concept.content} variant="body1" />`
    - [ ] Test concept page with markdown-formatted content to verify proper rendering
    - [ ] Ensure styling remains consistent with existing design
- [ ] **Task 4: Refactor Quiz Component** (AC: 2, 3, 4, 6)
    - [ ] Update `apps/web/src/components/Quiz.tsx` to use MarkdownContent component
    - [ ] Replace question text rendering with `<MarkdownContent content={question.text} variant="body1" />`
    - [ ] Replace option text rendering with `<MarkdownContent content={option.text} variant="body2" />`
    - [ ] Replace rationale rendering with `<MarkdownContent content={question.rationale} variant="body2" />`
    - [ ] Test quiz display with various markdown patterns (bold, lists, line breaks)
- [ ] **Task 5: Unit Tests for MarkdownContent Component** (AC: 1, 2, 3, 4, 5)
    - [ ] Create `apps/web/__tests__/components/MarkdownContent.test.tsx` following testing standards [Source: docs/architecture/coding-standards.md#Testing Requirements]
    - [ ] Test bold text rendering (`**bold**`)
    - [ ] Test italic text rendering (`*italic*`)
    - [ ] Test unordered list rendering (`- item`)
    - [ ] Test ordered list rendering (`1. item`)
    - [ ] Test line break handling (`\n`)
    - [ ] Test XSS prevention (script tags should be sanitized)
    - [ ] Test MUI Typography integration
    - [ ] Test variant prop functionality
    - [ ] Achieve minimum 80% code coverage for the component
- [ ] **Task 6: E2E Tests for Rendered Content** (AC: 1, 2, 3, 4, 6)
    - [ ] Create or update `apps/web/e2e/markdown-rendering.spec.ts` with Playwright tests
    - [ ] Test concept page displays formatted content (verify bold text is visible, lists are rendered)
    - [ ] Test quiz question displays formatted text
    - [ ] Test quiz options display formatted text
    - [ ] Test rationale displays formatted text with lists
    - [ ] Verify no raw markdown syntax is visible to users (e.g., no `**` or `\n` visible)
    - [ ] Test across different viewport sizes for responsive rendering

## Dev Notes

### Previous Story Insights
Story 1.6 (Content Browsing & Freemium Access) identified a critical issue: content stored with markdown formatting (including `\n` escape sequences, `**bold**`, bullet points with `-`) was displaying as plain text without proper formatting. The Typography components were rendering content directly without markdown-to-HTML conversion, causing raw markdown syntax to be visible to users.

**Files Affected in Story 1.6:**
- `apps/web/src/app/concepts/[slug]/page.tsx` - Concept content display
- `apps/web/src/components/Quiz.tsx` - Question text and rationale display

[Source: docs/stories/1.6.content-browsing-freemium-access.md#Known Issues]

### Tech Stack
- **Markdown Rendering Library:** react-markdown ~9.x - Safe, performant rendering of markdown-formatted content with React component support
- **Markdown Sanitization Library:** rehype-sanitize ~6.x - XSS protection for rendered content through HTML output sanitization

[Source: docs/architecture/tech-stack.md#Markdown Rendering]

### UI Component Library
The project uses **Material-UI (MUI) ~5.x** as the component library for all React components. The MarkdownContent component must integrate seamlessly with MUI Typography components to maintain design consistency.

[Source: docs/front-end-spec.md#Component Library / Design System]

### Content Rendering Standards

**Implementation Pattern:**
The MarkdownContent component must follow the exact pattern specified in coding standards with:
- ReactMarkdown as the base component
- rehype-sanitize plugin for security
- Custom component mapping for MUI Typography integration
- Memoization for performance optimization

**Component Location:**
Create at `apps/web/src/components/MarkdownContent.tsx` following the project structure for shared components.

[Source: docs/architecture/coding-standards.md#Content Rendering Standards]
[Source: docs/architecture/project-structure.md#Main Web Application]

**Required Configuration:**
```typescript
interface MarkdownContentProps {
  content: string;
  variant?: 'body1' | 'body2';
}
```

**Custom Component Mapping:**
- `p` → MUI Typography with paragraph spacing
- `strong` → MUI Typography span with fontWeight="bold"
- `em` → MUI Typography span with fontStyle="italic"
- `ul`/`ol` → MUI Box with proper spacing
- `li` → MUI Typography component="li"
- `code` → MUI Typography with monospace font and background

[Source: docs/architecture/coding-standards.md#Content Rendering Standards - Implementation Requirements]

### Security Requirements

**XSS Protection:**
- ALWAYS include rehype-sanitize plugin when rendering markdown
- NEVER use dangerouslySetInnerHTML for database content
- The sanitization plugin automatically blocks: script tags, iframes, object tags, embed tags, event handlers, style tags
- The sanitization plugin automatically removes: JavaScript URIs, dangerous attributes

**Content Validation:**
Content is already validated and stored in the database. This story focuses on safe rendering, not ingestion validation.

[Source: docs/architecture/coding-standards.md#Content Rendering Standards - Security Considerations]

### Data Models

**Concept Model:**
```typescript
interface Concept {
  id: string;
  title: string;
  slug: string;
  content: string;  // Stored with markdown formatting
  conceptNumber: number;
  chapterId: string;
}
```

**Question Model:**
```typescript
interface Question {
  id: string;
  text: string;       // Stored with markdown formatting
  type: 'MULTIPLE_CHOICE' | 'SELECT_ALL' | 'FILL_IN_BLANK' | 'MATRIX';
  rationale: string;  // Stored with markdown formatting
  conceptId: string;
}
```

**Option Model:**
```typescript
interface Option {
  id: string;
  text: string;       // Stored with markdown formatting
  isCorrect: boolean;
  questionId: string;
}
```

[Source: docs/architecture/data-models.md#Concept, #Question, #Option]

### File Locations

**New Files:**
- `apps/web/src/components/MarkdownContent.tsx` - Reusable markdown rendering component
- `apps/web/__tests__/components/MarkdownContent.test.tsx` - Unit tests for component
- `apps/web/e2e/markdown-rendering.spec.ts` - E2E tests for rendered content (or add to existing E2E file)

**Modified Files:**
- `apps/web/src/app/concepts/[slug]/page.tsx` - Update concept content rendering
- `apps/web/src/components/Quiz.tsx` - Update question, option, and rationale rendering
- `apps/web/package.json` - Add new dependencies

[Source: docs/architecture/project-structure.md#Main Web Application]

### Testing

**Testing Standards:**
- **Unit Tests:** Use Jest + React Testing Library to test MarkdownContent component in isolation
- **Test Location:** `apps/web/__tests__/components/`
- **Coverage Target:** Minimum 80% code coverage for new component
- **E2E Tests:** Use Playwright to verify rendered content in actual browser
- **E2E Location:** `apps/web/e2e/`

**Required Test Cases:**
1. Markdown formatting patterns (bold, italic, lists, line breaks)
2. XSS prevention (malicious script injection blocked)
3. MUI Typography integration (proper component mapping)
4. Variant prop functionality (body1 vs body2)
5. Visual regression (content appears correctly in UI)

[Source: docs/architecture/coding-standards.md#Content Rendering Standards - Testing Requirements]

**Example Test Structure:**
```typescript
describe('MarkdownContent', () => {
  it('renders bold text correctly', () => {
    render(<MarkdownContent content="**Cardiovascular**: chest pain" />);
    const boldText = screen.getByText('Cardiovascular', { exact: false });
    expect(boldText).toHaveStyle({ fontWeight: 'bold' });
  });
  
  it('blocks XSS attempts', () => {
    const maliciousContent = '<script>alert("XSS")</script>Normal text';
    render(<MarkdownContent content={maliciousContent} />);
    expect(screen.queryByText(/XSS/)).not.toBeInTheDocument();
    expect(screen.getByText('Normal text')).toBeInTheDocument();
  });
  
  it('renders lists with proper formatting', () => {
    const listContent = '- Item 1\n- Item 2\n- Item 3';
    render(<MarkdownContent content={listContent} />);
    expect(screen.getByRole('list')).toBeInTheDocument();
    expect(screen.getAllByRole('listitem')).toHaveLength(3);
  });
});
```

[Source: docs/architecture/coding-standards.md#Content Rendering Standards - Testing Requirements]

### Performance Considerations

**Memoization:**
The MarkdownContent component must be memoized with React.memo to prevent unnecessary re-renders when parent components update.

**Example:**
```typescript
export const MarkdownContent = memo<MarkdownContentProps>(({ content, variant }) => {
  return <ReactMarkdown>{content}</ReactMarkdown>;
});

MarkdownContent.displayName = 'MarkdownContent';
```

[Source: docs/architecture/coding-standards.md#Content Rendering Standards - Performance Considerations]

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-01 | 1.0 | Initial draft created to address markdown rendering issue from Story 1.6 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent.*

### Implementation Summary
*To be populated by development agent.*

### File List
*To be populated by development agent.*

### Completion Notes
*To be populated by development agent.*

### Known Issues / Technical Debt
*To be populated by development agent.*

### Change Log
*To be populated by development agent.*

## QA Results
*To be populated by QA agent.*
