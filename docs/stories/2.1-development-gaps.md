# Story 2.1 Development Gaps Analysis

**Date**: October 25, 2025  
**Story**: Premium Subscription Workflow  
**Status**: 90% Complete - Integration Issues Found

## Critical Missing Integration

### 1. **Upgrade Page / Flow Integration** ‚ö†Ô∏è HIGH PRIORITY

**Issue**: The payment components exist but aren't integrated into the user-facing flow.

**Current State**:
- ‚úÖ Payment components created: `PlanSelector`, `CheckoutButton`, `PremiumGate`
- ‚úÖ Backend APIs working: `/api/payments/create-invoice`
- ‚ùå No dedicated `/upgrade` page
- ‚ùå Chapter upgrade buttons don't use payment components
- ‚ùå Upgrade dialog in `ChapterGrid.tsx` has TODO placeholder (line 184)

**What Needs to Be Built**:

#### Option A: Create Dedicated Upgrade Page (Recommended)
```
apps/web/src/app/upgrade/page.tsx
```
- Display `PlanSelector` component
- Include `CheckoutButton` component
- Show premium features list
- Pricing comparison table

#### Option B: Integrate into Existing Dialog
Update `ChapterGrid.tsx` to use existing payment components:
- Replace Dialog content with `PlanSelector`
- Replace "Upgrade Now" button with `CheckoutButton`
- Import from `@/components/payments`

**Recommended**: **Option A** - Dedicated page is cleaner, more testable, and allows for:
- Direct marketing link: `/upgrade`
- Better SEO
- Easier A/B testing
- Cleaner user flow

---

### 2. **Order Status Endpoint** ‚ö†Ô∏è MEDIUM PRIORITY

**Missing API**: `GET /api/payments/[orderId]/status`

**Required For**:
- Payment success page polling (currently uses subscription endpoint as workaround)
- Admin order tracking
- Customer support troubleshooting

**Implementation** (Task 3 - Line 101-104):
```typescript
// apps/web/src/app/api/payments/[orderId]/status/route.ts
- Verify user owns the order
- Return current order status and details
- Include Xendit invoice status if available
```

---

### 3. **Webhook Email Integration** ‚ö†Ô∏è LOW PRIORITY

**Current State**:
- ‚úÖ Email service implemented (`src/lib/email.ts`)
- ‚úÖ Email templates created (monthly/annual)
- ‚ùå Not called from webhook handler
- ‚ùå Cancellation confirmation email not implemented

**What's Missing** (Task 4 - Line 146, Task 3 - Line 113):
1. Add email call in webhook handler after subscription activation
2. Add email call in cancel-subscription endpoint
3. Handle email failures gracefully (already implemented in EmailService)

**Code Change Needed**:
```typescript
// In apps/web/src/app/api/webhooks/xendit/route.ts
// After activating subscription:
await EmailService.getInstance().sendPremiumConfirmationEmail(
  user.email,
  orderData,
  subscriptionData
);
```

---

### 4. **Session User Subscription Status** ‚ö†Ô∏è MEDIUM PRIORITY

**Issue**: User subscription status not in session

**Current State**:
- ‚úÖ Database has subscription fields
- ‚úÖ `UserService.getSubscription()` works
- ‚ùå Session doesn't include `subscriptionStatus`
- ‚ùå `PremiumGate` checks undefined value

**Impact**:
- Premium content gating doesn't work properly
- `ChapterGrid` always shows `isPremiumUser = false`

**What Needs to Be Built**:
Update NextAuth session callback to include subscription data:

```typescript
// apps/web/src/lib/auth.ts or wherever NextAuth is configured
callbacks: {
  async session({ session, token, user }) {
    if (session.user) {
      session.user.id = user.id;
      session.user.subscriptionStatus = user.subscription_status;
      session.user.subscriptionPlan = user.subscription_plan;
      session.user.subscriptionExpiresAt = user.subscription_expires_at;
      session.user.autoRenew = user.auto_renew;
    }
    return session;
  }
}
```

---

### 5. **MainLayout Premium Integration** ‚ö†Ô∏è MEDIUM PRIORITY

**Issue**: `is_premium` hardcoded to `false` in chapters page

**Current Code** (chapters/page.tsx line 32):
```typescript
const user = {
  id: (session.user as { id?: string }).id || '',
  name: session.user.name || session.user.email || 'User',
  email: session.user.email || '',
  avatar: (session.user as { image?: string }).image,
  is_premium: false, // TODO: Get from database in future story
};
```

**Fix**:
```typescript
is_premium: (session.user as { subscriptionStatus?: string })
  ?.subscriptionStatus === 'premium',
```

---

## Testing Gaps (Not Blockers)

All core functionality works, but lacks test coverage:

### Unit Tests Needed:
- [ ] Xendit client tests (Task 2)
- [ ] Payment endpoint tests (Task 3)
- [ ] Webhook processing tests (Task 4)
- [ ] Service layer tests (Task 5)
- [ ] Component tests (Task 6)

### E2E Tests Needed:
- [ ] Complete upgrade flow (Task 7)
- [ ] Payment failure handling (Task 7)

**Note**: These are good practice but not required for MVP launch.

---

## Deployment / Infrastructure Gaps

### 1. **Webhook Accessibility**
- ‚úÖ Webhook handler implemented
- ‚ùå Local development needs ngrok
- ‚ùå Production needs public webhook URL configured in Xendit

### 2. **Environment Variables**
- ‚úÖ Documented in README
- ‚ùå Not yet configured in Vercel
- ‚ùå SendGrid API key needed for emails

### 3. **Monitoring & Logging** (Task 10)
- ‚ùå No structured logging for payment events
- ‚ùå No error tracking setup
- ‚ùå No monitoring metrics

**Recommended**: Use Vercel Analytics + Sentry for production

---

## Priority Action Plan

### üî¥ **Must-Have Before Launch** (2-4 hours)

1. **Create Upgrade Page** (1-2 hours)
   - New file: `apps/web/src/app/upgrade/page.tsx`
   - Use existing `PlanSelector` and `CheckoutButton` components
   - Add to navigation menu

2. **Integrate Upgrade Flow** (30 min)
   - Update `ChapterGrid.tsx` to navigate to `/upgrade`
   - Update header "Upgrade" button to link to `/upgrade`

3. **Fix Session Integration** (1 hour)
   - Update NextAuth session callback
   - Update chapters page user object
   - Test premium content gating

4. **Add Webhook Email** (30 min)
   - Import EmailService in webhook handler
   - Call after subscription activation
   - Test with ngrok

### üü° **Should-Have Before Launch** (2-3 hours)

5. **Order Status Endpoint** (1 hour)
   - Create `[orderId]/status/route.ts`
   - Update success page to use it

6. **Configure Vercel** (1-2 hours)
   - Add environment variables
   - Set up webhook URL
   - Test production deployment

### üü¢ **Nice-to-Have** (Future)

7. **Monitoring** - Can be added post-launch
8. **Unit Tests** - Add incrementally
9. **E2E Tests** - Add after user feedback

---

## File Changes Required

### New Files to Create:
1. `apps/web/src/app/upgrade/page.tsx` - Upgrade page
2. `apps/web/src/app/api/payments/[orderId]/status/route.ts` - Order status API

### Files to Modify:
1. `apps/web/src/components/Chapters/ChapterGrid.tsx` - Line 184-186 (navigate to /upgrade)
2. `apps/web/src/lib/auth.ts` - Add subscription fields to session
3. `apps/web/src/app/chapters/page.tsx` - Line 32 (fix is_premium)
4. `apps/web/src/app/api/webhooks/xendit/route.ts` - Add email notification
5. `apps/web/src/app/api/payments/cancel-subscription/route.ts` - Add cancellation email

---

## Summary

**Core Payment Flow**: ‚úÖ **WORKING**
- Invoice creation ‚úÖ
- Xendit checkout ‚úÖ
- Webhook processing ‚úÖ
- Database updates ‚úÖ

**User Experience**: ‚ö†Ô∏è **NEEDS INTEGRATION**
- No upgrade page
- Buttons don't connect to payment flow
- Premium status not in session

**Estimated Completion Time**: **4-7 hours** for must-have items

**Recommended Approach**: Build the upgrade page first, then fix session integration. Everything else can be done in parallel or post-launch.
