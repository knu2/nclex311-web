# Story 1.5.3.5: Page Integration & Route Migration

## Status

**Approved** - Ready for Development

---

## Story

**As a** logged-in user,  
**I want** the new sidebar navigation and modern layout to be visible when I use the application,  
**so that** I can benefit from the improved UX and easily navigate between concepts.

---

## Acceptance Criteria

1. **Create `/chapters` Route:**
   - New page at `apps/web/src/app/chapters/page.tsx`
   - Wrapped with `MainLayout` component
   - Displays temporary placeholder: "All Chapters View - Coming in Story 1.5.7"
   - Sidebar visible with ConceptList component
   - Becomes default landing for authenticated users (login redirects here)
   - Fully responsive (desktop: sidebar always visible, mobile: drawer)

2. **Integrate MainLayout into Concept Page:**
   - Update `apps/web/src/app/concepts/[slug]/page.tsx`
   - Wrap entire page content with `MainLayout` component
   - Pass `chapterId` and `currentConceptSlug` props to MainLayout
   - Remove standalone breadcrumbs (sidebar provides context)
   - ConceptViewer remains as inner content
   - Sidebar shows current chapter's concepts with active state

3. **Migrate or Deprecate Dashboard:**
   - Option A (Recommended): Redirect `/dashboard` → `/chapters`
   - Option B (Alternative): Update `/dashboard/page.tsx` to use MainLayout
   - Remove old tab-based navigation UI
   - Preserve chapter data fetching logic if needed

4. **Update Navigation References:**
   - Update login success redirect: `/dashboard` → `/chapters`
   - Update header logo link: → `/chapters` (or `/` if unauthenticated)
   - Update any hardcoded links to concepts: include proper chapter context
   - Update middleware protected routes list

5. **E2E Test Validation:**
   - All updated E2E tests pass (target: >90% pass rate)
   - Sidebar navigation tests pass (20 tests from sidebar-navigation.spec.ts)
   - Concept viewer tests pass (20 tests from concept-viewer.spec.ts)
   - Markdown rendering tests pass (14 tests from markdown-rendering.spec.ts)
   - Freemium flow tests pass (after 60-90 min update per FREEMIUM-FLOWS-UPDATE-REQUIRED.md)

6. **Design Consistency:**
   - All pages use consistent MainLayout
   - Sidebar behavior matches specification (desktop: permanent, mobile: drawer)
   - No visual regressions in existing functionality
   - Smooth transitions between pages

---

## Tasks / Subtasks

- [ ] **Create /chapters Route** (AC: 1)
  - [ ] Create new file `apps/web/src/app/chapters/page.tsx`
  - [ ] Import MainLayout component from `apps/web/src/components/Layout/MainLayout.tsx`
  - [ ] Import requireAuth utility from `apps/web/src/lib/auth-utils.ts`
  - [ ] Fetch user session using requireAuth()
  - [ ] Wrap page content with MainLayout, passing user session
  - [ ] Add placeholder content: "All Chapters View - Coming in Story 1.5.7"
  - [ ] Test sidebar renders correctly on /chapters route
  - [ ] Test responsive behavior (desktop sidebar, mobile drawer)

- [ ] **Integrate MainLayout into Concept Page** (AC: 2)
  - [ ] Read existing `apps/web/src/app/concepts/[slug]/page.tsx`
  - [ ] Import MainLayout component
  - [ ] Fetch concept data to get chapter_id
  - [ ] Wrap page content with MainLayout component
  - [ ] Pass chapterId and currentConceptSlug as props to MainLayout
  - [ ] Remove standalone breadcrumbs if present (sidebar provides context)
  - [ ] Keep ConceptViewer component as inner content
  - [ ] Test sidebar shows current chapter's concepts with active state on current concept
  - [ ] Test navigation between concepts via sidebar

- [ ] **Migrate Dashboard Route** (AC: 3)
  - [ ] Read existing `apps/web/src/app/dashboard/page.tsx`
  - [ ] Implement Option A (Recommended): Create simple redirect to `/chapters`
  - [ ] Alternative: If keeping dashboard, wrap with MainLayout component
  - [ ] Remove old tab-based navigation UI
  - [ ] Preserve any necessary chapter data fetching logic
  - [ ] Test dashboard redirect or MainLayout integration

- [ ] **Update Navigation References** (AC: 4)
  - [ ] Update LoginForm component: change success redirect from `/dashboard` to `/chapters`
  - [ ] Update AuthLayout/Header: logo link should point to `/chapters` (authenticated) or `/` (public)
  - [ ] Search codebase for hardcoded `/dashboard` references and update to `/chapters`
  - [ ] Update `apps/web/middleware.ts`: ensure `/chapters` is in PROTECTED_ROUTES array
  - [ ] Test all navigation flows work correctly

- [ ] **Run E2E Test Suite** (AC: 5)
  - [ ] Run full Playwright E2E test suite: `npx playwright test`
  - [ ] Verify sidebar-navigation.spec.ts tests pass (20 tests)
  - [ ] Verify concept-viewer.spec.ts tests pass (20 tests)
  - [ ] Verify markdown-rendering.spec.ts tests pass (14 tests)
  - [ ] Document test results (target: >90% pass rate, ~54/60 tests)
  - [ ] If freemium tests fail, note that they need 60-90 min update per FREEMIUM-FLOWS-UPDATE-REQUIRED.md

- [ ] **Write/Update Unit Tests** (AC: 1, 2, 6)
  - [ ] Unit test: /chapters route renders with MainLayout
  - [ ] Unit test: Concept page renders with MainLayout
  - [ ] Unit test: Sidebar displays in MainLayout on both routes
  - [ ] Integration test: Navigation between pages preserves layout state
  - [ ] Integration test: Mobile drawer opens/closes correctly
  - [ ] Integration test: Desktop sidebar always visible
  - [ ] Regression test: Existing functionality works with new layout

- [ ] **Visual Regression Check** (AC: 6)
  - [ ] Manually test all pages for visual consistency
  - [ ] Verify no layout breaks or missing elements
  - [ ] Test smooth transitions between pages
  - [ ] Verify responsive behavior at all breakpoints
  - [ ] Check that sidebar state persists during navigation

---

## Dev Notes

### Priority and Dependencies

**Priority:** P0 (Critical - Blocks E2E tests)  
**Estimated Effort:** 4-6 hours

**Dependencies:**
- ✅ Story 1.5.1: Sidebar Navigation Component - Complete
- ✅ Story 1.5.2: Main Layout Shell - Complete
- ✅ Story 1.5.3: Concept Viewer - Complete
- ✅ Story 1.5.3.3: Public Pages - Must complete first

**Blocks:**
- Story 1.5.7: Chapter Grid Component (depends on `/chapters` route existing)
- All remaining Epic 1.5 stories (depend on MainLayout integration)

### Source Tree Information

**New Files to Create:**
```
apps/web/src/app/chapters/page.tsx       # New chapters overview route
```

**Files to Modify:**
```
apps/web/src/app/concepts/[slug]/page.tsx    # Wrap with MainLayout
apps/web/src/app/dashboard/page.tsx          # Redirect or wrap with MainLayout
apps/web/src/components/LoginForm.tsx        # Update success redirect
apps/web/middleware.ts                       # Update protected routes
```

**Existing Components to Use:**
```
apps/web/src/components/Layout/MainLayout.tsx    ✅ Exists (Story 1.5.2)
apps/web/src/components/Sidebar/ConceptList.tsx  ✅ Exists (Story 1.5.1)
apps/web/src/components/Concept/ConceptViewer.tsx ✅ Exists (Story 1.5.3)
apps/web/src/lib/auth-utils.ts                   ✅ Exists (Story 1.4)
```

### Architecture References

**MainLayout Component Interface:**
```typescript
// From Story 1.5.2
interface MainLayoutProps {
  user: {
    id: string;
    email: string;
    isPremium: boolean;
  };
  chapterId?: string;              // Optional: highlights chapter in sidebar
  currentConceptSlug?: string;      // Optional: highlights current concept
  children: React.ReactNode;
}
```

**Auth Utils:**
```typescript
// From Story 1.4
import { requireAuth } from '@/lib/auth-utils';

// Usage in Server Components:
const session = await requireAuth();
// Returns: { user: { id, email, isPremium } }
// Automatically redirects to /login if not authenticated
```

**Routing:**
- Next.js 15.5.x App Router with Server Components
- All new pages are Server Components by default
- Client components needed only for interactive UI (marked with 'use client')

### Component Implementation Examples

**Chapters Route:**
```typescript
// apps/web/src/app/chapters/page.tsx
import { MainLayout } from '@/components/Layout/MainLayout';
import { requireAuth } from '@/lib/auth-utils';
import { Box, Typography } from '@mui/material';

export default async function ChaptersPage() {
  const session = await requireAuth();
  
  return (
    <MainLayout user={session.user}>
      <Box sx={{ p: 4 }}>
        <Typography variant="h1" gutterBottom>
          All NCLEX 311 Chapters
        </Typography>
        <Typography variant="body1" color="text.secondary">
          Chapter grid view coming in Story 1.5.7
        </Typography>
      </Box>
    </MainLayout>
  );
}
```

**Concept Page Integration:**
```typescript
// apps/web/src/app/concepts/[slug]/page.tsx
import { MainLayout } from '@/components/Layout/MainLayout';
import { ConceptViewer } from '@/components/Concept/ConceptViewer';
import { requireAuth } from '@/lib/auth-utils';
import { getConceptBySlug } from '@/lib/api';

export default async function ConceptPage({ 
  params 
}: { 
  params: { slug: string } 
}) {
  const session = await requireAuth();
  
  // Fetch concept to get chapter ID for sidebar highlighting
  const concept = await getConceptBySlug(params.slug);
  
  if (!concept) {
    notFound();
  }
  
  return (
    <MainLayout 
      user={session.user}
      chapterId={concept.chapter_id}
      currentConceptSlug={params.slug}
    >
      <ConceptViewer conceptSlug={params.slug} />
    </MainLayout>
  );
}
```

**Dashboard Migration - Option A (Recommended):**
```typescript
// apps/web/src/app/dashboard/page.tsx
import { redirect } from 'next/navigation';

export default function DashboardPage() {
  redirect('/chapters');
}
```

**Dashboard Migration - Option B (Alternative):**
```typescript
// apps/web/src/app/dashboard/page.tsx
import { MainLayout } from '@/components/Layout/MainLayout';
import { requireAuth } from '@/lib/auth-utils';
// ... existing dashboard components

export default async function DashboardPage() {
  const session = await requireAuth();
  
  return (
    <MainLayout user={session.user}>
      {/* Existing dashboard content, minus old tab navigation */}
    </MainLayout>
  );
}
```

**Middleware Update:**
```typescript
// apps/web/middleware.ts
const PROTECTED_ROUTES = [
  '/chapters',      // NEW - add this
  '/concepts',
  '/dashboard',
  '/profile',
  '/api/user',
];

// Rest of middleware logic remains the same
```

**LoginForm Update:**
```typescript
// apps/web/src/components/LoginForm.tsx
// Find the success redirect logic and change:
// OLD: router.push('/dashboard');
// NEW: router.push('/chapters');
```

### E2E Test Integration

**Test Files Updated by Quinn (Story 1.5.1-1.5.3):**
```
apps/web/e2e/sidebar-navigation.spec.ts      # 20 tests
apps/web/e2e/concept-viewer.spec.ts          # 20 tests
apps/web/e2e/markdown-rendering.spec.ts      # 14 tests
apps/web/e2e/freemium-flows.spec.ts          # Needs 60-90 min update
```

**Quinn's Reports:**
- `apps/web/e2e/QUINN-E2E-UPDATE-REPORT.md` - Tests already updated for sidebar navigation
- `apps/web/e2e/QUINN-UPDATE-IMPLEMENTATION-GAP.md` - Documents integration gap this story fixes
- `apps/web/e2e/FREEMIUM-FLOWS-UPDATE-REQUIRED.md` - Freemium tests need tab→sidebar update

**Expected Test Results After This Story:**
- Before integration: 0/42 tests passing (components not integrated)
- After integration: ~54/60 tests passing (>90% pass rate)
- Freemium tests: May need separate update (documented in freemium flows report)

### Testing

#### Unit Test Locations:
```
apps/web/__tests__/pages/chapters.test.tsx
apps/web/__tests__/pages/concepts/[slug].test.tsx
apps/web/__tests__/integration/layout-navigation.test.tsx
apps/web/__tests__/integration/responsive-layout.test.tsx
```

#### Testing Standards:
- **Test Framework:** Jest + React Testing Library
- **E2E Framework:** Playwright 1.55.x
- **Coverage Requirement:** Maintain existing 80% coverage
- **Test Naming:** `*.test.tsx` for unit tests, `*.spec.ts` for E2E tests

#### Key Test Scenarios:
1. `/chapters` route renders with MainLayout and sidebar
2. Concept pages wrapped with MainLayout showing correct chapter in sidebar
3. Sidebar navigation works (clicking concept → navigates to concept page)
4. Mobile drawer opens/closes correctly
5. Desktop sidebar always visible
6. Login redirects to `/chapters` instead of `/dashboard`
7. No visual regressions in existing pages
8. E2E test suite achieves >90% pass rate

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Story created from SCP-2025-002 Section 6 | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used

_(To be populated by Dev Agent)_

### Debug Log References

_(To be populated by Dev Agent)_

### Completion Notes List

_(To be populated by Dev Agent)_

### File List

_(To be populated by Dev Agent)_

---

## QA Results

_(To be populated by QA Agent after implementation)_
