# Story 1.5.11: Reference Section Display

## Status
**Draft**

## Story
**As a** user,  
**I want** to see bibliographic references for concept content,  
**so that** I can identify the source materials and access them for deeper learning.

**Note:** This story addresses a gap identified during stakeholder testing - the Reference section visible in the approved mockup (`scratchpad/sample_chapter_demo_v23.html`) was not documented in the UX redesign summary and therefore not implemented in Stories 1.5.3 and 1.5.4.

## Acceptance Criteria
1. A "ðŸ“š Reference" section displays after the Key Points section and before Connection cards.
2. The Reference section only appears when the concept has reference data (conditional rendering).
3. Reference text is displayed as plain text with appropriate styling:
   - Light gray background (#f8f9fc)
   - Section heading: "ðŸ“š Reference" (H4, primary blue #2c5aa0)
   - Citation text: Secondary color (#6c757d), 14px (0.9rem)
4. The section follows the design specifications from `docs/ux-redesign-summary.md` Section 9.
5. Reference data is fetched from the concept API endpoint.
6. Text is rendered with newlines preserved (multi-line citations supported).
7. The section is responsive and mobile-friendly.
8. Accessibility: Proper semantic HTML and ARIA labels if needed.

## Optional Enhancement (Nice-to-Have)
- **Enhanced Rendering:** Automatically detect and italicize book titles using regex pattern matching to match the mockup styling exactly (see mockup: "Quick Reference to Triage" is italicized).

## Tasks / Subtasks

- [ ] Task 1: Add Database Schema Field (AC: 5) **[BLOCKER]**
  - [ ] Add migration to create `reference` column on `concepts` table (TEXT, nullable)
  - [ ] Update Drizzle schema (`apps/web/src/lib/db/schema/content.ts`)
  - [ ] Add `reference` field to `Concept` TypeScript type
  - [ ] Run migration in development database
  - [ ] Verify field exists and accepts null values
  
- [ ] Task 2: Update API to Return Reference Data (AC: 5)
  - [ ] Update ContentService to include `reference` field in query
  - [ ] Update API response type to include `reference?: string`
  - [ ] Test API endpoint returns reference data when available
  - [ ] Test API endpoint returns null/undefined when no reference
  
- [ ] Task 3: Create ReferenceSection Component (AC: 1, 3, 4, 6, 7, 8)
  - [ ] Create `src/components/Concept/ReferenceSection.tsx` component file
  - [ ] Add TypeScript interface: `interface ReferenceSectionProps { reference?: string; }`
  - [ ] Implement conditional rendering (only show if reference data exists)
  - [ ] Apply styling per UX redesign specs (background, padding, colors)
  - [ ] Add section heading with ðŸ“š emoji icon
  - [ ] Render reference text with newlines preserved (`white-space: pre-line`)
  - [ ] Make component responsive (mobile padding adjustments)
  - [ ] Add proper semantic HTML (section element, heading hierarchy)
  
- [ ] Task 4: Integrate ReferenceSection into ConceptViewer (AC: 1, 2)
  - [ ] Import ReferenceSection component into ConceptViewer
  - [ ] Position component after Key Points, before Connection cards
  - [ ] Pass `reference` prop from concept data
  - [ ] Verify conditional rendering works (shows/hides appropriately)
  - [ ] Test layout doesn't break when reference is missing
  
- [ ] Task 5: Add Unit Tests
  - [ ] Test ReferenceSection renders when reference data provided
  - [ ] Test ReferenceSection does NOT render when reference is null/undefined
  - [ ] Test section heading displays correctly
  - [ ] Test reference text renders with correct styling
  - [ ] Test multi-line references display properly
  - [ ] Test responsive behavior (mobile/desktop)
  - [ ] Test accessibility (semantic HTML, proper heading level)
  
- [ ] Task 6: Add Integration Tests
  - [ ] Test ConceptViewer displays reference section for concepts with data
  - [ ] Test ConceptViewer hides reference section for concepts without data
  - [ ] Test reference section positioning (after Key Points, before connections)
  - [ ] Spot-check 5+ concepts to verify correct rendering
  
- [ ] Task 7: Populate Reference Data (AC: 5) **[DATA PREREQUISITE]**
  - [ ] Coordinate with data team to extract reference data from source
  - [ ] Create data migration script to populate existing concepts
  - [ ] Verify at least one test concept has reference data for testing
  - [ ] Document data format expectations

## Dev Notes

### Previous Story Insights
- Story 1.5.3 (Concept Viewer) completed: Displays concept content with Key Points [Source: Story 1.5.3]
- Story 1.5.4 (Inline Quiz) completed: Quiz interaction with rationale and key points [Source: Story 1.5.4]
- Reference section was in approved mockup but omitted from stories [Source: Stakeholder Testing]

### Component Location
**File Path:** `apps/web/src/components/Concept/ReferenceSection.tsx`

**Project Structure:**
```plaintext
apps/web/src/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ components/             # React components
â”‚   â””â”€â”€ Concept/           # Concept-related components
â”‚       â”œâ”€â”€ ConceptViewer.tsx    # Parent component
â”‚       â””â”€â”€ ReferenceSection.tsx # This story's new component
â””â”€â”€ lib/                    # Utility libraries
    â””â”€â”€ db/
        â””â”€â”€ schema/
            â””â”€â”€ content.ts  # Database schema to update
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router [Source: architecture/tech-stack.md]
- **UI Component Library:** MUI (Material-UI) ~5.x [Source: architecture/tech-stack.md]
- **TypeScript:** ~5.x with strict mode enabled [Source: architecture/tech-stack.md]
- **Database ORM:** Drizzle ORM [Source: architecture/tech-stack.md]
- **Database:** PostgreSQL (Vercel Postgres) [Source: architecture/tech-stack.md]

### MUI Components to Use
- **Box:** Container and spacing
- **Typography:** Text styling with variants (h4 for heading, body2 for citation)
- **Paper:** Optional - section background (or use Box with sx styling)

### Database Schema Change

**Migration SQL:**
```sql
-- Add reference column to concepts table
ALTER TABLE concepts ADD COLUMN reference TEXT;
```

**Drizzle Schema Update:**
```typescript
// apps/web/src/lib/db/schema/content.ts
export const concepts = pgTable('concepts', {
  // ... existing fields
  reference: text('reference'),  // Add this line
});
```

**TypeScript Type Update:**
```typescript
export type Concept = typeof concepts.$inferSelect;
// Will automatically include: reference?: string | null
```

### API Specifications

**Endpoint:** `GET /api/concepts/{slug}`

**Updated Response Format:**
```typescript
{
  id: string;
  title: string;
  slug: string;
  concept_number: number;
  content: string;
  key_points: string;
  reference: string | null;  // NEW FIELD
  chapter_id: string;
  is_premium: boolean;
  questions: [...];
}
```

### Styling Guidelines
[Source: docs/ux-redesign-summary.md, Section 9]

**Reference Section Styling:**
```typescript
const referenceSectionStyle = {
  backgroundColor: '#f8f9fc',
  borderRadius: '6px',
  padding: { xs: '1rem', sm: '1.25rem' },  // 16px mobile, 20px desktop
  marginTop: '1.5rem',
  marginBottom: '1.5rem',
};

const headingStyle = {
  color: '#2c5aa0',  // Primary blue
  fontSize: '1rem',
  fontWeight: 600,
  marginBottom: '0.75rem',
};

const citationTextStyle = {
  color: '#6c757d',  // Text secondary
  fontSize: '0.9rem',
  fontWeight: 400,
  lineHeight: 1.6,
  whiteSpace: 'pre-line',  // Preserve newlines
};
```

**Component Structure:**
```typescript
// apps/web/src/components/Concept/ReferenceSection.tsx
import React from 'react';
import { Box, Typography } from '@mui/material';

interface ReferenceSectionProps {
  reference?: string | null;
}

export const ReferenceSection: React.FC<ReferenceSectionProps> = ({ reference }) => {
  // Don't render if no reference data
  if (!reference) return null;

  return (
    <Box
      component="section"
      aria-label="Bibliographic reference"
      sx={{
        backgroundColor: '#f8f9fc',
        borderRadius: '6px',
        padding: { xs: '1rem', sm: '1.25rem' },
        marginTop: '1.5rem',
        marginBottom: '1.5rem',
      }}
    >
      <Typography
        variant="h4"
        component="h4"
        sx={{
          color: '#2c5aa0',
          fontSize: '1rem',
          fontWeight: 600,
          marginBottom: '0.75rem',
        }}
      >
        ðŸ“š Reference
      </Typography>
      <Typography
        variant="body2"
        sx={{
          color: '#6c757d',
          fontSize: '0.9rem',
          lineHeight: 1.6,
          whiteSpace: 'pre-line',
        }}
      >
        {reference}
      </Typography>
    </Box>
  );
};
```

### Data Format

**Database Storage:**
```
Plain text with newlines (no markdown)

Example:
"Grossman, Valerie, G.A. Quick Reference to Triage\nPhiladelphia, Lippincott Williams and Wilkins"
```

**Rendered Output:**
```
ðŸ“š Reference

Grossman, Valerie, G.A. Quick Reference to Triage
Philadelphia, Lippincott Williams and Wilkins
```

### Optional Enhancement: Italicized Book Titles

If time permits, implement pattern matching to italicize book titles:

```typescript
// Enhanced version with regex for book title detection
const renderReference = (reference: string) => {
  // Pattern: Author name, followed by book title (after period), followed by publisher
  // This is a simple heuristic - adjust based on actual data patterns
  
  const lines = reference.split('\n');
  if (lines.length < 2) {
    return <Typography>{reference}</Typography>;
  }
  
  // Line 1: Author + Title (italicize text after last period before newline)
  const firstLine = lines[0];
  const lastPeriodIndex = firstLine.lastIndexOf('.');
  
  if (lastPeriodIndex > 0) {
    const author = firstLine.substring(0, lastPeriodIndex + 1);
    const title = firstLine.substring(lastPeriodIndex + 1).trim();
    
    return (
      <>
        <Typography component="span">{author} </Typography>
        <Typography component="span" sx={{ fontStyle: 'italic' }}>{title}</Typography>
        <br />
        {lines.slice(1).map((line, idx) => (
          <Typography key={idx} component="span">
            {line}
            {idx < lines.length - 2 && <br />}
          </Typography>
        ))}
      </>
    );
  }
  
  return <Typography sx={{ whiteSpace: 'pre-line' }}>{reference}</Typography>;
};
```

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.3 (Concept Viewer):** Integrated into ConceptViewer after Key Points
2. **Story 1.5.4 (Inline Quiz):** Appears after quiz feedback sections
3. **Database (Story 1.3):** Requires new `reference` field in concepts table

### TypeScript Interfaces

**Component Props:**
```typescript
interface ReferenceSectionProps {
  reference?: string | null;
}
```

**Updated ConceptViewer Props:**
```typescript
// No changes needed - concept data already includes all fields
interface ConceptData {
  id: string;
  title: string;
  slug: string;
  concept_number: number;
  content: string;
  key_points: string;
  reference?: string;  // NEW - optional field
  chapter_id: string;
  is_premium: boolean;
  questions: Question[];
}
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Concept/ReferenceSection.test.tsx`

**Testing Standards:** [Source: architecture/coding-standards.md]
- **Framework:** Jest 30.x + React Testing Library 16.x
- **Focus:** Test conditional rendering and text display
- **Mock:** Reference data

**Required Test Cases:**

1. **Rendering Tests:**
   - Component renders when reference prop is provided
   - Component does NOT render when reference is null
   - Component does NOT render when reference is undefined
   - Component does NOT render when reference is empty string
   - Section heading displays correctly
   - Reference text displays correctly

2. **Content Tests:**
   - Single-line references render correctly
   - Multi-line references render with preserved newlines
   - Long references wrap appropriately
   - Special characters in references display correctly

3. **Styling Tests:**
   - Background color matches spec (#f8f9fc)
   - Heading color matches spec (#2c5aa0)
   - Citation text color matches spec (#6c757d)
   - Border radius applied correctly
   - Padding applied correctly (responsive)

4. **Accessibility Tests:**
   - Semantic HTML structure (section element)
   - Proper heading hierarchy (h4)
   - ARIA label present
   - Text readable by screen readers

**Testing Pattern Example:**
```typescript
import { render, screen } from '@testing-library/react';
import { ReferenceSection } from '@/components/Concept/ReferenceSection';

describe('ReferenceSection', () => {
  it('renders reference section when reference data provided', () => {
    const reference = 'Grossman, Valerie, G.A. Quick Reference to Triage\nPhiladelphia, Lippincott Williams and Wilkins';
    
    render(<ReferenceSection reference={reference} />);
    
    expect(screen.getByText('ðŸ“š Reference')).toBeInTheDocument();
    expect(screen.getByText(/Grossman, Valerie/)).toBeInTheDocument();
    expect(screen.getByText(/Philadelphia, Lippincott/)).toBeInTheDocument();
  });
  
  it('does NOT render when reference is null', () => {
    render(<ReferenceSection reference={null} />);
    
    expect(screen.queryByText('ðŸ“š Reference')).not.toBeInTheDocument();
  });
  
  it('does NOT render when reference is undefined', () => {
    render(<ReferenceSection reference={undefined} />);
    
    expect(screen.queryByText('ðŸ“š Reference')).not.toBeInTheDocument();
  });
  
  it('preserves multi-line formatting', () => {
    const reference = 'Line 1\nLine 2\nLine 3';
    
    const { container } = render(<ReferenceSection reference={reference} />);
    
    const textElement = container.querySelector('[style*="white-space: pre-line"]');
    expect(textElement).toBeInTheDocument();
    expect(textElement?.textContent).toBe('Line 1\nLine 2\nLine 3');
  });
  
  it('applies correct background color', () => {
    const reference = 'Test reference';
    
    const { container } = render(<ReferenceSection reference={reference} />);
    
    const section = container.querySelector('section');
    expect(section).toHaveStyle({ backgroundColor: '#f8f9fc' });
  });
});
```

### Positioning in ConceptViewer

**Current Structure (after Stories 1.5.3 and 1.5.4):**
```jsx
<ConceptViewer>
  {/* Concept content */}
  <ReadThisSection />
  
  {/* Separator */}
  <AnswerThisSection />
  
  {/* Quiz and feedback */}
  <InlineQuiz />
  
  {/* After answering: */}
  <RationaleSection />
  <KeyPointsSection />
  
  {/* NEW - Add here: */}
  <ReferenceSection reference={conceptData.reference} />
  
  {/* Then existing: */}
  <ConnectionCards />
  <ActionButtons />
</ConceptViewer>
```

### Blockers & Dependencies

**Blockers:**
1. **Database Migration (Task 1):** Must be completed before any development
2. **Reference Data Population (Task 7):** At least one test concept needs reference data

**Dependencies:**
- Story 1.5.3 (Concept Viewer) - **COMPLETE**
- Story 1.5.4 (Inline Quiz) - **COMPLETE**
- Story 1.3 (Database Import) - **COMPLETE** (but needs data update)

**Coordination Needed:**
- **Data Team:** Extract reference data from original source (extracted-content branch)
- **Backend/DevOps:** Apply database migration to development, staging, production

### Estimated Effort
- **Development:** 4-6 hours
  - Database migration & schema update: 1 hour
  - Component creation: 2 hours
  - Integration & testing: 2 hours
  - Optional enhancement: 1 hour
- **Data Population:** 2-4 hours (data team)
- **Total:** 1 day

### Definition of Done
- [ ] Database migration applied and verified
- [ ] Drizzle schema updated with `reference` field
- [ ] API returns `reference` field in concept response
- [ ] ReferenceSection component created and styled per spec
- [ ] Component integrated into ConceptViewer in correct position
- [ ] Conditional rendering works (shows/hides appropriately)
- [ ] Unit tests written and passing (minimum 8 tests)
- [ ] Integration tests passing
- [ ] Reference data populated for at least 5 test concepts
- [ ] Code linted and formatted
- [ ] Manual testing completed in dev environment
- [ ] Story marked "Ready for Review"

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-07 | 1.0 | Initial story creation - Reference Section feature | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent during implementation*

### Debug Log References
*To be populated by Dev Agent during implementation*

### Completion Notes List
*To be populated by Dev Agent during implementation*

### File List
*To be populated by Dev Agent during implementation*

## QA Results
*This section will be populated by QA Agent after implementation*
