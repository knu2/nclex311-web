# Story 1.5.9: Bookmarks View

## Status
**Draft**

## Story
**As a** logged-in user,  
**I want** to bookmark concepts and view all my bookmarked concepts with my notes,  
**so that** I can quickly review important topics.

**Note:** This story incorporates bookmarking backend functionality (originally Story 2.2 from Epic 2). It includes both the bookmark button on concept pages and the Bookmarks View dashboard.

## Acceptance Criteria
1. A dedicated route `/dashboard/bookmarks` displays all bookmarked concepts.
2. The view shows a grid of bookmark cards, each displaying:
   - Concept title and chapter
   - Personal note preview (first 100 characters)
   - Quick-action buttons: "View", "Edit Note", "Remove Bookmark"
3. Users can:
   - Click "View" to navigate to the concept
   - Click "Edit Note" to open Notes Modal (Story 1.5.5)
   - Click "Remove Bookmark" to unbookmark (with confirmation)
4. Empty state message if no bookmarks exist ("Start bookmarking concepts...").
5. The grid is responsive (3 columns desktop, 2 tablet, 1 mobile).
6. Bookmarks are sorted by most recently bookmarked.
7. Uses MUI components (Grid, Card, Button, Typography).
8. Meets accessibility standards.

### Backend Functionality (Incorporated from Story 2.2)
9. **Bookmark Button:**
   - A bookmark icon/button is present on each concept page
   - Button toggles between bookmarked and unbookmarked states
   - Clicking saves/removes the bookmark
   - Visual indicator shows bookmarked status (filled vs outline icon)
   - Bookmarked state persists across sessions
   - Button is accessible to all logged-in users (free and premium)
   
10. **Bookmarking API:**
   - API endpoint to create bookmark: `POST /api/bookmarks`
   - API endpoint to remove bookmark: `DELETE /api/bookmarks/{id}`
   - API endpoint to fetch user bookmarks: `GET /api/users/{id}/bookmarks`
   - Bookmarks integrate with notes from Story 1.5.5
   
11. **Database Schema:**
   - Table to store bookmark records
   - Tracks concept_id, user_id, bookmarked_at timestamp
   - Supports querying bookmarks with concept details

## Tasks / Subtasks

### Backend Implementation Tasks (Incorporated from Story 2.2)

- [ ] Task 0.1: Create Database Schema for Bookmarks
  - [ ] Create `bookmarks` table
  - [ ] Fields: id, user_id, concept_id, bookmarked_at (timestamp)
  - [ ] Add indexes for user_id and concept_id lookups
  - [ ] Add UNIQUE constraint on (user_id, concept_id)
  - [ ] Create database migration
  - [ ] Update schema exports

- [ ] Task 0.2: Create Bookmarking API Endpoints
  - [ ] Create `POST /api/bookmarks` endpoint
    - [ ] Validate user authentication
    - [ ] Accept concept_id in request body
    - [ ] Insert bookmark record
    - [ ] Return success response with bookmark id
    - [ ] Handle duplicate bookmark attempts (upsert or return existing)
  - [ ] Create `DELETE /api/bookmarks/{id}` endpoint
    - [ ] Validate user authentication
    - [ ] Verify bookmark belongs to user
    - [ ] Delete bookmark record
    - [ ] Return success response

- [ ] Task 0.3: Create Bookmarks List API Endpoint
  - [ ] Create `GET /api/users/{id}/bookmarks` endpoint
  - [ ] Fetch all user bookmarks
  - [ ] Join with concepts and chapters data
  - [ ] Join with notes table for note preview
  - [ ] Sort by most recent (bookmarked_at DESC)
  - [ ] Format response matching TypeScript interface (lines 125-141)
  - [ ] Handle empty bookmarks list

- [ ] Task 0.4: Add Bookmark Button to Concept Viewer
  - [ ] Add bookmark icon button to ConceptViewer header
  - [ ] Fetch bookmark status on page load
  - [ ] Toggle button state based on bookmark status
  - [ ] Handle button click (call POST or DELETE endpoint)
  - [ ] Show loading state during API call
  - [ ] Update button state after successful API call
  - [ ] Show success/error toast message
  - [ ] Use filled bookmark icon for bookmarked, outline for unbookmarked
  - [ ] Style button with MUI IconButton component

- [ ] Task 0.5: Update Sidebar to Show Bookmark Indicators (Optional)
  - [ ] Display bookmark icon on bookmarked concepts in sidebar
  - [ ] Update when concept is bookmarked/unbookmarked
  - [ ] Add subtle visual indicator (small star or bookmark icon)

- [ ] Task 1: Create Bookmarks View Page (AC: 1)
  - [ ] Create `src/app/dashboard/bookmarks/page.tsx` page file
  - [ ] Set up page layout with MainLayout wrapper
  - [ ] Add page title and description
  - [ ] Configure routing
  - [ ] Add navigation link in user menu/header
  
- [ ] Task 2: Create BookmarksView Component (AC: 2, 5, 7)
  - [ ] Create `src/components/Dashboard/BookmarksView.tsx` component
  - [ ] Use MUI Grid component for responsive layout
  - [ ] Configure grid columns (3 desktop, 2 tablet, 1 mobile)
  - [ ] Add proper TypeScript interfaces
  
- [ ] Task 3: Build BookmarkCard Component (AC: 2, 7)
  - [ ] Create BookmarkCard component using MUI Card
  - [ ] Display concept title
  - [ ] Display chapter name/number
  - [ ] Show note preview (first 100 chars with ellipsis)
  - [ ] Style card to match brand guidelines
  
- [ ] Task 4: Add Quick Action Buttons (AC: 2, 3)
  - [ ] Add "View" button with link icon
  - [ ] Add "Edit Note" button with edit icon
  - [ ] Add "Remove Bookmark" button with delete icon
  - [ ] Style buttons with MUI IconButton or Button
  
- [ ] Task 5: Implement View Navigation (AC: 3)
  - [ ] Add onClick handler to "View" button
  - [ ] Navigate to `/concepts/{slug}` on click
  - [ ] Use Next.js router for navigation
  
- [ ] Task 6: Integrate with Notes Modal (AC: 3)
  - [ ] Import NotesModal component from Story 1.5.5
  - [ ] Open modal on "Edit Note" button click
  - [ ] Pass concept ID and title to modal
  - [ ] Handle modal close and refresh bookmark
  
- [ ] Task 7: Implement Remove Bookmark Functionality (AC: 3)
  - [ ] Show confirmation dialog on "Remove Bookmark" click
  - [ ] Call delete API endpoint on confirmation
  - [ ] Remove bookmark card from grid after deletion
  - [ ] Show success message
  
- [ ] Task 8: Add Empty State (AC: 4)
  - [ ] Create empty state component
  - [ ] Display message: "Start bookmarking concepts..."
  - [ ] Add illustration or icon (optional)
  - [ ] Show "Browse Chapters" button
  
- [ ] Task 9: Fetch Bookmarks Data from API (AC: 6)
  - [ ] Call `GET /api/users/{id}/bookmarks` endpoint
  - [ ] Handle loading state (skeleton cards)
  - [ ] Handle error state
  - [ ] Sort bookmarks by most recent
  - [ ] Map API data to component props
  
- [ ] Task 10: Implement Accessibility Features & Add Unit Tests (AC: 8)
  - [ ] Add ARIA labels for cards and buttons
  - [ ] Ensure keyboard navigation works
  - [ ] Add focus indicators
  - [ ] Test with screen readers
  - [ ] Add unit tests for all functionality

## Dev Notes

### Previous Story Insights
- Story 1.5.2 (Main Layout) completed: Provides layout wrapper [Source: Epic 1.5]
- Story 1.5.5 (Notes Modal) completed: Modal available for editing notes [Source: Epic 1.5]
- Story 1.5.3 (Concept Viewer) completed: Component available for adding bookmark button [Source: Epic 1.5]

### Backend Scope (Incorporated from Epic 2, Story 2.2)
This story includes full backend implementation for bookmarking:
- Database table for storing bookmark records
- API endpoints for creating/removing bookmarks
- Bookmarks list API endpoint for dashboard
- Bookmark button on concept pages
- Optional bookmark indicators in sidebar

### Component Location
**Files:**
- Page: `apps/web/src/app/dashboard/bookmarks/page.tsx`
- Component: `apps/web/src/components/Dashboard/BookmarksView.tsx`
- Card: `apps/web/src/components/Dashboard/BookmarkCard.tsx`

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled

### MUI Components to Use
- **Grid:** Responsive grid layout
- **Card/CardContent/CardActions:** Bookmark card
- **Button/IconButton:** Quick action buttons
- **Typography:** Text styling
- **Chip:** Chapter badge
- **Dialog:** Confirmation dialog for remove
- **Box:** Layout and spacing

### API Specifications
[Source: Epic 1.5, Story 2.2 Backend]

**Endpoint:** `GET /api/users/{id}/bookmarks`

**Response Format:**
```typescript
{
  bookmarks: [
    {
      id: string;
      user_id: string;
      concept_id: string;
      concept_title: string;
      concept_slug: string;
      chapter_number: number;
      chapter_title: string;
      note_preview: string;  // First 100 chars of note
      bookmarked_at: timestamp;
    }
  ]
}
```

**Remove Bookmark:** `DELETE /api/bookmarks/{id}`
```typescript
Response:
{
  success: boolean;
}
```

### Responsive Grid Configuration
```typescript
<Grid container spacing={3}>
  {bookmarks.map((bookmark) => (
    <Grid 
      item 
      xs={12}      // Mobile: 1 column
      sm={6}       // Tablet: 2 columns
      md={4}       // Desktop: 3 columns
      key={bookmark.id}
    >
      <BookmarkCard bookmark={bookmark} />
    </Grid>
  ))}
</Grid>
```

### BookmarkCard Implementation
```typescript
<Card elevation={2} sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
  <CardContent sx={{ flexGrow: 1 }}>
    <Typography variant="h6" gutterBottom>
      {bookmark.concept_title}
    </Typography>
    <Chip 
      label={`Chapter ${bookmark.chapter_number}`} 
      size="small" 
      sx={{ mb: 1 }} 
    />
    {bookmark.note_preview && (
      <Typography variant="body2" color="textSecondary">
        {bookmark.note_preview}...
      </Typography>
    )}
  </CardContent>
  <CardActions>
    <IconButton aria-label="view concept" onClick={handleView}>
      <VisibilityIcon />
    </IconButton>
    <IconButton aria-label="edit note" onClick={handleEditNote}>
      <EditIcon />
    </IconButton>
    <IconButton aria-label="remove bookmark" onClick={handleRemove}>
      <DeleteIcon />
    </IconButton>
  </CardActions>
</Card>
```

### Empty State Component
```typescript
<Box 
  sx={{ 
    display: 'flex', 
    flexDirection: 'column', 
    alignItems: 'center', 
    justifyContent: 'center',
    minHeight: '400px',
    textAlign: 'center'
  }}
>
  <BookmarkBorderIcon sx={{ fontSize: 80, color: 'text.secondary', mb: 2 }} />
  <Typography variant="h5" gutterBottom>
    No Bookmarks Yet
  </Typography>
  <Typography variant="body1" color="textSecondary" sx={{ mb: 3 }}>
    Start bookmarking concepts to quickly access them later
  </Typography>
  <Button 
    variant="contained" 
    component={Link} 
    href="/chapters"
  >
    Browse Chapters
  </Button>
</Box>
```

### Remove Confirmation Dialog
```typescript
<Dialog open={confirmOpen} onClose={handleCancelRemove}>
  <DialogTitle>Remove Bookmark?</DialogTitle>
  <DialogContent>
    <DialogContentText>
      Are you sure you want to remove this bookmark? Your note will be preserved.
    </DialogContentText>
  </DialogContent>
  <DialogActions>
    <Button onClick={handleCancelRemove}>Cancel</Button>
    <Button onClick={handleConfirmRemove} color="error">
      Remove
    </Button>
  </DialogActions>
</Dialog>
```

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**View Design:** [Source: front-end-spec.md, View: Bookmarks Grid]

**Page Header:**
- Title: "üîñ My Bookmarks" (H1, 28px, 600 weight, centered)
- Subtitle: "Your saved concepts for quick reference and review" (text secondary #6c757d)
- Back button: "‚Üê Back to Current Chapter" (blue #2c5aa0)

**Bookmark Stats Grid:**
- Grid: 4 columns desktop, 2x2 mobile
- Background: Light gray (#f8f9fc)
- Border radius: 8px
- Padding: 1.5rem (24px)
- Icons: 28px, accent orange (‚≠ê #ff6b35)
- Numbers: 24px, 600 weight

**Filter Buttons:**
- Pills: Border radius 20px (fully rounded)
- Active: Blue background (#2c5aa0), white text
- Inactive: Border 2px #e1e7f0, text secondary (#6c757d)
- Hover: Light blue background (#e8f0fe)
- Height: 40px
- Padding: 12px 24px
- Gap: 8px between buttons

**Bookmark Cards:**
- Background: White
- Border: 2px solid #e1e7f0
- Border radius: 8px
- Padding: 1.5rem (24px)
- Shadow on hover: 0 4px 12px rgba(0,0,0,0.1)
- Transition: 150ms ease-out
- Min height: 200px

**Card Header:**
- Background: Light gray (#f8f9fc)
- Padding: 1rem (16px)
- Border radius top: 8px
- Star icon: Orange (#ff6b35), 24px, top-right

**Card Content:**
- Concept title: 18px (1.1rem), 600 weight, text primary (#2c3e50)
- Meta info: 14px, text secondary (#6c757d)
- Date: 13px, text secondary
- Concept preview: 14px, text secondary, line-clamp 2

**Personal Note Box:**
- Background: Light yellow (#fff9e6)
- Border: 2px solid orange (#ff6b35)
- Border radius: 6px
- Padding: 12px
- Icon: "üìù Personal Note:" prefix
- Font: 14px

**Action Buttons:**
- "Study" button: Primary blue (#2c5aa0), white text
- "Quiz" button: Primary blue (#2c5aa0), white text
- "Remove" button: Error red (#e17055), white text
- Height: 40px
- Border radius: 6px
- Gap: 8px between buttons

**Empty State:**
- Icon: Large bookmark üîñ (80px, gray #6c757d)
- Heading: 24px, 600 weight
- Message: 16px, text secondary
- Button: "Browse Concepts" (primary blue #2c5aa0)

**Responsive Grid:**
- Desktop (‚â•1024px): 3 columns
- Tablet (768-1023px): 2 columns
- Mobile (<768px): 1 column
- Gap: 24px (1.5rem)

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md` (View: Bookmarks Grid)
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** All buttons and cards labeled
- **Keyboard Navigation:** Full keyboard support
- **Focus Indicators:** Visible focus outlines
- **Screen Reader:** Announce bookmark count, concept titles

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.2 (Main Layout):** Uses MainLayout wrapper
2. **Story 1.5.5 (Notes Modal):** Opens modal for editing notes; bookmarks integrate with notes
3. **Story 1.5.3 (Concept Viewer):** Adds bookmark button to concept page; links to concepts from bookmarks view
4. **Story 1.5.1 (Sidebar Navigation):** Optionally shows bookmark indicators
5. **Database:** Creates new table for bookmarks
6. **API:** Creates new endpoints for bookmarking

### TypeScript Interfaces
```typescript
// Bookmark Data
interface Bookmark {
  id: string;
  user_id: string;
  concept_id: string;
  concept_title: string;
  concept_slug: string;
  chapter_number: number;
  chapter_title: string;
  note_preview: string;
  bookmarked_at: string;
}

// Component Props
interface BookmarksViewProps {
  bookmarks: Bookmark[];
}

interface BookmarkCardProps {
  bookmark: Bookmark;
  onView: (slug: string) => void;
  onEditNote: (conceptId: string, title: string) => void;
  onRemove: (id: string) => void;
}
```

### Database Schema
[Source: Story 2.2 requirements, incorporated into Epic 1.5]

**Table: `bookmarks`**

```typescript
export const bookmarks = pgTable('bookmarks', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  conceptId: uuid('concept_id').notNull().references(() => concepts.id, { onDelete: 'cascade' }),
  bookmarkedAt: timestamp('bookmarked_at').notNull().defaultNow(),
}, (table) => ({
  // Unique constraint: one bookmark per user per concept
  uniqueUserConcept: unique().on(table.userId, table.conceptId),
}));

// Indexes
// Index on user_id for fast user bookmarks queries
// Index on concept_id for bookmark status lookups
```

**Relations:**
- User has many Bookmarks
- Concept has many Bookmarks (through users)
- Bookmark optionally joins with Note for note preview

### API Endpoint Specifications - Bookmarking

#### Create Bookmark
**Endpoint:** `POST /api/bookmarks`

**Request:**
```typescript
{
  concept_id: string; // UUID of concept to bookmark
}
```

**Response:**
```typescript
{
  success: boolean;
  bookmark: {
    id: string;
    concept_id: string;
    bookmarked_at: string; // ISO 8601 timestamp
  }
}
```

**Errors:**
- 401: User not authenticated
- 404: Concept not found
- 409: Bookmark already exists (handled gracefully, return existing)

---

#### Remove Bookmark
**Endpoint:** `DELETE /api/bookmarks/{id}`

**Alternative:** `DELETE /api/concepts/{id}/bookmark` (by concept ID)

**Request:**
```typescript
// No body required, user from session
```

**Response:**
```typescript
{
  success: boolean;
}
```

**Errors:**
- 401: User not authenticated
- 404: Bookmark not found
- 403: Bookmark belongs to different user

---

#### Get User Bookmarks
**Endpoint:** `GET /api/users/{id}/bookmarks`

**Response format documented in TypeScript Interfaces section above**

**Query Implementation:**
```sql
SELECT 
  b.id as bookmark_id,
  b.bookmarked_at,
  c.id as concept_id,
  c.title as concept_title,
  c.slug as concept_slug,
  ch.chapter_number,
  ch.title as chapter_title,
  LEFT(n.content, 100) as note_preview
FROM bookmarks b
JOIN concepts c ON b.concept_id = c.id
JOIN chapters ch ON c.chapter_id = ch.id
LEFT JOIN notes n ON n.concept_id = c.id AND n.user_id = b.user_id
WHERE b.user_id = $1
ORDER BY b.bookmarked_at DESC;
```

### Testing

**Test File Location:** `apps/web/__tests__/app/dashboard/bookmarks/page.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - Page renders with bookmark cards
   - Grid is responsive (columns change by viewport)
   - Note preview displays (truncated to 100 chars)
   - Chapter badge displays

2. **Action Tests:**
   - "View" button navigates to concept
   - "Edit Note" button opens Notes Modal
   - "Remove Bookmark" button shows confirmation
   - Confirming remove deletes bookmark

3. **Empty State Tests:**
   - Empty state displays when no bookmarks
   - "Browse Chapters" button navigates to chapters

4. **Accessibility Tests:**
   - ARIA labels present
   - Keyboard navigation works
   - Focus indicators visible

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { BookmarksView } from '@/components/Dashboard/BookmarksView';

describe('BookmarksView', () => {
  const mockBookmarks = [
    {
      id: 'bm-1',
      concept_title: 'Cardiac Physiology',
      concept_slug: 'cardiac-physiology',
      chapter_number: 2,
      chapter_title: 'Medical-Surgical Nursing',
      note_preview: 'Remember the key points about heart function and...',
      bookmarked_at: '2025-10-01T10:00:00Z',
    },
  ];
  
  it('renders bookmark cards in grid', () => {
    render(<BookmarksView bookmarks={mockBookmarks} />);
    
    expect(screen.getByText('Cardiac Physiology')).toBeInTheDocument();
    expect(screen.getByText('Chapter 2')).toBeInTheDocument();
    expect(screen.getByText(/Remember the key points/)).toBeInTheDocument();
  });
  
  it('navigates to concept on "View" click', () => {
    const mockRouter = { push: jest.fn() };
    render(<BookmarksView bookmarks={mockBookmarks} />);
    
    const viewButton = screen.getByLabelText('view concept');
    fireEvent.click(viewButton);
    
    expect(mockRouter.push).toHaveBeenCalledWith('/concepts/cardiac-physiology');
  });
  
  it('opens Notes Modal on "Edit Note" click', () => {
    render(<BookmarksView bookmarks={mockBookmarks} />);
    
    const editButton = screen.getByLabelText('edit note');
    fireEvent.click(editButton);
    
    expect(screen.getByRole('dialog')).toBeInTheDocument();
  });
  
  it('shows confirmation dialog on "Remove" click', () => {
    render(<BookmarksView bookmarks={mockBookmarks} />);
    
    const removeButton = screen.getByLabelText('remove bookmark');
    fireEvent.click(removeButton);
    
    expect(screen.getByText('Remove Bookmark?')).toBeInTheDocument();
  });
  
  it('displays empty state when no bookmarks', () => {
    render(<BookmarksView bookmarks={[]} />);
    
    expect(screen.getByText('No Bookmarks Yet')).toBeInTheDocument();
    expect(screen.getByText('Browse Chapters')).toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5 | Bob (Scrum Master) |
| 2025-10-14 | 2.0 | Incorporated Story 2.2 backend (bookmarking) per SCP-2025-003 | Sarah (PO) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*Will be recorded by dev agent*

### Debug Log References
*Will be populated by the development agent*

### Completion Notes List
*Will be populated by the development agent*

### File List
*Will be populated by the development agent*

## QA Results
*This section will be populated by QA Agent after implementation*
