# Story 1.4: Content Browsing & Freemium Access

## Status
Draft

## Story
**As a** guest or free user,
**I want** to browse the list of all chapters and concepts, and access the full content for the first four chapters,
**so that** I can evaluate the platform's value before considering a subscription.

## Acceptance Criteria
1.  All users can see the titles of all chapters and concepts.
2.  Any user can view the full content and quiz for any concept within chapters 1-4.
3.  Attempting to access a concept from chapters 5-8 prompts a non-premium user to upgrade.
4.  The UI clearly distinguishes between free and premium content.

## Tasks / Subtasks
- [ ] **Task 1: Backend - Update API to support Freemium Logic** (AC: 1, 2, 3)
    - [ ] Modify the `GET /chapters` endpoint to return all chapter and concept titles without restriction. [Source: docs/architecture/api-specification.md]
    - [ ] In the `GET /concepts/{conceptId}` endpoint, implement logic to check the `chapter_number` of the requested concept.
    - [ ] If `chapter_number` <= 4, return the full concept content.
    - [ ] If `chapter_number` > 4, check the user's authentication status and `subscription` tier. [Source: docs/architecture/data-models.md#User]
    - [ ] If the user is not authenticated or has a 'FREE' subscription, return a 403 Forbidden error or a specific payload indicating that the content is premium.
- [ ] **Task 2: Frontend - Display Chapter & Concept List** (AC: 1)
    - [ ] Create a component to fetch data from `GET /chapters` and display the full list of all chapters and their nested concepts.
    - [ ] In the list UI, visually distinguish between free concepts (chapters 1-4) and premium concepts (chapters 5+). A 'lock' icon or a 'Premium' badge would be appropriate. [Source: docs/architecture/project-structure.md#Main Web Application]
- [ ] **Task 3: Frontend - Implement Content Access** (AC: 2, 3, 4)
    - [ ] Create a page component for viewing a single concept (e.g., `app/concepts/[slug]/page.tsx`).
    - [ ] This page should fetch data from `GET /concepts/{conceptId}`.
    - [ ] If the API returns full content, render the content and the quiz.
    - [ ] If the API returns a "premium access required" error/payload, display a paywall or a prompt for the user to upgrade their subscription instead of the content.
    - [ ] Ensure the UI distinction between free and premium content is clear on the concept page itself.
- [ ] **Task 4: Testing** (AC: 1, 2, 3, 4)
    - [ ] Write API integration tests (Jest + Supertest) for the `GET /concepts/{conceptId}` endpoint to verify the freemium logic for both free and premium users on chapters 3, 4, and 5. [Source: docs/architecture/coding-standards.md#Testing Standards]
    - [ ] Write E2E tests (Playwright) for the user journey:
        - [ ] A guest user can see all chapters/concepts.
        - [ ] A guest user can view a concept in chapter 2.
        - [ ] A guest user is blocked by a paywall when trying to view a concept in chapter 5.
        - [ ] The UI correctly displays 'lock' icons or badges on premium content.

## Dev Notes

### Previous Story Insights
The database layer has been successfully migrated to Drizzle ORM as of story `1.3.1`. All new database queries **must** be implemented using the Drizzle ORM and the established service layer pattern (`UserService`, `BaseService`). The Supabase JS Client should not be used for direct queries anymore. [Source: docs/stories/1.3.1.database-layer-drizzle-orm-migration.md]

### Data Models
-   **Chapter**: Represents a top-level content group. Key attribute for this story is `chapterNumber`. [Source: docs/architecture/data-models.md#Chapter (Revised)]
-   **Concept**: Represents a single learning topic. The `chapterId` will be used to link to the parent `Chapter` to determine if it's part of the freemium tier. [Source: docs/architecture/data-models.md#Concept (Revised)]
-   **User**: The `subscription` enum (`FREE` or `PREMIUM`) is critical for determining access rights for authenticated users. [Source: docs/architecture/data-models.md#User]

### API Specifications
-   `GET /chapters`: This endpoint should be used to fetch the list of all chapters and concepts to display to the user. It should not enforce any access restrictions on the list itself. [Source: docs/architecture/api-specification.md]
-   `GET /concepts/{conceptId}`: This is the primary endpoint to modify. It must contain the core logic to check the concept's chapter number and the user's subscription status to either return the full content or an access denied response. [Source: docs/architecture/api-specification.md]

### File Locations
-   **API Logic**: The freemium access logic should be implemented in the Next.js API route handler for concepts, likely located at `apps/web/src/app/api/concepts/[conceptId]/route.ts`. [Source: docs/architecture/project-structure.md#Main Web Application]
-   **Frontend Pages**: The main browsing UI will likely be a new page component. The page for viewing a single concept will be a dynamic route, e.g., `apps/web/src/app/concepts/[slug]/page.tsx`. [Source: docs/architecture/project-structure.md#Main Web Application]

### Testing
-   **API Tests**: Integration tests are required for the API endpoint. Use Jest and Supertest to create tests that simulate requests from both free and premium users for concepts in both free and premium chapters. Mock the database using the patterns established in `1.3.1`. [Source: docs/architecture/coding-standards.md#Integration Tests]
-   **E2E Tests**: Use Playwright to create end-to-end tests that cover the entire user flow. This must include a guest user successfully viewing a free concept and being correctly blocked by a paywall when attempting to view a premium one. The tests must also verify the UI correctly distinguishes between free and premium content. [Source: docs/architecture/coding-standards.md#E2E Tests]

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-29 | 1.0 | Initial draft created from epic. | Scrum Master (Bob) |

## Dev Agent Record
*This section is to be populated by the development agent.*

## QA Results
*To be populated by QA agent.*
