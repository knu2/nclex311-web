# Story 1.5.10: Premium Sidebar Integration

## Status
**Draft**

## Story
**As a** free user,  
**I want** to see clear indicators for premium content in the sidebar,  
**so that** I understand what's available and can upgrade easily.

## Acceptance Criteria
1. Premium concepts (chapters 5-8) display a lock icon in the sidebar.
2. Clicking a premium concept (as free user) shows an inline upgrade prompt in the main content area.
3. The upgrade prompt displays:
   - Clear message explaining premium benefits
   - "Upgrade Now" button (links to payment flow from Story 2.1)
   - "Learn More" link (to subscription page)
4. Premium users see no lock icons (all content unlocked).
5. The sidebar chapter selector shows free/premium badge per chapter.
6. Visual distinction between free and premium is clear but not obtrusive.
7. Uses MUI components (Chip, Alert, Button).
8. Meets accessibility standards.

## Tasks / Subtasks

- [ ] Task 1: Enhance ConceptList Sidebar Component (AC: 1, 4)
  - [ ] Update Story 1.5.1 ConceptList component
  - [ ] Add lock icon (LockIcon) to premium concepts
  - [ ] Check user premium status to show/hide lock icons
  - [ ] Style lock icons appropriately
  
- [ ] Task 2: Add Chapter Free/Premium Badges (AC: 5, 6)
  - [ ] Add badge to sidebar chapter header
  - [ ] Display "Free" or "Premium" chip
  - [ ] Style badges with theme colors
  - [ ] Ensure badges don't clutter UI
  
- [ ] Task 3: Create UpgradePrompt Component (AC: 2, 3, 7)
  - [ ] Create `src/components/Premium/UpgradePrompt.tsx` component
  - [ ] Use MUI Alert or Card component
  - [ ] Display prominent message about premium benefits
  - [ ] Add "Upgrade Now" button
  - [ ] Add "Learn More" link
  
- [ ] Task 4: Integrate Upgrade Prompt in Concept Viewer (AC: 2)
  - [ ] Update Story 1.5.3 ConceptViewer component
  - [ ] Show UpgradePrompt instead of content for locked concepts
  - [ ] Detect when free user clicks premium concept
  - [ ] Replace "READ THIS" section with upgrade prompt
  
- [ ] Task 5: Link Upgrade Button to Payment Flow (AC: 3)
  - [ ] Link "Upgrade Now" button to Story 2.1 payment page
  - [ ] Navigate to `/subscribe` or payment route
  - [ ] Pass appropriate context (concept ID, chapter, etc.)
  
- [ ] Task 6: Implement "Learn More" Link (AC: 3)
  - [ ] Create subscription benefits page (or link to existing)
  - [ ] Link "Learn More" to `/premium` or `/subscribe/benefits`
  - [ ] Display detailed premium features
  
- [ ] Task 7: Handle Premium User Experience (AC: 4)
  - [ ] Check user premium status on page load
  - [ ] Hide all lock icons for premium users
  - [ ] Allow premium users full access to all concepts
  - [ ] No upgrade prompts for premium users
  
- [ ] Task 8: Style Premium Indicators (AC: 6)
  - [ ] Use subtle, non-obtrusive styling
  - [ ] Lock icon: small, gray, positioned at right
  - [ ] Premium badge: subtle chip with theme color
  - [ ] Upgrade prompt: prominent but professional
  
- [ ] Task 9: Implement Accessibility Features (AC: 8)
  - [ ] Add ARIA labels for lock icons and badges
  - [ ] Ensure keyboard navigation works
  - [ ] Add focus indicators
  - [ ] Test with screen readers
  - [ ] Ensure color contrast meets WCAG 2.1 AA
  
- [ ] Task 10: Add Unit Tests
  - [ ] Test lock icons display for free users
  - [ ] Test no lock icons for premium users
  - [ ] Test upgrade prompt displays on premium concept click
  - [ ] Test "Upgrade Now" button navigates correctly
  - [ ] Test chapter badges display correctly
  - [ ] Test accessibility features

## Dev Notes

### Previous Story Insights
- Story 1.5.1 (Sidebar Navigation) completed: ConceptList component available [Source: Epic 1.5]
- Story 1.5.3 (Concept Viewer) completed: ConceptViewer component available [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: Freemium logic implemented [Source: Epic 1.5]
- Story 2.1 (Payment Workflow) in future: Payment page will be available [Source: Epic 1.5]

### Component Location
**Files:**
- Component: `apps/web/src/components/Premium/UpgradePrompt.tsx`
- Enhanced: `apps/web/src/components/Sidebar/ConceptList.tsx` (Story 1.5.1)
- Enhanced: `apps/web/src/components/Concept/ConceptViewer.tsx` (Story 1.5.3)

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled

### MUI Components to Use
- **LockIcon:** Premium concept indicator
- **Chip:** Free/Premium badges
- **Alert:** Upgrade prompt message
- **Card:** Upgrade prompt container
- **Button:** "Upgrade Now" button
- **Link:** "Learn More" link
- **Typography:** Text styling

### Premium Concept Detection
```typescript
// Freemium Logic (from Story 1.6 Backend)
const isPremiumConcept = (concept: Concept): boolean => {
  return concept.chapter_number >= 5; // Chapters 5-8 are premium
};

const isUserPremium = (user: User): boolean => {
  return user.subscription_status === 'active';
};

const showLockIcon = isPremiumConcept(concept) && !isUserPremium(user);
```

### Sidebar Lock Icon Integration
```typescript
// In ConceptList.tsx (Story 1.5.1)
<ListItem button onClick={() => handleConceptClick(concept)}>
  <ListItemText primary={concept.title} />
  {showLockIcon(concept) && (
    <ListItemIcon>
      <LockIcon 
        sx={{ fontSize: 18, color: 'text.disabled' }}
        aria-label="Premium content" 
      />
    </ListItemIcon>
  )}
</ListItem>
```

### Chapter Badge Implementation
```typescript
// In ConceptList chapter header
<Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
  <Typography variant="h6">
    Chapter {chapterNumber}: {chapterTitle}
  </Typography>
  <Chip 
    label={isPremiumChapter ? 'Premium' : 'Free'}
    size="small"
    color={isPremiumChapter ? 'secondary' : 'default'}
    sx={{ fontSize: '0.75rem' }}
  />
</Box>
```

### UpgradePrompt Component
```typescript
<Alert 
  severity="info" 
  sx={{ 
    mt: 3,
    p: 3,
    backgroundColor: 'rgba(25, 118, 210, 0.08)',
  }}
>
  <AlertTitle sx={{ fontSize: '1.25rem', fontWeight: 600 }}>
    Unlock Premium Content
  </AlertTitle>
  <Typography variant="body1" sx={{ mb: 2 }}>
    This concept is part of our premium content. Upgrade to access:
  </Typography>
  <Box component="ul" sx={{ pl: 2, mb: 2 }}>
    <li>Chapters 5-8 (Mental Health, Community Health, Leadership, Professional Development)</li>
    <li>Advanced practice questions and detailed rationales</li>
    <li>Study progress tracking across all chapters</li>
    <li>Unlimited access to community discussions</li>
  </Box>
  <Box sx={{ display: 'flex', gap: 2 }}>
    <Button 
      variant="contained" 
      size="large"
      component={Link}
      href="/subscribe"
    >
      Upgrade Now
    </Button>
    <Button 
      variant="outlined"
      size="large"
      component={Link}
      href="/premium/benefits"
    >
      Learn More
    </Button>
  </Box>
</Alert>
```

### Concept Viewer Integration
```typescript
// In ConceptViewer.tsx (Story 1.5.3)
const ConceptViewer = ({ concept, user }) => {
  const isPremiumLocked = isPremiumConcept(concept) && !isUserPremium(user);
  
  if (isPremiumLocked) {
    return (
      <Box>
        <Typography variant="h4" gutterBottom>
          {concept.title}
        </Typography>
        <UpgradePrompt conceptId={concept.id} />
      </Box>
    );
  }
  
  // Regular concept content rendering
  return (
    <Box>
      {/* Normal concept viewer content */}
    </Box>
  );
};
```

### Premium Benefits List
```typescript
const premiumBenefits = [
  'Access to all 8 chapters (323 concepts)',
  'Advanced NCLEX-style practice questions',
  'Detailed answer rationales and explanations',
  'Progress tracking and performance analytics',
  'Unlimited notes and bookmarks',
  'Community discussions with instructors',
  '30-day money-back guarantee',
];
```

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**Sidebar Premium Indicators:** [Source: front-end-spec.md, Screen: Main Layout]

**Lock Icon on Premium Concepts:**
- Icon: ðŸ”’ LockIcon
- Size: 18px
- Color: Text secondary (#6c757d)
- Position: Right side of concept list item
- Opacity: 0.7

**Chapter Badge:**
- "Free" badge: Small chip (green #00b894, white text, 0.75rem)
- "Premium" badge: Small chip (yellow #ffeaa7, dark text #2c3e50, 0.75rem)
- Position: Next to chapter title in sidebar header
- Border radius: 4px
- Padding: 4px 8px

**Upgrade Prompt Component:**
- Background: Light blue (#e8f0fe) with 8% opacity blue tint
- Border: 2px solid blue (#2c5aa0)
- Border radius: 8px
- Padding: 2rem (32px)
- Margin top: 2rem

**Prompt Heading:**
- Title: "Unlock Premium Content" (H2, 24px, 600 weight)
- Icon: ðŸ”“ (unlock emoji, 32px)
- Color: Primary blue (#2c5aa0)

**Benefits List:**
- Bullet style: Checkmarks (âœ… or âœ”ï¸)
- Font size: 16px
- Line height: 1.6
- Spacing: 12px between items
- Color: Text primary (#2c3e50)

**Buttons:**
- "Upgrade Now" button:
  - Background: Primary blue (#2c5aa0)
  - Text: White, 16px, 600 weight
  - Height: 48px (large)
  - Border radius: 8px
  - Shadow: 0 4px 8px rgba(44,90,160,0.2)
  - Hover: Darker blue, lift effect
  
- "Learn More" button:
  - Border: 2px solid blue (#2c5aa0)
  - Text: Blue (#2c5aa0), 16px, 600 weight
  - Background: Transparent
  - Height: 48px (large)
  - Border radius: 8px
  - Hover: Light blue background (#e8f0fe)

**Premium Upsell Banner (Sidebar Footer):**
- Background: Gradient (orange to yellow tint)
- Icon: ðŸš€ (rocket emoji)
- Title: "Unlock Premium" (bold, 16px)
- Description: 14px, 2 lines max
- Button: "Upgrade Now" (small, yellow #ffeaa7 background)
- Border radius: 6px
- Padding: 1rem

**Visual Distinction:**
- Subtle and non-obtrusive
- Clear but not aggressive
- Maintains professional appearance
- Consistent with brand colors

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md` (Screen: Main Layout, Subscription Page)
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** Lock icons labeled "Premium content"
- **Keyboard Navigation:** Full keyboard support
- **Focus Indicators:** Visible focus outlines
- **Screen Reader:** Announce premium status clearly

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.1 (Sidebar Navigation):** Enhances ConceptList with lock icons and badges
2. **Story 1.5.3 (Concept Viewer):** Displays upgrade prompt for premium concepts
3. **Story 1.6 Backend:** Uses freemium logic from ContentService
4. **Story 2.1 (Payment Workflow):** Links to subscription/payment page

### TypeScript Interfaces
```typescript
// Component Props
interface UpgradePromptProps {
  conceptId?: string;
  chapterNumber?: number;
  benefits?: string[];
}

// User Premium Status
interface UserStatus {
  is_premium: boolean;
  subscription_status: 'active' | 'inactive' | 'trial' | 'expired';
  subscription_end_date?: string;
}

// Concept Premium Check
interface PremiumCheckResult {
  is_premium_concept: boolean;
  is_user_premium: boolean;
  show_lock: boolean;
}
```

### Testing

**Test File Locations:**
- `apps/web/__tests__/components/Sidebar/ConceptList.test.tsx` (enhanced)
- `apps/web/__tests__/components/Premium/UpgradePrompt.test.tsx`

**Required Test Cases:**
1. **Sidebar Tests:**
   - Lock icons display on premium concepts (free users)
   - No lock icons display for premium users
   - Chapter badges display correctly (Free/Premium)
   - Clicking premium concept (free user) shows prompt

2. **Upgrade Prompt Tests:**
   - Upgrade prompt renders with benefits list
   - "Upgrade Now" button links to `/subscribe`
   - "Learn More" link works correctly
   - Prompt styling is appropriate

3. **Premium User Tests:**
   - Premium users see no lock icons
   - Premium users can access all concepts
   - No upgrade prompts for premium users

4. **Accessibility Tests:**
   - ARIA labels present on lock icons
   - Keyboard navigation works
   - Focus indicators visible
   - Screen reader announcements work

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { ConceptList } from '@/components/Sidebar/ConceptList';
import { UpgradePrompt } from '@/components/Premium/UpgradePrompt';

describe('Premium Sidebar Integration', () => {
  const mockFreeUser = { is_premium: false };
  const mockPremiumUser = { is_premium: true };
  const mockPremiumConcept = { 
    id: 'c1', 
    title: 'Mental Health Assessment', 
    chapter_number: 5,
    is_premium: true 
  };
  
  it('shows lock icons for premium concepts (free user)', () => {
    render(<ConceptList concepts={[mockPremiumConcept]} user={mockFreeUser} />);
    
    expect(screen.getByLabelText('Premium content')).toBeInTheDocument();
    expect(screen.getByTestId('LockIcon')).toBeInTheDocument();
  });
  
  it('hides lock icons for premium users', () => {
    render(<ConceptList concepts={[mockPremiumConcept]} user={mockPremiumUser} />);
    
    expect(screen.queryByTestId('LockIcon')).not.toBeInTheDocument();
  });
  
  it('displays upgrade prompt when free user clicks premium concept', () => {
    render(<ConceptList concepts={[mockPremiumConcept]} user={mockFreeUser} />);
    
    const conceptItem = screen.getByText('Mental Health Assessment');
    fireEvent.click(conceptItem);
    
    expect(screen.getByText('Unlock Premium Content')).toBeInTheDocument();
    expect(screen.getByText('Upgrade Now')).toBeInTheDocument();
  });
  
  it('links Upgrade Now button to subscription page', () => {
    render(<UpgradePrompt />);
    
    const upgradeButton = screen.getByText('Upgrade Now');
    expect(upgradeButton).toHaveAttribute('href', '/subscribe');
  });
  
  it('displays chapter badges correctly', () => {
    render(<ConceptList chapterNumber={1} user={mockFreeUser} />);
    expect(screen.getByText('Free')).toBeInTheDocument();
    
    render(<ConceptList chapterNumber={5} user={mockFreeUser} />);
    expect(screen.getByText('Premium')).toBeInTheDocument();
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5 | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*Will be recorded by dev agent*

### Debug Log References
*Will be populated by the development agent*

### Completion Notes List
*Will be populated by the development agent*

### File List
*Will be populated by the development agent*

## QA Results
*This section will be populated by QA Agent after implementation*
