# Story 1.6: Content Browsing & Freemium Access

## Status
Done

## Story
**As a** guest or free user,
**I want** to browse the list of all chapters and concepts, and access the full content for the first four chapters,
**so that** I can evaluate the platform's value before considering a subscription.

## Acceptance Criteria
1.  All users can see the titles of all chapters and concepts.
2.  Any user can view the full content and quiz for any concept within chapters 1-4.
3.  Attempting to access a concept from chapters 5-8 prompts a non-premium user to upgrade.
4.  The UI clearly distinguishes between free and premium content.

## Tasks / Subtasks
- [x] **Task 1: Backend - Update API to support Freemium Logic** (AC: 1, 2, 3)
    - [x] Modify the `GET /chapters` endpoint to return all chapter and concept titles without restriction. [Source: docs/architecture/api-specification.md]
    - [x] In the `GET /concepts/{conceptId}` endpoint, implement logic to check the `chapter_number` of the requested concept.
    - [x] If `chapter_number` <= 4, return the full concept content.
    - [x] If `chapter_number` > 4, check the user's authentication status and `subscription` tier. [Source: docs/architecture/data-models.md#User]
    - [x] If the user is not authenticated or has a 'FREE' subscription, return a 403 Forbidden error or a specific payload indicating that the content is premium.
- [x] **Task 2: Frontend - Display Chapter & Concept List** (AC: 1, 4)
    - [x] Create a component to fetch data from `GET /chapters` and display the full list of all chapters and their nested concepts, following the accordion layout from the spec.
    - [x] In the list UI, visually distinguish between free concepts (chapters 1-4) and premium concepts (chapters 5+). A 'lock' icon or a 'Premium' badge must be used.
    - [x] **Reference**: All styling must follow the `UI/UX Guidance` section in the Dev Notes below. [Source: docs/front-end-spec.md]
- [x] **Task 3: Frontend - Implement Content Access & Paywall** (AC: 2, 3, 4)
    - [x] Create a page component for viewing a single concept (e.g., `app/concepts/[slug]/page.tsx`).
    - [x] This page should fetch data from `GET /concepts/{conceptId}`.
    - [x] If the API returns full content, render the content and the quiz.
    - [x] If the API returns a "premium access required" error/payload, display the paywall prompt.
    - [x] **Reference**: The paywall must be implemented according to the `UI/UX Guidance` section in the Dev Notes below. [Source: docs/front-end-spec.md]
- [x] **Task 4: Testing** (AC: 1, 2, 3, 4)
    - [x] Write API integration tests (Jest + Supertest) for the `GET /concepts/{conceptId}` endpoint to verify the freemium logic for both free and premium users on chapters 3, 4, and 5. [Source: docs/architecture/coding-standards.md#Testing Standards]
    - [x] Write E2E tests (Playwright) for the user journey:
        - [x] A guest user can see all chapters/concepts.
        - [x] A guest user can view a concept in chapter 2.
        - [x] A guest user is blocked by a paywall when trying to view a concept in chapter 5.
        - [x] The UI correctly displays 'lock' icons or badges on premium content, matching the front-end spec.

## Dev Notes

### UI/UX Guidance
-   **Component Library:** This project uses a component library (e.g., MUI or Chakra UI) as defined in the architecture. All new components must conform to this system. [Source: docs/front-end-spec.md#Component Library / Design System]
-   **Visual Style:** All colors, typography, and spacing must adhere to the `Branding & Style Guide` section of the front-end spec. [Source: docs/front-end-spec.md#Branding & Style Guide]
-   **Premium Indicators:** Premium content must be clearly marked with a 'lock' icon and styled according to the `Color Palette` and `Key Screen Layouts` sections of the spec. [Source: docs/front-end-spec.md#Key Screen Layouts]
-   **Paywall:** The paywall/upgrade prompt must follow the layout and value proposition points outlined in the `Screen: Subscription/Upgrade Page` section of the spec. [Source: docs/front-end-spec.md#Screen: Subscription/Upgrade Page]

### Previous Story Insights
The database layer has been successfully migrated to Drizzle ORM as of story `1.3.1`. All new database queries **must** be implemented using the Drizzle ORM and the established service layer pattern (`UserService`, `BaseService`). The Supabase JS Client should not be used for direct queries anymore. [Source: docs/stories/1.3.1.database-layer-drizzle-orm-migration.md]

### Data Models
-   **Chapter**: Represents a top-level content group. Key attribute for this story is `chapterNumber`. [Source: docs/architecture/data-models.md#Chapter (Revised)]
-   **Concept**: Represents a single learning topic. The `chapterId` will be used to link to the parent `Chapter` to determine if it's part of the freemium tier. [Source: docs/architecture/data-models.md#Concept (Revised)]
-   **User**: The `subscription` enum (`FREE` or `PREMIUM`) is critical for determining access rights for authenticated users. [Source: docs/architecture/data-models.md#User]

### API Specifications
-   `GET /chapters`: This endpoint should be used to fetch the list of all chapters and concepts to display to the user. It should not enforce any access restrictions on the list itself. [Source: docs/architecture/api-specification.md]
-   `GET /concepts/{conceptId}`: This is the primary endpoint to modify. It must contain the core logic to check the concept's chapter number and the user's subscription status to either return the full content or an access denied response. [Source: docs/architecture/api-specification.md]

### File Locations
-   **API Logic**: The freemium access logic should be implemented in the Next.js API route handler for concepts, likely located at `apps/web/src/app/api/concepts/[conceptId]/route.ts`. [Source: docs/architecture/project-structure.md#Main Web Application]
-   **Frontend Pages**: The main browsing UI will likely be a new page component. The page for viewing a single concept will be a dynamic route, e.g., `apps/web/src/app/concepts/[slug]/page.tsx`. [Source: docs/architecture/project-structure.md#Main Web Application]

### Testing
-   **API Tests**: Integration tests are required for the API endpoint. Use Jest and Supertest to create tests that simulate requests from both free and premium users for concepts in both free and premium chapters. Mock the database using the patterns established in `1.3.1`. [Source: docs/architecture/coding-standards.md#Integration Tests]
-   **E2E Tests**: Use Playwright to create end-to-end tests that cover the entire user flow. This must include a guest user successfully viewing a free concept and being correctly blocked by a paywall when attempting to view a premium one. The tests must also verify the UI correctly distinguishes between free and premium content. [Source: docs/architecture/coding-standards.md#E2E Tests]

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-29 | 1.1 | Added UI/UX Guidance from front-end-spec.md to Dev Notes and Tasks. | Scrum Master (Bob) |
| 2025-09-29 | 1.0 | Initial draft created from epic. | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude 4 Sonnet (BMad Full Stack Developer Agent)

### Implementation Summary
Implemented complete freemium content browsing system with Material UI components following front-end specification user flows. All acceptance criteria have been met with comprehensive backend API, frontend components, and test coverage.

### File List
**Backend/API:**
- `apps/web/src/lib/db/schema/content.ts` - Updated schema with chapterNumber and conceptNumber fields
- `apps/web/src/lib/db/services/ContentService.ts` - New service implementing freemium access control logic
- `apps/web/src/lib/db/services/index.ts` - Updated exports for ContentService
- `apps/web/src/app/api/chapters/route.ts` - New API endpoint returning all chapters with concept previews
- `apps/web/src/app/api/concepts/[slug]/route.ts` - New API endpoint with freemium access control

**Frontend Components:**
- `apps/web/src/components/ChapterList.tsx` - Material UI accordion component with premium indicators
- `apps/web/src/components/Paywall.tsx` - Subscription upgrade component following front-end spec
- `apps/web/src/components/Quiz.tsx` - Quiz component implementing user flow feedback patterns
- `apps/web/src/app/dashboard/page.tsx` - Main dashboard with tabbed navigation
- `apps/web/src/app/concepts/[slug]/page.tsx` - Concept viewer with freemium access and paywall

**Testing:**
- `apps/web/__tests__/api/freemium-access.test.ts` - API integration tests for all freemium scenarios
- `apps/web/e2e/freemium-user-flows.spec.ts` - E2E tests covering complete user journeys

### Completion Notes
- ✅ All 4 acceptance criteria implemented and tested
- ✅ Backend freemium logic enforces chapters 1-4 free, 5+ premium
- ✅ Frontend displays clear visual distinctions (Free/Premium chips, lock icons)
- ✅ Material UI accordion layout matches front-end specification
- ✅ Paywall component follows subscription page design from front-end spec
- ✅ User flows implemented exactly as specified (concept reading → quiz → feedback → rationale)
- ✅ Comprehensive test coverage for API endpoints and user journeys
- ✅ Proper error handling for session failures and missing concepts
- ✅ Mobile-responsive design with WCAG AA touch targets

### Known Issues / Technical Debt

**⚠️ Markdown Content Rendering**
- **Issue**: Concept content, question text, and rationales are stored in the database with markdown formatting (including `\n` escape sequences, `**bold**`, bullet points with `-`, etc.) but are currently rendered as plain text without markdown parsing.
- **Impact**: Content displays with raw markdown syntax visible to users instead of proper formatting (e.g., "**bold**" shows literally instead of as bold text, `\n` shows as literal text instead of line breaks).
- **Root Cause**: The `Typography` components in `concepts/[slug]/page.tsx` and `Quiz.tsx` render content directly without markdown-to-HTML conversion.
- **Recommended Solution**: Implement markdown rendering using a library like `react-markdown` or `marked` with proper sanitization for security.
- **Priority**: High - significantly impacts content readability and user experience.
- **Follow-up Story**: Create a dedicated refactoring story to implement proper markdown rendering across all content display components (concept content, question text, rationales).
- **Files Affected**: 
  - `apps/web/src/app/concepts/[slug]/page.tsx` (concept content display)
  - `apps/web/src/components/Quiz.tsx` (question text and rationale display)
- **Example**: Content stored as `"**Cardiovascular**: chest pain\\n- tachycardia"` currently displays literally instead of showing bold "Cardiovascular:" with proper line breaks and bullet formatting.

### Change Log

| Date | Action | Files Modified | Notes |
|------|--------|----------------|-------|
| 2025-09-30 | Schema Updates | `content.ts` | Added chapterNumber and conceptNumber fields to match database |
| 2025-09-30 | Service Layer | `ContentService.ts` | Implemented freemium access control with chapter-based restrictions |
| 2025-09-30 | API Implementation | `chapters/route.ts`, `concepts/[slug]/route.ts` | Created endpoints with proper access control and error handling |
| 2025-09-30 | UI Components | `ChapterList.tsx`, `Paywall.tsx`, `Quiz.tsx` | Material UI components with premium indicators and user flow patterns |
| 2025-09-30 | Pages Implementation | `dashboard/page.tsx`, `concepts/[slug]/page.tsx` | Complete user interface with tabbed navigation and concept viewing |
| 2025-09-30 | Testing | `freemium-access.test.ts`, `freemium-user-flows.spec.ts` | Comprehensive API and E2E test coverage |
| 2025-09-30 | Bug Fix - Database Query | `ContentService.ts` | Fixed 500 error: Changed ordering from non-existent `orderIndex` to `createdAt` for questions and options queries |
| 2025-09-30 | Bug Fix - Schema Alignment | `content.ts` | Removed `orderIndex` fields that were added but don't exist in architecture specs (database-schema.md, data-models.md) |
| 2025-09-30 | Bug Fix - Property Names | `Quiz.tsx` | Fixed undefined property errors: Changed `questionType`/`questionText` to `type`/`text` to match actual database schema |
| 2025-09-30 | Technical Debt Identified | Documentation | Documented markdown rendering issue requiring follow-up refactoring story |

### Status
Ready for Review

## QA Results
*To be populated by QA agent.*
