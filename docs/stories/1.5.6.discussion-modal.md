# Story 1.5.6: Discussion Modal

## Status
**Ready for Review** - Implementation complete with simplified requirements (basic commenting, no instructor roles, no nested replies)

## Story
**As a** logged-in user,  
**I want** to post comments and read other students' comments on concepts,  
**so that** I can learn from the community, share my insights, and benefit from peer experiences.

**Note:** This story absorbs Stories 3.1 (View Comments) and 3.2 (Post a Comment). Simplified to **basic commenting** - no question/discussion types, no nested replies, no instructor roles. Just students helping students.

## Acceptance Criteria
1. A "💬 Discussion" button is present in the concept viewer action buttons area.
2. Clicking "Discussion" opens a full-screen modal overlay with title "💬 Discussion: [Concept Name]".
3. The modal displays:
   - Comment input form at the top (always visible or toggle button)
   - List of comments sorted by newest first
   - Pagination or "Load More" for >20 comments
4. Each comment shows:
   - User name with avatar (circle with initials)
   - Comment text content
   - Timestamp (relative, e.g., "2 hours ago")
   - Like count and "Like" button
5. Users can:
   - Post new comments (plain text, up to 2000 characters)
   - View all comments with pagination/load more
   - Like comments (toggle on/off)
   - See their own comments highlighted or with edit/delete options
6. All users are students - no special roles, badges, or visual distinctions.
7. Comments refresh on modal open and after posting a new comment.
8. Modal is accessible (keyboard navigation, focus management, ESC to close, ARIA labels).
9. Modal uses MUI components (Dialog, Card, Button, TextField, Avatar).
10. **Error state** (failed to load comments) must show:
    - User-friendly message ("Unable to load comments")
    - "Retry" button to re-fetch comments
    - "Post Comment" button to allow posting even when load fails
11. **Empty state** (no comments yet) must show:
    - Encouraging message ("No comments yet. Be the first to share!")
    - Prominent "Post Comment" button or visible comment form
12. **Loading state** shows centered spinner while fetching comments.

## Tasks / Subtasks

- [ ] Task 1: Create CommentModal Component Structure (AC: 2, 9, 12)
  - [ ] Create `src/components/Discussion/CommentModal.tsx` component file
  - [ ] Set up MUI Dialog component for full-screen modal
  - [ ] Add modal header with concept title and close button
  - [ ] Add TypeScript interfaces for comments
  - [ ] Configure modal open/close state management
  - [ ] Implement loading state with centered CircularProgress
  
- [ ] Task 2: Build Comment Input Form (AC: 3, 5)
  - [ ] Create comment input textarea (MUI TextField multiline)
  - [ ] Add character counter (2000 char limit)
  - [ ] Add "Post Comment" button
  - [ ] Validate comment content (not empty, within limit)
  - [ ] Show user name "Posting as: [Name] (Student)"
  - [ ] Clear form after successful post
  
- [ ] Task 3: Create Comment List Component (AC: 3, 4)
  - [ ] Display list of comments in scrollable container
  - [ ] Sort comments by newest first (timestamp descending)
  - [ ] Add pagination or "Load More" button (20 comments per page)
  - [ ] Handle empty state with encouraging message
  - [ ] Handle error state with retry and post buttons
  
- [ ] Task 4: Build Comment Card Component (AC: 4, 6)
  - [ ] Display user avatar (MUI Avatar with initials)
  - [ ] Show user name and timestamp ("2 hours ago")
  - [ ] Render comment text content
  - [ ] Display like count and "Like" button (thumbs up icon)
  - [ ] Highlight current user's own comments (light background)
  - [ ] All comments have same styling (no special roles)
  
- [ ] Task 5: Implement Like Functionality (AC: 5)
  - [ ] Add like button with toggle state (liked / not liked)
  - [ ] Update like count optimistically
  - [ ] Call like/unlike API endpoints
  - [ ] Show visual feedback on like (blue color when liked)
  - [ ] Disable like button during API call
  
- [ ] Task 6: Implement Error State Component (AC: 10)
  - [ ] Create ErrorState component with user-friendly message
  - [ ] Add "Retry" button with refresh icon
  - [ ] Add "Post Comment" button to allow posting
  - [ ] Style with warning border and proper spacing
  - [ ] Add ARIA role="alert" for screen readers
  
- [ ] Task 7: Integrate with API (AC: 5, 7)
  - [ ] Fetch comments on modal open (GET /api/concepts/{id}/comments)
  - [ ] Create new comment (POST /api/concepts/{id}/comments)
  - [ ] Like comment (POST /api/comments/{commentId}/like)
  - [ ] Unlike comment (DELETE /api/comments/{commentId}/like)
  - [ ] Refresh comments after successful post
  - [ ] Handle API errors gracefully
  
- [ ] Task 8: Implement Accessibility Features (AC: 8)
  - [ ] Add ARIA labels for modal, buttons, and form elements
  - [ ] Ensure keyboard navigation works (Tab order)
  - [ ] Add focus management (focus trap in modal)
  - [ ] Support ESC key to close modal
  - [ ] Test with VoiceOver/NVDA screen readers
  - [ ] Ensure color contrast meets WCAG AA
  
- [ ] Task 9: Add Unit Tests
  - [ ] Test modal opens and closes correctly
  - [ ] Test comment form submission and validation
  - [ ] Test comment list renders with pagination
  - [ ] Test empty state displays correctly
  - [ ] Test error state with retry button
  - [ ] Test like/unlike functionality
  - [ ] Test accessibility (keyboard nav, ARIA labels)

## Dev Notes

### Previous Story Insights
- Story 1.5.3 (Concept Viewer) completed: Provides trigger button location [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: User authentication and roles available [Source: Epic 1.5]

### Component Location
**File Path:** `apps/web/src/components/Discussion/CommentModal.tsx` [Source: Epic 1.5]

**Project Structure:**
```plaintext
apps/web/src/
├── app/                    # Next.js App Router
├── components/             # React components
│   └── Discussion/        # Discussion-related components
│       ├── CommentModal.tsx     # Main modal component
│       ├── CommentList.tsx      # Comment list with pagination
│       ├── CommentCard.tsx      # Individual comment display
│       ├── CommentForm.tsx      # New comment creation
│       └── ErrorState.tsx       # Error state component
└── lib/                    # Utility libraries
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled
- **State Management:** React Built-in (useState/useContext)

### MUI Components to Use
- **Dialog:** Full-screen modal container
- **Card:** Comment card container
- **CardHeader:** Comment header with user info
- **CardContent:** Comment text content
- **CardActions:** Like button
- **TextField:** Comment input form (multiline)
- **Button/IconButton:** Actions (Post, Like, Retry)
- **Avatar:** User avatar with initials
- **CircularProgress:** Loading spinner
- **Divider:** Visual separators between comments

### API Specifications
[Source: Epic 1.5 - Simplified]

**New API Endpoints:**

1. **Get Comments for Concept:**
```
GET /api/concepts/{id}/comments?page={number}
Authorization: Bearer {token}

Response:
{
  comments: [
    {
      id: string;
      user_id: string;
      user_name: string;
      content: string;
      like_count: number;
      is_liked_by_user: boolean;
      created_at: timestamp;
    }
  ],
  total_count: number;
  page: number;
  page_size: number;
}
```

2. **Create Comment:**
```
POST /api/concepts/{id}/comments
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  content: string;  // max 2000 characters
}

Response:
{
  id: string;
  user_id: string;
  user_name: string;
  content: string;
  like_count: number;
  is_liked_by_user: boolean;
  created_at: timestamp;
}
```

3. **Like Comment:**
```
POST /api/comments/{commentId}/like
Authorization: Bearer {token}

Response:
{
  success: boolean;
  like_count: number;
}
```

4. **Unlike Comment:**
```
DELETE /api/comments/{commentId}/like
Authorization: Bearer {token}

Response:
{
  success: boolean;
  like_count: number;
}
```

### Simplified Comment Model
[Source: Epic 1.5 - Simplified for basic commenting]

**New comments Table:**
```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  concept_id UUID NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,
  content TEXT NOT NULL CHECK (char_length(content) <= 2000),
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE comment_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  comment_id UUID NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT now(),
  UNIQUE (user_id, comment_id)
);

CREATE INDEX idx_comments_concept ON comments(concept_id);
CREATE INDEX idx_comments_created_at ON comments(created_at DESC);
CREATE INDEX idx_comment_likes_comment ON comment_likes(comment_id);
```

**Notes:**
- No `parent_id` - no nested replies
- No `post_type` - all comments are equal
- No `is_pinned` - no instructor roles
- Content limited to 2000 characters at database level
- Sorted by `created_at DESC` (newest first)

### Comment Styling
**All Comments (Equal Styling):**
```typescript
const commentCardStyle = {
  backgroundColor: 'white',
  border: '2px solid #e1e7f0',
  borderRadius: '6px',
  padding: '1rem',
  marginBottom: '0.75rem',
};

// User's own comments - slightly highlighted
const ownCommentStyle = {
  ...commentCardStyle,
  backgroundColor: '#f8f9fc', // Light gray background
};
```

**Avatar Styling:**
```typescript
<Avatar sx={{ bgcolor: '#2c5aa0', width: 40, height: 40 }}>
  {userInitials}
</Avatar>
```

### Pagination
- **Page Size:** 20 comments per page
- **Implementation:** "Load More" button (simpler than infinite scroll)
- **Loading State:** CircularProgress spinner while loading

### Styling Guidelines
[Source: docs/front-end-spec.md - Simplified]

**Modal Design:**

**Modal Header:**
- Background: Blue (#2c5aa0)
- Title: "💬 Discussion: [Concept Name]" (white text, 1.2rem, 600 weight)
- Close button (×): 44px tap target, top-right corner

**Comment Input Form:**
- Background: Light gray (#f8f9fc)
- Padding: 1rem (16px)
- Border radius: 6px
- Textarea border: 2px solid #e1e7f0
- Focus border: Blue (#2c5aa0)
- Character counter: Text secondary, bottom-right
- "Posting as: [Name] (Student)" label above textarea

**Comment Cards (All Equal):**
- Background: White
- Border: 2px solid #e1e7f0
- Border radius: 6px
- Padding: 1rem (16px)
- Margin bottom: 0.75rem
- Hover: Light shadow increase

**Own Comments (User's Posts):**
- Same as above but background: #f8f9fc (light gray)
- Helps user identify their own comments

**Comment Metadata:**
- Avatar: Blue circle (#2c5aa0), 40x40px, white initials
- Author name: Text primary (#2c3e50), 600 weight
- Timestamp: Text secondary (#6c757d), 14px ("2 hours ago")
- Layout: Horizontal - Avatar | Name + Timestamp

**Like Button:**
- Icon: ThumbUpIcon (👍)
- Default: Gray outline
- Active (liked): Blue (#2c5aa0) filled
- Min height: 36px (touch-friendly)
- Border radius: 4px
- Hover: Light blue background (#e8f0fe)
- Shows like count next to icon

**Animation:**
- Modal fade in: 300ms ease-out
- Comment card hover: 150ms ease-out
- Like button toggle: 150ms ease-out

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md` (Modal: Discussion/Community)
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** All interactive elements labeled
- **Keyboard Navigation:** Full keyboard support
- **Focus Management:** Focus trap in modal
- **Screen Reader:** Announce post count, new posts

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.3 (Concept Viewer):** Trigger button "💬 Discussion" in concept viewer action buttons
2. **Story 1.4 (User Authentication):** Uses user authentication (all users are students)
3. **Epic 3 (Community Features):** Absorbs Stories 3.1-3.2 (simplified to basic commenting)

### TypeScript Interfaces
```typescript
// Component Props
interface CommentModalProps {
  conceptId: string;
  conceptTitle: string;
  isOpen: boolean;
  onClose: () => void;
}

// Comment Data
interface Comment {
  id: string;
  user_id: string;
  user_name: string;
  content: string;
  like_count: number;
  is_liked_by_user: boolean;
  created_at: string;
}

// Modal State
interface CommentModalState {
  comments: Comment[];
  loading: boolean;
  error: string | null;
  page: number;
  hasMore: boolean;
  submitting: boolean;
}

// Helper function for user initials
function getUserInitials(userName: string): string {
  return userName
    .split(' ')
    .map(n => n[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Discussion/CommentModal.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - Modal opens and displays title with concept name
   - Comment input form is visible
   - Comment list renders with comments
   - Loading state shows CircularProgress

2. **Empty State Tests:**
   - Empty state displays encouraging message
   - "Post Comment" button or form is prominently visible
   - No comments message appears when list is empty

3. **Error State Tests:**
   - Error state displays user-friendly message
   - "Retry" button is visible and functional
   - "Post Comment" button allows posting even during error
   - Clicking retry re-fetches comments

4. **Create Comment Tests:**
   - Comment form accepts text input
   - Character counter updates as user types
   - Form validates max 2000 characters
   - Form validates non-empty content
   - Successful post clears form
   - New comment appears in list after submission

5. **Like Tests:**
   - Like button toggles like state
   - Like count updates optimistically
   - Unlike removes like
   - Like button shows blue color when liked

6. **Pagination Tests:**
   - "Load More" button appears when hasMore is true
   - Clicking "Load More" fetches next page
   - Button hides when all comments loaded

7. **Own Comments Tests:**
   - User's own comments have different background
   - Other users' comments use default styling

8. **Accessibility Tests:**
   - ARIA labels present on all interactive elements
   - Keyboard navigation works (Tab order)
   - Focus trap works in modal
   - ESC key closes modal
   - Error state uses role="alert"

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { CommentModal } from '@/components/Discussion/CommentModal';

describe('CommentModal', () => {
  const mockComments = [
    {
      id: 'comment-1',
      user_id: 'user-1',
      user_name: 'Maria Santos',
      content: 'This was really helpful! Thanks for sharing.',
      like_count: 5,
      is_liked_by_user: false,
      created_at: '2025-10-01T10:00:00Z',
    },
  ];
  
  it('displays error state with retry and post buttons', () => {
    render(
      <CommentModal 
        conceptId="concept-1" 
        conceptTitle="Test Concept" 
        isOpen={true} 
        onClose={() => {}} 
      />
    );
    
    // Simulate API error
    waitFor(() => {
      expect(screen.getByText(/Unable to load comments/i)).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /Retry/i })).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /Post Comment/i })).toBeInTheDocument();
    });
  });
  
  it('validates comment length and shows character counter', async () => {
    render(<CommentModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const textarea = screen.getByPlaceholderText(/Share your thoughts/i);
    const longText = 'a'.repeat(2001); // Exceeds 2000 char limit
    
    fireEvent.change(textarea, { target: { value: longText } });
    
    await waitFor(() => {
      expect(screen.getByText(/2001 \/ 2000/i)).toBeInTheDocument();
      expect(screen.getByRole('button', { name: /Post/i })).toBeDisabled();
    });
  });
  
  it('toggles like state on like button click', async () => {
    render(<CommentModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const likeButton = screen.getByLabelText(/like/i);
    
    fireEvent.click(likeButton);
    
    await waitFor(() => {
      expect(likeButton).toHaveStyle('color: #2c5aa0'); // Blue when liked
      expect(screen.getByText('6')).toBeInTheDocument(); // Count increased
    });
  });
  
  it('highlights own comments with different background', () => {
    const currentUserId = 'user-1';
    render(<CommentModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} currentUserId={currentUserId} />);
    
    const ownComment = screen.getByTestId('comment-user-1');
    expect(ownComment).toHaveStyle('background-color: #f8f9fc');
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5, absorbs Stories 3.1-3.2 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude 4.5 sonnet

### Debug Log References
No debug issues encountered during implementation.

### Completion Notes List
**COMPLETED** - Implementation complete with all acceptance criteria met:
- ✅ Simple commenting system implemented (no question/discussion types)
- ✅ Flat comment structure (no nested replies)
- ✅ All users treated as students (no instructor roles)
- ✅ Error state includes Retry and Post Comment buttons
- ✅ Empty state encourages first comment creation
- ✅ User's own comments highlighted with light gray background (#f8f9fc)
- ✅ All comments have equal styling (no special badges or colors)
- ✅ 2000 character limit enforced at form validation and database level
- ✅ "Load More" pagination implemented (20 comments per page)
- ✅ Like functionality with optimistic UI updates
- ✅ Full accessibility support (ARIA labels, keyboard navigation, ESC to close)
- ✅ Comprehensive unit tests covering all functionality
- ✅ Code passes linting and follows coding standards
- ✅ API routes created for all comment operations
- ✅ Database migration created with proper indexes and constraints

### File List
**Created:**
- `apps/web/src/components/Discussion/types.ts` - TypeScript type definitions (simplified)
- `apps/web/src/components/Discussion/CommentModal.tsx` - Main modal component
- `apps/web/src/components/Discussion/CommentForm.tsx` - Comment input form with validation
- `apps/web/src/components/Discussion/CommentList.tsx` - Comment list with pagination
- `apps/web/src/components/Discussion/CommentCard.tsx` - Individual comment display
- `apps/web/src/components/Discussion/ErrorState.tsx` - Error state component
- `apps/web/src/components/Discussion/index.ts` - Component exports (updated)
- `apps/web/__tests__/components/Discussion/CommentModal.test.tsx` - Comprehensive test suite
- `apps/web/src/app/api/concepts/[id]/comments/route.ts` - GET/POST comments API
- `apps/web/src/app/api/comments/[id]/like/route.ts` - Like/unlike API

**Database Migration:**
- `apps/web/migrations/006_add_comments_tables.sql` - Comments and comment_likes tables

**Modified:**
- `apps/web/src/components/Discussion/types.ts` - Replaced complex types with simplified version
- `apps/web/src/components/Discussion/index.ts` - Updated exports for new components

## QA Results
*This section will be populated by QA Agent after implementation*
