# Story 1.5.6: Discussion Modal

## Status
**Draft**

## Story
**As a** logged-in user,  
**I want** to participate in discussions about concepts with other students and instructors,  
**so that** I can learn from the community and get my questions answered.

**Note:** This story absorbs Stories 3.1 (View Comments) and 3.2 (Post a Comment).

## Acceptance Criteria
1. A "Discussion" button is present in the concept viewer header/toolbar.
2. Clicking "Discussion" opens a full-screen modal overlay.
3. The modal displays:
   - Tabs for "All", "Questions", "Discussions"
   - List of posts sorted by newest/popular
   - Button to create new post
4. Each post shows:
   - User name and role (instructor badge if applicable)
   - Post type icon (question mark / discussion bubble)
   - Post content with rich formatting
   - Like count and reply count
   - "Like" and "Reply" buttons
   - Pinned indicator for instructor posts
5. Users can:
   - View all posts with pagination/infinite scroll
   - Create new posts (select "Question" or "Discussion" type)
   - Reply to posts (threaded replies)
   - Like posts (toggle on/off)
6. Instructor posts are visually distinguished (badge, background color).
7. Posts update in real-time (or with manual refresh).
8. Modal is accessible (keyboard navigation, focus management).
9. Modal uses MUI components (Dialog, Tabs, Card, Button, TextField).

## Tasks / Subtasks

- [ ] Task 1: Create DiscussionModal Component Structure (AC: 2, 9)
  - [ ] Create `src/components/Discussion/DiscussionModal.tsx` component file
  - [ ] Set up MUI Dialog component for full-screen modal
  - [ ] Add proper TypeScript interfaces for posts and replies
  - [ ] Configure modal open/close state management
  
- [ ] Task 2: Build Tab Navigation (AC: 3)
  - [ ] Add MUI Tabs component with "All", "Questions", "Discussions" tabs
  - [ ] Implement tab switching functionality
  - [ ] Filter posts based on selected tab
  - [ ] Style tabs to match brand guidelines
  
- [ ] Task 3: Create Post List Component (AC: 3, 4)
  - [ ] Display list of posts in scrollable container
  - [ ] Implement sorting (newest / most popular)
  - [ ] Add pagination or infinite scroll
  - [ ] Handle loading and empty states
  
- [ ] Task 4: Build Post Card Component (AC: 4, 6)
  - [ ] Display user name, avatar, and role badge
  - [ ] Show post type icon (question mark / discussion bubble)
  - [ ] Render post content with formatting
  - [ ] Display like count and reply count
  - [ ] Add "Like" and "Reply" buttons
  - [ ] Show pinned indicator for instructor posts
  - [ ] Distinguish instructor posts visually (background color)
  
- [ ] Task 5: Implement Create Post Functionality (AC: 5)
  - [ ] Add "New Post" button that opens create post form
  - [ ] Create post form with type selector (Question / Discussion)
  - [ ] Add text area for post content (with rich text support optional)
  - [ ] Add "Submit" and "Cancel" buttons
  - [ ] Validate post content before submission
  
- [ ] Task 6: Implement Reply Functionality (AC: 5)
  - [ ] Add reply form below each post
  - [ ] Toggle reply form visibility on "Reply" button click
  - [ ] Display threaded replies with indentation
  - [ ] Support nested replies (1-2 levels)
  
- [ ] Task 7: Implement Like Functionality (AC: 5)
  - [ ] Add like button with toggle state (liked / not liked)
  - [ ] Update like count optimistically
  - [ ] Call like/unlike API endpoints
  - [ ] Show visual feedback on like (heart icon fills)
  
- [ ] Task 8: Integrate with API (AC: 3, 5, 7)
  - [ ] Fetch posts on modal open (GET /api/concepts/{id}/discuss)
  - [ ] Create new post (POST /api/concepts/{id}/discuss)
  - [ ] Like post (POST /api/discuss/{postId}/like)
  - [ ] Unlike post (DELETE /api/discuss/{postId}/like)
  - [ ] Reply to post (POST /api/discuss/{postId}/reply)
  - [ ] Implement manual refresh or real-time updates (optional)
  
- [ ] Task 9: Implement Accessibility Features (AC: 8)
  - [ ] Add ARIA labels for modal, tabs, and buttons
  - [ ] Ensure keyboard navigation works
  - [ ] Add focus management (focus trap in modal)
  - [ ] Support ESC key to close modal
  - [ ] Test with screen readers
  
- [ ] Task 10: Add Unit Tests
  - [ ] Test modal opens and closes correctly
  - [ ] Test tab switching filters posts correctly
  - [ ] Test post list renders with pagination
  - [ ] Test create post form submission
  - [ ] Test reply functionality
  - [ ] Test like/unlike functionality
  - [ ] Test instructor post visual distinction

## Dev Notes

### Previous Story Insights
- Story 1.5.3 (Concept Viewer) completed: Provides trigger button location [Source: Epic 1.5]
- Story 1.6 (Content Backend) completed: User authentication and roles available [Source: Epic 1.5]

### Component Location
**File Path:** `apps/web/src/components/Discussion/DiscussionModal.tsx` [Source: Epic 1.5]

**Project Structure:**
```plaintext
apps/web/src/
â”œâ”€â”€ app/                    # Next.js App Router
â”œâ”€â”€ components/             # React components
â”‚   â””â”€â”€ Discussion/        # Discussion-related components
â”‚       â”œâ”€â”€ DiscussionModal.tsx  # Main modal component
â”‚       â”œâ”€â”€ PostList.tsx         # Post list with pagination
â”‚       â”œâ”€â”€ PostCard.tsx         # Individual post display
â”‚       â”œâ”€â”€ CreatePostForm.tsx   # New post creation
â”‚       â””â”€â”€ ReplyForm.tsx        # Reply input
â””â”€â”€ lib/                    # Utility libraries
```

### Technology Stack
- **Frontend Framework:** Next.js 15.5.x with App Router
- **UI Component Library:** MUI (Material-UI) ~5.x
- **TypeScript:** ~5.x with strict mode enabled
- **State Management:** React Built-in (useState/useContext)

### MUI Components to Use
- **Dialog:** Full-screen modal container
- **Tabs/Tab:** Tab navigation
- **Card:** Post card container
- **CardHeader:** Post header with user info
- **CardContent:** Post content
- **CardActions:** Like and reply buttons
- **TextField:** Create post and reply forms
- **Button/IconButton:** Actions
- **Badge:** Instructor badge
- **Avatar:** User avatar
- **Chip:** Post type indicator
- **Divider:** Visual separators

### API Specifications
[Source: Epic 1.5]

**New API Endpoints:**

1. **Get Posts for Concept:**
```
GET /api/concepts/{id}/discuss?tab={all|questions|discussions}&page={number}
Authorization: Bearer {token}

Response:
{
  posts: [
    {
      id: string;
      user_id: string;
      user_name: string;
      user_role: 'student' | 'instructor';
      post_type: 'question' | 'discussion';
      content: string;
      like_count: number;
      reply_count: number;
      is_liked_by_user: boolean;
      is_pinned: boolean;
      created_at: timestamp;
      replies: [...]
    }
  ],
  total_count: number;
  page: number;
  page_size: number;
}
```

2. **Create Post:**
```
POST /api/concepts/{id}/discuss
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  post_type: 'question' | 'discussion';
  content: string;
}

Response:
{
  id: string;
  ...post data
}
```

3. **Like Post:**
```
POST /api/discuss/{postId}/like
Authorization: Bearer {token}

Response:
{
  success: boolean;
  like_count: number;
}
```

4. **Unlike Post:**
```
DELETE /api/discuss/{postId}/like
Authorization: Bearer {token}

Response:
{
  success: boolean;
  like_count: number;
}
```

5. **Reply to Post:**
```
POST /api/discuss/{postId}/reply
Authorization: Bearer {token}
Content-Type: application/json

Body:
{
  content: string;
}

Response:
{
  id: string;
  ...reply data
}
```

### Enhanced Comment Model
[Source: docs/architecture/data-models.md, Epic 1.5]

**Updated discuss_posts Table:**
```sql
CREATE TABLE discuss_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  concept_id UUID NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES discuss_posts(id) ON DELETE CASCADE,
  post_type VARCHAR(20) NOT NULL CHECK (post_type IN ('question', 'discussion')),
  content TEXT NOT NULL,
  is_pinned BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT now(),
  updated_at TIMESTAMP DEFAULT now()
);

CREATE TABLE post_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  post_id UUID NOT NULL REFERENCES discuss_posts(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT now(),
  UNIQUE (user_id, post_id)
);

CREATE INDEX idx_discuss_posts_concept ON discuss_posts(concept_id);
CREATE INDEX idx_discuss_posts_parent ON discuss_posts(parent_id);
CREATE INDEX idx_post_likes_post ON post_likes(post_id);
```

### Post Types and Icons
- **Question:** HelpOutlineIcon (question mark icon)
- **Discussion:** ForumIcon (discussion bubble icon)

### Instructor Post Styling
```typescript
const instructorPostStyle = {
  backgroundColor: 'rgba(25, 118, 210, 0.08)', // Light blue background
  borderLeft: '4px solid #1976d2', // Blue left border
};

<Chip 
  label="Instructor" 
  color="primary" 
  size="small" 
  sx={{ ml: 1 }} 
/>
```

### Pagination/Infinite Scroll
- **Page Size:** 20 posts per page
- **Implementation:** Infinite scroll (load more on scroll) OR "Load More" button
- **Loading State:** Skeleton components while loading

### Styling Guidelines
[Source: docs/front-end-spec.md, docs/stories/_design-system-reference.md]

**Modal Design:** [Source: front-end-spec.md, Modal: Discussion/Community]

**Modal Header:**
- Background: Blue (#2c5aa0)
- Title: "ðŸ’¬ Discussion: [Concept Name]" (white text, 1.2rem, 600 weight)
- Close button (Ã—): 44px tap target, top-right corner

**New Post Form:**
- Background: Light gray (#f8f9fc)
- Padding: 1rem (16px)
- Border radius: 6px
- Post type buttons: Pill-shaped, blue (#2c5aa0) when active
- Textarea border: 2px solid #e1e7f0
- Focus border: Blue (#2c5aa0)

**Instructor Posts:** [Source: front-end-spec.md]
- Background: rgba(0, 184, 148, 0.08) (light green tint)
- Left border: 4px solid green (#00b894)
- Badge: "Instructor" chip (green #00b894)
- Pinned badge: "Pinned" chip (yellow #ffeaa7)
- Border radius: 6px

**Student Posts:**
- Background: White
- Border: 2px solid #e1e7f0
- Border radius: 6px
- Padding: 1rem (16px)
- Hover: Light gray background (#f8f9fc)

**Post Metadata:**
- Author name: Text primary (#2c3e50), 600 weight
- Role badge: Small chip
- Timestamp: Text secondary (#6c757d), 14px

**Engagement Buttons:**
- Like button: ðŸ‘ icon, blue (#2c5aa0) when active
- Reply button: ðŸ’¬ icon
- Min height: 36px (touch-friendly)
- Border radius: 4px
- Hover: Light blue background

**Tabs:**
- Active tab: Blue underline (#2c5aa0, 3px)
- Inactive tab: Text secondary (#6c757d)
- Tab height: 48px
- Font size: 16px, 600 weight when active

**Animation:** [Source: front-end-spec.md, Animation]
- Modal fade in: 300ms ease-out
- Post card hover: 150ms ease-out
- Like button toggle: 150ms ease-out

**Design Reference Files:** [Source: front-end-spec.md]
- **Mockup:** `scratchpad/sample_chapter_demo_v23.html`
- **Specification:** `docs/front-end-spec.md` (Modal: Discussion/Community)
- **Design System:** `docs/stories/_design-system-reference.md`

### Accessibility Requirements
[Source: Epic 1.5, architecture/coding-standards.md]
- **WCAG 2.1 AA Compliance:** Required
- **ARIA Labels:** All interactive elements labeled
- **Keyboard Navigation:** Full keyboard support
- **Focus Management:** Focus trap in modal
- **Screen Reader:** Announce post count, new posts

### Integration Points
[Source: Epic 1.5]
1. **Story 1.5.3 (Concept Viewer):** Trigger button in concept viewer toolbar
2. **Story 1.6 Backend:** Uses user authentication and roles
3. **Epic 3 (Community Features):** Absorbs Stories 3.1-3.2

### TypeScript Interfaces
```typescript
// Component Props
interface DiscussionModalProps {
  conceptId: string;
  conceptTitle: string;
  isOpen: boolean;
  onClose: () => void;
}

// Post Data
type PostType = 'question' | 'discussion';
type UserRole = 'student' | 'instructor';

interface Post {
  id: string;
  user_id: string;
  user_name: string;
  user_role: UserRole;
  post_type: PostType;
  content: string;
  like_count: number;
  reply_count: number;
  is_liked_by_user: boolean;
  is_pinned: boolean;
  created_at: string;
  replies?: Reply[];
}

interface Reply {
  id: string;
  user_id: string;
  user_name: string;
  user_role: UserRole;
  content: string;
  created_at: string;
}

// Modal State
interface DiscussionState {
  posts: Post[];
  loading: boolean;
  error: string | null;
  selectedTab: 'all' | 'questions' | 'discussions';
  page: number;
  hasMore: boolean;
}
```

### Testing

**Test File Location:** `apps/web/__tests__/components/Discussion/DiscussionModal.test.tsx`

**Required Test Cases:**
1. **Rendering Tests:**
   - Modal opens and displays tabs
   - Post list renders with posts
   - Instructor posts show badge and styling
   - Post type icons display correctly

2. **Tab Tests:**
   - Clicking tabs filters posts correctly
   - "All" tab shows all posts
   - "Questions" tab shows only questions
   - "Discussions" tab shows only discussions

3. **Create Post Tests:**
   - Create post button opens form
   - Form submits new post
   - New post appears in list after submission

4. **Reply Tests:**
   - Reply button shows reply form
   - Reply form submits successfully
   - Reply appears under parent post

5. **Like Tests:**
   - Like button toggles like state
   - Like count updates optimistically
   - Unlike removes like

6. **Accessibility Tests:**
   - ARIA labels present
   - Keyboard navigation works
   - Focus trap works
   - ESC closes modal

**Testing Pattern Example:**
```typescript
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { DiscussionModal } from '@/components/Discussion/DiscussionModal';

describe('DiscussionModal', () => {
  const mockPosts = [
    {
      id: 'post-1',
      user_name: 'Dr. Smith',
      user_role: 'instructor',
      post_type: 'question',
      content: 'What are the key differences between...',
      like_count: 5,
      reply_count: 3,
      is_liked_by_user: false,
      is_pinned: true,
      created_at: '2025-10-01T10:00:00Z',
    },
  ];
  
  it('displays instructor badge for instructor posts', () => {
    render(
      <DiscussionModal 
        conceptId="concept-1" 
        conceptTitle="Test Concept" 
        isOpen={true} 
        onClose={() => {}} 
      />
    );
    
    waitFor(() => {
      expect(screen.getByText('Instructor')).toBeInTheDocument();
    });
  });
  
  it('filters posts by tab selection', async () => {
    render(<DiscussionModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const questionsTab = screen.getByRole('tab', { name: /questions/i });
    fireEvent.click(questionsTab);
    
    await waitFor(() => {
      // Verify only question posts are shown
      expect(screen.queryByText(/discussion/i)).not.toBeInTheDocument();
    });
  });
  
  it('toggles like state on like button click', async () => {
    render(<DiscussionModal conceptId="concept-1" conceptTitle="Test" isOpen={true} onClose={() => {}} />);
    
    const likeButton = screen.getByLabelText(/like/i);
    const initialCount = screen.getByText('5 likes');
    
    fireEvent.click(likeButton);
    
    await waitFor(() => {
      expect(screen.getByText('6 likes')).toBeInTheDocument();
    });
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-02 | 1.0 | Initial story creation for Epic 1.5, absorbs Stories 3.1-3.2 | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*Will be recorded by dev agent*

### Debug Log References
*Will be populated by the development agent*

### Completion Notes List
*Will be populated by the development agent*

### File List
*Will be populated by the development agent*

## QA Results
*This section will be populated by QA Agent after implementation*
